<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>base_renderer.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.11 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>base_renderer.cpp</h1><a href="base__renderer_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*        Copyright (C) 2000,2001,2002  Sony Computer Entertainment America</font>
00002           
00003           This file is subject to the terms and conditions of the GNU Lesser
00004           General Public License Version 2.1. See the file "COPYING" in the
00005           main directory of this archive for more details.                             */
00006 
00007 <font class="preprocessor">#include "ps2s/packet.h"</font>
00008 <font class="preprocessor">#include "ps2s/math.h"</font>
00009 <font class="preprocessor">#include "ps2s/cpu_matrix.h"</font>
00010 
00011 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00012 
00013 <font class="preprocessor">#include "<a class="code" href="base__renderer_8h.html">ps2gl/base_renderer.h</a>"</font>
00014 <font class="preprocessor">#include "<a class="code" href="glcontext_8h.html">ps2gl/glcontext.h</a>"</font>
00015 <font class="preprocessor">#include "<a class="code" href="metrics_8h.html">ps2gl/metrics.h</a>"</font>
00016 <font class="preprocessor">#include "<a class="code" href="immgmanager_8h.html">ps2gl/immgmanager.h</a>"</font>
00017 <font class="preprocessor">#include "<a class="code" href="lighting_8h.html">ps2gl/lighting.h</a>"</font>
00018 <font class="preprocessor">#include "<a class="code" href="material_8h.html">ps2gl/material.h</a>"</font>
00019 <font class="preprocessor">#include "<a class="code" href="matrix_8h.html">ps2gl/matrix.h</a>"</font>
00020 <font class="preprocessor">#include "<a class="code" href="texture_8h.html">ps2gl/texture.h</a>"</font>
00021 <font class="preprocessor">#include "<a class="code" href="drawcontext_8h.html">ps2gl/drawcontext.h</a>"</font>
00022 
00023 <font class="preprocessor">#include "vu1_context.h"</font>
00024 
00025 <font class="keywordtype">void</font>
<a name="l00026"></a><a class="code" href="classCBaseRenderer.html#b3">00026</a> <a class="code" href="classCBaseRenderer.html#b3">CBaseRenderer::GetUnpackAttribs</a>( <font class="keywordtype">int</font> numWords, <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> &amp;mode, Vifs::tMask &amp;mask )<font class="keyword"></font>
00027 {
00028 
00029    <font class="keywordflow">if</font> ( numWords == 3 ) {
00030       Vifs::tMask vec3Mask = { 0, 0, 0, 1,
00031                                0, 0, 0, 1,
00032                                0, 0, 0, 1,
00033                                0, 0, 0, 1 };
00034       mode = Vifs::UnpackModes::v3_32;
00035       mask = vec3Mask;
00036    }
00037    <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( numWords == 4 ) {
00038       Vifs::tMask vec4Mask = { 0, 0, 0, 0,
00039                                0, 0, 0, 0,
00040                                0, 0, 0, 0,
00041                                0, 0, 0, 0 };
00042       mode = Vifs::UnpackModes::v4_32;
00043       mask = vec4Mask;
00044    }
00045    <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( numWords == 2 ) {
00046       Vifs::tMask vec2Mask = { 0, 0, 1, 1,
00047                                0, 0, 1, 1,
00048                                0, 0, 1, 1,
00049                                0, 0, 1, 1 };
00050       mode = Vifs::UnpackModes::v2_32;
00051       mask = vec2Mask;
00052    }
00053    <font class="keywordflow">else</font> {
00054       mError(<font class="stringliteral">"shouldn't get here (you're probably calling glDrawArrays"</font>
00055          <font class="stringliteral">"without setting one of the pointers)"</font>);
00056    }
00057 }
00058 
00064 <font class="keywordtype">void</font>
<a name="l00065"></a><a class="code" href="classCBaseRenderer.html#b4">00065</a> <a class="code" href="classCBaseRenderer.html#b4">CBaseRenderer::InitXferBlock</a>( CVifSCDmaPacket &amp;packet,
00066                               <font class="keywordtype">int</font> wordsPerVertex, <font class="keywordtype">int</font> wordsPerNormal,
00067                               <font class="keywordtype">int</font> wordsPerTex, <font class="keywordtype">int</font> wordsPerColor )<font class="keyword"></font>
00068 {
00069    <a class="code" href="classCImmGeomManager.html">CImmGeomManager</a> &amp;gmanager = pGLContext-&gt;GetImmGeomManager();
00070 
00071    NormalBuf = &amp; gmanager.<a class="code" href="classCImmGeomManager.html#a12">GetNormalBuf</a>();
00072    TexCoordBuf = &amp; gmanager.<a class="code" href="classCImmGeomManager.html#a13">GetTexCoordBuf</a>();
00073 
00074    CurNormal = gmanager.<a class="code" href="classCGeomManager.html#a2">GetCurNormal</a>();
00075    <font class="keyword">const</font> <font class="keywordtype">float</font>* texCoord = gmanager.<a class="code" href="classCGeomManager.html#a4">GetCurTexCoord</a>();
00076    CurTexCoord[0] = texCoord[0];
00077    CurTexCoord[1] = texCoord[1];
00078 
00079    <font class="comment">// get unpack modes/masks</font>
00080 
00081    WordsPerVertex = wordsPerVertex;
00082    <a class="code" href="classCBaseRenderer.html#b3">GetUnpackAttribs</a>( WordsPerVertex, VertexUnpackMode, VertexUnpackMask );
00083 
00084    WordsPerNormal = (wordsPerNormal &gt; 0) ? wordsPerNormal : 3;
00085    <a class="code" href="classCBaseRenderer.html#b3">GetUnpackAttribs</a>( WordsPerNormal, NormalUnpackMode, NormalUnpackMask );
00086 
00087    WordsPerTexCoord = (wordsPerTex &gt; 0) ? wordsPerTex : 2;
00088    <a class="code" href="classCBaseRenderer.html#b3">GetUnpackAttribs</a>( WordsPerTexCoord, TexCoordUnpackMode, TexCoordUnpackMask );
00089 
00090    WordsPerColor = (wordsPerColor &gt; 0) ? wordsPerColor : 3;
00091    <a class="code" href="classCBaseRenderer.html#b3">GetUnpackAttribs</a>( WordsPerColor, ColorUnpackMode, ColorUnpackMask );
00092 
00093    <font class="comment">// set up the row register to expand vectors with fewer than 4 elements</font>
00094 
00095    packet.Cnt();
00096    {
00097      <font class="comment">// w is 256 to remind me that this is not used as the vertex w but</font>
00098      <font class="comment">// is necessary to clear any adc bits set for strips, otherwise they</font>
00099      <font class="comment">// accumulate..</font>
00100       <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">float</font> row[4] = { 0.0f, 0.0f, 1.0f, 256.0f };
00101       packet.Strow( row );
00102 
00103       packet.Pad128();
00104    }
00105    packet.CloseTag();
00106 }
00107 
00108 
00120 <font class="keywordtype">void</font>
<a name="l00121"></a><a class="code" href="classCBaseRenderer.html#b5">00121</a> <a class="code" href="classCBaseRenderer.html#b5">CBaseRenderer::XferBlock</a>( CVifSCDmaPacket &amp;packet,
00122                           <font class="keyword">const</font> <font class="keywordtype">void</font> *vertices, <font class="keyword">const</font> <font class="keywordtype">void</font> *normals,
00123                           <font class="keyword">const</font> <font class="keywordtype">void</font> *texCoords, <font class="keyword">const</font> <font class="keywordtype">void</font> *colors,
00124                           <font class="keywordtype">int</font> vu1Offset, <font class="keywordtype">int</font> firstElement, <font class="keywordtype">int</font> numToAdd )<font class="keyword"></font>
00125 {
00126    <font class="comment">//</font>
00127    <font class="comment">// vertices</font>
00128    <font class="comment">//</font>
00129 
00130    <font class="keywordflow">if</font> ( XferVertices ) {
00131       mErrorIf( vertices == NULL, <font class="stringliteral">"Tried to render an array with no vertices!"</font> );
00132       <a class="code" href="classCBaseRenderer.html#b6">XferVectors</a>( packet, (<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> *)vertices,
00133                    firstElement, numToAdd,
00134                    WordsPerVertex, VertexUnpackMask, VertexUnpackMode,
00135                    vu1Offset );
00136    }
00137 
00138    <font class="comment">//</font>
00139    <font class="comment">// normals</font>
00140    <font class="comment">//</font>
00141 
00142    <font class="keywordtype">int</font> firstNormal = firstElement;
00143    <font class="keywordflow">if</font> ( XferNormals &amp;&amp; normals == NULL ) {
00144       <font class="comment">// no normals given, so use the current normal..</font>
00145       <font class="comment">// I hate to actually write every normal into the packet,</font>
00146       <font class="comment">// but I can't use the vif to expand the data because I</font>
00147       <font class="comment">// need it to interleave the vertices, normals, etc..</font>
00148       CDmaPacket &amp;normalBuf = *NormalBuf;
00149       normals = (<font class="keywordtype">void</font>*)normalBuf.GetNextPtr();
00150       firstNormal = 0;
00151 
00152       <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; numToAdd; i++ )
00153          normalBuf += CurNormal;
00154    }
00155 
00156    <font class="keywordflow">if</font> ( XferNormals )
00157       <a class="code" href="classCBaseRenderer.html#b6">XferVectors</a>( packet, (<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>*)normals,
00158                    firstNormal, numToAdd,
00159                    WordsPerNormal, NormalUnpackMask, NormalUnpackMode,
00160                    vu1Offset + 1 );
00161 
00162    <font class="comment">//</font>
00163    <font class="comment">// tex coords</font>
00164    <font class="comment">//</font>
00165 
00166    <font class="keywordtype">int</font> firstTexCoord = firstElement;
00167    <font class="keywordflow">if</font> ( XferTexCoords &amp;&amp; texCoords == NULL ) {
00168       <font class="comment">// no tex coords given, so use the current value..</font>
00169       <font class="comment">// see note above for normals</font>
00170       CDmaPacket &amp;texCoordBuf = *TexCoordBuf;
00171       texCoords = (<font class="keywordtype">void</font>*)texCoordBuf.GetNextPtr();
00172       firstTexCoord = 0;
00173 
00174       <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; numToAdd; i++ ) {
00175          texCoordBuf += CurTexCoord[0];
00176          texCoordBuf += CurTexCoord[1];
00177       }
00178    }
00179    <font class="keywordflow">if</font> ( XferTexCoords )
00180       <a class="code" href="classCBaseRenderer.html#b6">XferVectors</a>( packet, (<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>*)texCoords,
00181                    firstTexCoord, numToAdd,
00182                    WordsPerTexCoord, TexCoordUnpackMask, TexCoordUnpackMode,
00183                    vu1Offset + 2 );
00184 
00185    <font class="comment">//</font>
00186    <font class="comment">// colors</font>
00187    <font class="comment">//</font>
00188 
00189    <font class="keywordtype">int</font> firstColor = firstElement;
00190    <font class="keywordflow">if</font> ( colors != NULL &amp;&amp; XferColors ) {
00191       <a class="code" href="classCBaseRenderer.html#b6">XferVectors</a>( packet, (<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>*)colors,
00192                    firstColor, numToAdd,
00193                    WordsPerColor, ColorUnpackMask, ColorUnpackMode,
00194                    vu1Offset + 3 );
00195    }
00196 
00197 }
00198 
<a name="l00199"></a><a class="code" href="base__renderer_8cpp.html#a0">00199</a> <font class="preprocessor">#define kContextStart 0 // for the kLightBase stuff below</font>
00200 
00201 <font class="keywordtype">void</font>
<a name="l00202"></a><a class="code" href="classCBaseRenderer.html#b7">00202</a> <a class="code" href="classCBaseRenderer.html#b7">CBaseRenderer::AddVu1RendererContext</a>( CVifSCDmaPacket &amp;packet, <a class="code" href="gl_8h.html#a687">GLenum</a> primType, <font class="keywordtype">int</font> vu1Offset )<font class="keyword"></font>
00203 {
00204    <a class="code" href="classCGLContext.html">CGLContext</a> &amp;glContext = *pGLContext;
00205 
00206    packet.Stcycl(1,1);
00207    packet.Flush();
00208    packet.Pad96();
00209    packet.OpenUnpack( Vifs::UnpackModes::v4_32, vu1Offset, Packet::kSingleBuff );
00210    {
00211       <font class="comment">// find light pointers</font>
00212       <a class="code" href="classCImmLighting.html">CImmLighting</a> &amp;lighting = glContext.<a class="code" href="classCGLContext.html#a7">GetImmLighting</a>();
00213       tLightPtrs lightPtrs[8];
00214       tLightPtrs *nextDir, *nextPt, *nextSpot;
00215       nextDir = nextPt = nextSpot = &amp;lightPtrs[0];
00216       <font class="keywordtype">int</font> numDirs, numPts, numSpots;
00217       numDirs = numPts = numSpots = 0;
00218       <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; 8; i++ ) {
00219          <a class="code" href="classCImmLight.html">CImmLight</a>&amp; light = lighting.<a class="code" href="classCImmLighting.html#a1">GetImmLight</a>(i);
00220          <font class="keywordflow">if</font> ( light.<a class="code" href="classCImmLight.html#a23">IsEnabled</a>() ) {
00221             <font class="keywordtype">int</font> lightBase = kLight0Base + vu1Offset;
00222             <font class="keywordflow">if</font> ( light.<a class="code" href="classCImmLight.html#a24">IsDirectional</a>() ) {
00223                nextDir-&gt;dir = lightBase + i * kLightStructSize;
00224                nextDir++;
00225                numDirs++;
00226             }
00227             <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( light.<a class="code" href="classCImmLight.html#a25">IsPoint</a>() ) {
00228                nextPt-&gt;point = lightBase + i * kLightStructSize;
00229                nextPt++;
00230                numPts++;
00231             }
00232             <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( light.<a class="code" href="classCImmLight.html#a26">IsSpot</a>() ) {
00233                nextSpot-&gt;spot = lightBase + i * kLightStructSize;
00234                nextSpot++;
00235                numSpots++;
00236             }
00237          }
00238       }  
00239 
00240       <font class="keywordtype">bool</font> doLighting = glContext.<a class="code" href="classCGLContext.html#a7">GetImmLighting</a>().<a class="code" href="classCImmLighting.html#a4">GetLightingEnabled</a>();
00241 
00242       <font class="comment">// transpose of object to world space xfrm (for light directions)</font>
00243       cpu_mat_44 objToWorldXfrmTrans = glContext.<a class="code" href="classCGLContext.html#a4">GetModelViewStack</a>().<a class="code" href="classCImmMatrixStack.html#a5">GetTop</a>();
00244       <font class="comment">// clear any translations.. should be doing a 3x3 transpose..</font>
00245       objToWorldXfrmTrans.set_col3( cpu_vec_xyzw(0, 0, 0, 1) );
00246       objToWorldXfrmTrans = objToWorldXfrmTrans.transpose();
00247       <font class="comment">// do we need to rescale normals?</font>
00248       cpu_mat_44 normalRescale;
00249       normalRescale.set_identity();
00250       <font class="keywordtype">float</font> normalScale = 1.0f;
00251       <a class="code" href="classCImmDrawContext.html">CImmDrawContext</a> &amp;drawContext = glContext.<a class="code" href="classCGLContext.html#a16">GetImmDrawContext</a>();
00252       <font class="keywordflow">if</font> ( drawContext.<a class="code" href="classCImmDrawContext.html#a30">GetRescaleNormals</a>() ) {
00253          cpu_vec_xyzw fake_normal( 1, 0, 0, 0 );
00254          fake_normal = objToWorldXfrmTrans * fake_normal;
00255          normalScale = 1.0f / fake_normal.length();
00256          normalRescale.set_scale( cpu_vec_xyz(normalScale, normalScale, normalScale) );
00257       }
00258       objToWorldXfrmTrans = normalRescale * objToWorldXfrmTrans;
00259 
00260       <font class="comment">// num lights</font>
00261       <font class="keywordflow">if</font> ( doLighting ) {
00262          packet += numDirs;
00263          packet += numPts;
00264          packet += numSpots;
00265       }
00266       <font class="keywordflow">else</font> {
00267          packet += (tU64)0;
00268          packet += 0;
00269       }
00270 
00271       <font class="comment">// backface culling multiplier -- this is 1.0f or -1.0f, the 6th bit</font>
00272       <font class="comment">// also turns on/off culling</font>
00273       <font class="keywordtype">float</font> bfc_mult = (float)drawContext.<a class="code" href="classCImmDrawContext.html#a19">GetCullFaceDir</a>();
00274       <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> bfc_word;
00275       <font class="keyword">asm</font>( <font class="stringliteral">" ## nop ## "</font> : <font class="stringliteral">"=r"</font> (bfc_word) : <font class="stringliteral">"0"</font> (bfc_mult) );
00276       <font class="keywordtype">bool</font> do_culling = drawContext.<a class="code" href="classCImmDrawContext.html#a17">GetDoCullFace</a>() &amp;&amp; (primType &gt; <a class="code" href="gl_8h.html#a16">GL_LINE_STRIP</a>);
00277       packet += bfc_word | (<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>)do_culling &lt;&lt; 5;
00278 
00279       <font class="comment">// light pointers</font>
00280       packet.Add( &amp;lightPtrs[0], 8 );
00281          
00282       <font class="keywordtype">float</font> maxColorValue = <a class="code" href="classCBaseRenderer.html#b10">GetMaxColorValue</a>( glContext.<a class="code" href="classCGLContext.html#a14">GetTexManager</a>().<a class="code" href="classCTexManager.html#a3">GetTexEnabled</a>() );
00283 
00284       <font class="comment">// add light info</font>
00285       <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; 8; i++ ) {
00286          <a class="code" href="classCImmLight.html">CImmLight</a>&amp; light = lighting.<a class="code" href="classCImmLighting.html#a1">GetImmLight</a>(i);
00287          packet += light.<a class="code" href="classCImmLight.html#a13">GetAmbient</a>() * maxColorValue;
00288          packet += light.<a class="code" href="classCImmLight.html#a14">GetDiffuse</a>() * maxColorValue;
00289          packet += light.<a class="code" href="classCImmLight.html#a15">GetSpecular</a>() * maxColorValue;
00290 
00291          <font class="keywordflow">if</font> ( light.<a class="code" href="classCImmLight.html#a24">IsDirectional</a>() )
00292             packet += light.<a class="code" href="classCImmLight.html#a16">GetPosition</a>();
00293          <font class="keywordflow">else</font> {
00294             packet += light.<a class="code" href="classCImmLight.html#a16">GetPosition</a>();
00295          }
00296 
00297          packet += light.<a class="code" href="classCImmLight.html#a17">GetSpotDir</a>();
00298 
00299          <font class="comment">// attenuation coeffs for positional light sources</font>
00300          <font class="comment">// because we're doing lighting calculations in object space,</font>
00301          <font class="comment">// we need to adjust the attenuation of positional light sources</font>
00302          <font class="comment">// and all lighting directions to take into account scaling</font>
00303          packet += light.<a class="code" href="classCImmLight.html#a20">GetConstantAtten</a>();
00304          packet += light.<a class="code" href="classCImmLight.html#a21">GetLinearAtten</a>() * 1.0f/normalScale;
00305          packet += light.<a class="code" href="classCImmLight.html#a22">GetQuadAtten</a>() * 1.0f/normalScale;
00306          packet += 0; <font class="comment">// padding</font>
00307 
00308       }
00309 
00310       <font class="comment">// global ambient</font>
00311       cpu_vec_4 globalAmb;
00312       <font class="keywordflow">if</font> ( doLighting )
00313          globalAmb = lighting.<a class="code" href="classCImmLighting.html#a6">GetGlobalAmbient</a>() * maxColorValue;
00314       <font class="keywordflow">else</font>
00315          globalAmb = cpu_vec_4(0, 0, 0, 0);
00316       packet.Add( (tU32*)&amp;globalAmb, 3 );
00317 
00318       <font class="comment">// stick in the offset to convert clip space depth value to GS</font>
00319       <font class="keywordtype">float</font> depthClipToGs = (float)((1 &lt;&lt; drawContext.<a class="code" href="classCImmDrawContext.html#a9">GetDepthBits</a>()) - 1)/2.0f;
00320       packet += depthClipToGs;
00321 
00322       <font class="comment">// cur material</font>
00323 
00324       <a class="code" href="classCImmMaterial.html">CImmMaterial</a>&amp; material = glContext.<a class="code" href="classCGLContext.html#a12">GetMaterialManager</a>().<a class="code" href="classCMaterialManager.html#a2">GetImmMaterial</a>();
00325 
00326       <font class="comment">// add emissive component</font>
00327       cpu_vec_4 emission;
00328       <font class="keywordflow">if</font> ( doLighting )
00329          emission = material.<a class="code" href="classCImmMaterial.html#a9">GetEmission</a>() * maxColorValue;
00330       <font class="keywordflow">else</font>
00331          emission = glContext.<a class="code" href="classCGLContext.html#a12">GetMaterialManager</a>().<a class="code" href="classCMaterialManager.html#a4">GetCurColor</a>() * maxColorValue;
00332       packet += emission;
00333 
00334       <font class="comment">// ambient</font>
00335       packet += material.<a class="code" href="classCImmMaterial.html#a6">GetAmbient</a>();
00336 
00337       <font class="comment">// diffuse</font>
00338       cpu_vec_4 matDiffuse = material.<a class="code" href="classCImmMaterial.html#a7">GetDiffuse</a>();
00339       <font class="comment">// the alpha value is set to the alpha of the diffuse in the renderers;</font>
00340       <font class="comment">// this should be the current color alpha if lighting is disabled</font>
00341       <font class="keywordflow">if</font> ( ! doLighting )
00342          matDiffuse[3] = glContext.<a class="code" href="classCGLContext.html#a12">GetMaterialManager</a>().<a class="code" href="classCMaterialManager.html#a4">GetCurColor</a>()[3];
00343       packet += matDiffuse;
00344 
00345       <font class="comment">// specular</font>
00346       packet += material.<a class="code" href="classCImmMaterial.html#a8">GetSpecular</a>();
00347 
00348       <font class="comment">// vertex xform</font>
00349       packet += drawContext.<a class="code" href="classCImmDrawContext.html#a5">GetVertexXform</a>();
00350 
00351       <font class="comment">// fixed vertToEye vector for non-local specular</font>
00352       cpu_vec_xyzw vertToEye( 0.0f, 0.0f, 1.0f, 0.0f );
00353       packet += objToWorldXfrmTrans * vertToEye;
00354 
00355       <font class="comment">// transpose of object to world space transform</font>
00356       packet += objToWorldXfrmTrans;
00357 
00358       <font class="comment">// world to object space xfrm (for light positions)</font>
00359       cpu_mat_44 worldToObjXfrm = glContext.<a class="code" href="classCGLContext.html#a4">GetModelViewStack</a>().<a class="code" href="classCImmMatrixStack.html#a6">GetInvTop</a>();
00360       packet += worldToObjXfrm;
00361 
00362       <font class="comment">// giftag - this is down at the bottom to make sure that when switching</font>
00363       <font class="comment">// primitives the last buffer will have a chance to copy the giftag before</font>
00364       <font class="comment">// it is overwritten with the new one</font>
00365       <a class="code" href="gl_8h.html#a687">GLenum</a> newPrimType = drawContext.<a class="code" href="classCImmDrawContext.html#a28">GetPolygonMode</a>();
00366       <font class="keywordflow">if</font> (newPrimType == <a class="code" href="gl_8h.html#a81">GL_FILL</a>) newPrimType = primType;
00367       newPrimType &amp;= 0xff;
00368       tGifTag giftag = <a class="code" href="classCBaseRenderer.html#b8">BuildGiftag</a>( newPrimType );
00369       packet += giftag;
00370 
00371       <font class="comment">// add info used by clipping code</font>
00372       <font class="comment">// first the dimensions of the framebuffer</font>
00373       <font class="keywordtype">float</font> xClip = (float)2048.0f/(drawContext.<a class="code" href="classCImmDrawContext.html#a7">GetFBWidth</a>() * 0.5f * 2.0f);
00374       packet += Math::Max( xClip, 1.0f );
00375       <font class="keywordtype">float</font> yClip = (float)2048.0f/(drawContext.<a class="code" href="classCImmDrawContext.html#a8">GetFBHeight</a>() * 0.5f * 2.0f);
00376       packet += Math::Max( yClip, 1.0f );
00377       <font class="keywordtype">float</font> depthClip = 2048.0f / depthClipToGs;
00378       <font class="comment">// FIXME: maybe these 2048's should be 2047.5s...</font>
00379       depthClip *= 1.003f; <font class="comment">// round up a bit for fp error (????)</font>
00380       packet += depthClip;
00381       <font class="comment">// enable/disable clipping</font>
00382       packet += (drawContext.<a class="code" href="classCImmDrawContext.html#a15">GetDoClipping</a>()) ? 1 : 0;
00383    }
00384    packet.CloseUnpack();
00385 }
00386 
00387 tGifTag
<a name="l00388"></a><a class="code" href="classCBaseRenderer.html#b8">00388</a> <a class="code" href="classCBaseRenderer.html#b8">CBaseRenderer::BuildGiftag</a>( <a class="code" href="gl_8h.html#a687">GLenum</a> primType )<font class="keyword"></font>
00389 {
00390    <a class="code" href="classCGLContext.html">CGLContext</a> &amp;glContext = *pGLContext;
00391 
00392    primType &amp;= 0x7;  <font class="comment">// convert from GL #define to gs prim number</font>
00393    <a class="code" href="classCImmDrawContext.html">CImmDrawContext</a> &amp;drawContext = glContext.<a class="code" href="classCGLContext.html#a16">GetImmDrawContext</a>();
00394    <font class="keywordtype">bool</font> smoothShading = drawContext.<a class="code" href="classCImmDrawContext.html#a13">GetDoSmoothShading</a>();
00395    <font class="keywordtype">bool</font> useTexture = glContext.<a class="code" href="classCGLContext.html#a14">GetTexManager</a>().<a class="code" href="classCTexManager.html#a3">GetTexEnabled</a>();
00396    <font class="keywordtype">bool</font> alpha = drawContext.<a class="code" href="classCImmDrawContext.html#a21">GetBlendEnabled</a>();
00397    <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> nreg = OutputQuadsPerVert;
00398 
00399    GS::tPrim prim = { PRIM: primType, IIP: smoothShading, TME: useTexture,
00400                       FGE: 0, ABE: alpha, AA1: 0, FST: 0, CTXT: 0, FIX: 0 };
00401    tGifTag giftag = { NLOOP: 0, EOP: 1, pad0: 0, id: 0, PRE: 1,
00402                         PRIM: *(tU64*)&amp;prim, FLG: 0, NREG: nreg, REGS0: 2, REGS1: 1,
00403                         REGS2: 4 };
00404    <font class="keywordflow">return</font> giftag;
00405 }
00406 
00407 <font class="keywordtype">void</font>
<a name="l00408"></a><a class="code" href="classCBaseRenderer.html#b9">00408</a> <a class="code" href="classCBaseRenderer.html#b9">CBaseRenderer::CacheRendererState</a>()<font class="keyword"></font>
00409 {
00410    XferNormals = pGLContext-&gt;GetImmLighting().GetLightingEnabled();
00411    XferTexCoords = pGLContext-&gt;GetTexManager().GetTexEnabled();
00412    XferColors = pGLContext-&gt;GetMaterialManager().GetColorMaterialEnabled();
00413 }
00414 
00415 <font class="keywordtype">void</font>
<a name="l00416"></a><a class="code" href="classCBaseRenderer.html#a0">00416</a> <a class="code" href="classCBaseRenderer.html#a0">CBaseRenderer::Load</a>()<font class="keyword"></font>
00417 {
00418    mErrorIf( *(<font class="keywordtype">unsigned</font> <font class="keywordtype">short</font>*)MicrocodePacket &gt; 1024,
00419              <font class="stringliteral">"This vu1 renderer won't fit into vu1 code memory: 0x%08x"</font>,
00420              (<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>)Capabilities );
00421    CVifSCDmaPacket &amp;packet = pGLContext-&gt;GetVif1Packet();
00422 
00423    packet.Call( MicrocodePacket );
00424    packet.Pad128();
00425    packet.CloseTag();
00426 
00427    <a class="code" href="metrics_8h.html#a12">pglAddToMetric</a>(<a class="code" href="metrics_8h.html#a13a6">kMetricsRendererUpload</a>);
00428 }
00429 
00430 <font class="keywordtype">void</font>
<a name="l00431"></a><a class="code" href="classCBaseRenderer.html#b6">00431</a> <a class="code" href="classCBaseRenderer.html#b6">CBaseRenderer::XferVectors</a>( CVifSCDmaPacket &amp;packet, <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> *dataStart,
00432                          <font class="keywordtype">int</font> startOffset, <font class="keywordtype">int</font> numVectors, <font class="keywordtype">int</font> wordsPerVec,
00433                          Vifs::tMask unpackMask, tU32 unpackMode,
00434                          <font class="keywordtype">int</font> vu1MemOffset )<font class="keyword"></font>
00435 {
00436    <font class="comment">// find number of words to prepend with a cnt</font>
00437 
00438    <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> *vecDataStart = dataStart + startOffset * wordsPerVec;
00439    <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> *vecDataEnd = vecDataStart + numVectors * wordsPerVec;
00440 
00441    mAssert( numVectors &gt; 0 );
00442    mErrorIf( (<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>)vecDataStart &amp; 4-1,
00443              <font class="stringliteral">"XferVectors only works with word-aligned data"</font> );
00444 
00445    <font class="keywordtype">int</font> numWordsToPrepend = 0;
00446    <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> *refXferStart = vecDataStart;
00447    <font class="keywordflow">while</font> ( (<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>)refXferStart &amp; (16-1) ) {
00448       numWordsToPrepend++;
00449       refXferStart++;
00450       <font class="keywordflow">if</font> ( refXferStart == vecDataEnd ) <font class="keywordflow">break</font>;
00451    }
00452    <font class="keywordtype">int</font> numWordsToAppend = 0;
00453    <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> *refXferEnd = vecDataEnd;
00454    <font class="keywordflow">while</font> ( ((<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>)refXferEnd &amp; (16-1)) &amp;&amp; refXferEnd &gt; refXferStart ) {
00455       numWordsToAppend++;
00456       refXferEnd--;
00457    }
00458    <font class="keywordtype">int</font> numQuadsInRefXfer = ((<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>)refXferEnd - (<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>)refXferStart) / 16;
00459 
00460    packet.Cnt();
00461    {
00462       <font class="comment">// set mask to expand vectors appropriately</font>
00463       packet.Stmask( unpackMask );
00464 
00465       <font class="comment">// prepend</font>
00466       <font class="keywordflow">if</font> ( numWordsToPrepend &gt; 1 ) {
00467          <font class="comment">// either 2 or 3 words to prepend</font>
00468          packet.Nop().Nop();
00469          <font class="keywordflow">if</font> ( numWordsToPrepend == 2 )
00470             packet.Nop();
00471          
00472          packet.OpenUnpack( unpackMode,
00473                             vu1MemOffset,
00474                             VifDoubleBuffered,
00475                             Packet::kMasked );
00476          packet.CloseUnpack( numVectors );
00477 
00478          <font class="keywordflow">if</font> ( numWordsToPrepend == 3 )
00479             packet += *vecDataStart;
00480       }
00481 
00482       packet.Pad128();
00483    }
00484    packet.CloseTag();
00485 
00486    <font class="comment">// xfer qword block of vectors</font>
00487    packet.Ref( Core::MakePtrNormal(refXferStart), numQuadsInRefXfer );
00488    {
00489       <font class="comment">// either 0 words to prepend or 1 word left to prepend</font>
00490       <font class="keywordflow">if</font> ( numWordsToPrepend == 0 )
00491          packet.Nop();
00492       <font class="keywordflow">if</font> ( numWordsToPrepend &lt;= 1 ) {
00493          packet.OpenUnpack( unpackMode,
00494                             vu1MemOffset,
00495                             VifDoubleBuffered,
00496                             Packet::kMasked );
00497          packet.CloseUnpack( numVectors );
00498       }
00499       <font class="keywordflow">if</font> ( numWordsToPrepend == 1 )
00500          packet += *vecDataStart;
00501       <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( numWordsToPrepend == 2 )
00502          packet.Add( vecDataStart, 2 );
00503       <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( numWordsToPrepend == 3 )
00504          packet.Add( &amp;vecDataStart[1], 2 );
00505    }
00506 
00507    <font class="comment">// xfer any remaining vectors</font>
00508    <font class="keywordflow">if</font> ( numWordsToAppend &gt; 0 ) {
00509       packet.Cnt();
00510       {
00511          packet.Add( refXferEnd, numWordsToAppend );
00512          packet.Pad128();
00513       }
00514       packet.CloseTag();
00515    }
00516 }
00517 
</pre></div><hr><address><small>ps2gl version cvs</small></address>
