<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>sjoy.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.11 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>sjoy.c</h1><a href="sjoy_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">// Copyright(C) 2001 Sony Computer Entertainment Inc. All Rights Reserved.</font>
00002 <font class="comment">//</font>
00003 <font class="comment">// "sjoy.c"</font>
00004 <font class="comment">//</font>
00005 <font class="comment">//</font>
00006 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00007 <font class="preprocessor">#include &lt;unistd.h&gt;</font>
00008 <font class="preprocessor">#include &lt;fcntl.h&gt;</font>
00009 <font class="preprocessor">#include &lt;assert.h&gt;</font>
00010 <font class="preprocessor">#include &lt;linux/types.h&gt;</font>
00011 <font class="preprocessor">#include &lt;linux/joystick.h&gt;</font>
00012 <font class="preprocessor">#include "<a class="code" href="sjoy_8h.html">sjoy.h</a>"</font>
00013 
<a name="l00014"></a><a class="code" href="sjoy_8c.html#a0">00014</a> <font class="preprocessor">#define N_JOY   2</font>
00015 
00016 <font class="keyword">static</font> <font class="keywordtype">char</font> *g_devName[<a class="code" href="sjoy_8c.html#a0">N_JOY</a>] = {
00017         <font class="stringliteral">"/dev/js0"</font>,
00018         <font class="stringliteral">"/dev/js1"</font>,
00019 };
00020 
00021 <font class="keyword">static</font> <font class="keywordtype">int</font> g_fd[<a class="code" href="sjoy_8c.html#a0">N_JOY</a>] = {
00022         -1, -1,
00023 };
00024 
00025 <font class="keyword">static</font> __u32 g_button[<a class="code" href="sjoy_8c.html#a0">N_JOY</a>];   <font class="comment">// max 32 buttons per joystick</font>
00026 <font class="keyword">static</font> __s16 g_axis[<a class="code" href="sjoy_8c.html#a0">N_JOY</a>][2];  <font class="comment">// max 2 axis per joystick</font>
00027 
00028 <font class="comment">//----------------------------------------------------------------------</font>
<a name="l00029"></a><a class="code" href="sjoy_8c.html#a14">00029</a> <font class="keywordtype">int</font> <a class="code" href="sjoy_8c.html#a5">sjoy_open</a>(<font class="keywordtype">void</font>)<font class="keyword"></font>
00030 {
00031         <font class="keywordtype">int</font> joy;
00032         
00033         <a class="code" href="sjoy_8c.html#a6">sjoy_close</a>();
00034         
00035         <font class="keywordflow">for</font> (joy = 0; joy &lt; <a class="code" href="sjoy_8c.html#a0">N_JOY</a>; joy++) {
00036                 assert(g_fd[joy] == -1);
00037                 g_fd[joy] = open(g_devName[joy], O_RDONLY | O_NONBLOCK);
00038                 <font class="keywordflow">if</font> (g_fd[joy] &lt; 0) {
00039                         fprintf(stderr, <font class="stringliteral">"can't open %s\n"</font>, g_devName[joy]);
00040                         fprintf(stderr,
00041                                         <font class="stringliteral">"You don't have permission, or should load module for joysticks.\n"</font>
00042                                         <font class="stringliteral">"How to load joystick module:\n"</font>
00043                                         <font class="stringliteral">"    # modprobe ps2pad\n"</font>);
00044                         <font class="keywordflow">return</font> -1;
00045                 }
00046         }
00047         
00048         <font class="keywordflow">return</font> 0;
00049 }
00050 
00051 <font class="comment">//----------------------------------------------------------------------</font>
<a name="l00052"></a><a class="code" href="sjoy_8c.html#a15">00052</a> <font class="keywordtype">int</font> <a class="code" href="sjoy_8c.html#a6">sjoy_close</a>(<font class="keywordtype">void</font>)<font class="keyword"></font>
00053 {
00054         <font class="keywordtype">int</font> joy;
00055         <font class="keywordtype">int</font> fail = 0;
00056         
00057         <font class="keywordflow">for</font> (joy = 0; joy &lt; <a class="code" href="sjoy_8c.html#a0">N_JOY</a>; joy++) {
00058                 <font class="keywordflow">if</font> (g_fd[joy] &gt;= 0) {
00059                         fail |= close(g_fd[joy]);
00060                 }
00061                 g_fd[joy] = -1;
00062         }
00063         
00064         <font class="keywordflow">return</font> fail ? -1 : 0;
00065 }
00066 
00067 <font class="comment">//----------------------------------------------------------------------</font>
<a name="l00068"></a><a class="code" href="sjoy_8c.html#a16">00068</a> <font class="keywordtype">void</font> <a class="code" href="sjoy_8c.html#a7">sjoy_poll</a>(<font class="keywordtype">void</font>)<font class="keyword"></font>
00069 {
00070         <font class="keywordtype">int</font> joy;
00071         
00072         <font class="keywordflow">for</font> (joy = 0; joy &lt; <a class="code" href="sjoy_8c.html#a0">N_JOY</a>; joy++) {
00073                 <font class="keywordflow">if</font> (g_fd[joy] &lt; 0) {
00074                         <font class="keywordflow">continue</font>;
00075                 }
00076                 <font class="keywordflow">for</font> (; ;) {
00077                         <font class="keyword">struct </font>js_event e;
00078                         <font class="keywordtype">int</font> n = read(g_fd[joy], &amp;e, <font class="keyword">sizeof</font>(e));
00079                         <font class="keywordflow">if</font> (n != <font class="keyword">sizeof</font>(e)) {
00080                                 <font class="keywordflow">break</font>;
00081                         }
00082                         <font class="keywordflow">switch</font> (e.type &amp; ~JS_EVENT_INIT) {
00083                         <font class="keywordflow">case</font> JS_EVENT_BUTTON:
00084                                 g_button[joy] &amp;= ~(1 &lt;&lt; e.number);
00085                                 g_button[joy] |= (e.value &lt;&lt; e.number);
00086                                 <font class="keywordflow">break</font>;
00087                                 
00088                         <font class="keywordflow">case</font> JS_EVENT_AXIS:
00089                                 g_axis[joy][e.number] = e.value;
00090                                 <font class="keywordflow">break</font>;
00091                                 
00092                         <font class="keywordflow">default</font>:
00093                                 assert(0);
00094                                 <font class="keywordflow">break</font>;
00095                         }
00096                 }
00097         }
00098 }
00099 
00100 <font class="comment">//----------------------------------------------------------------------</font>
<a name="l00101"></a><a class="code" href="sjoy_8c.html#a17">00101</a> <font class="keywordtype">int</font> <a class="code" href="sjoy_8h.html#a17">sjoy_get_button</a>(<font class="keywordtype">int</font> joy)<font class="keyword"></font>
00102 {
00103         <font class="keywordflow">return</font> g_button[joy];
00104 }
00105 
00106 <font class="comment">//----------------------------------------------------------------------</font>
<a name="l00107"></a><a class="code" href="sjoy_8c.html#a18">00107</a> <font class="keywordtype">int</font> <a class="code" href="sjoy_8h.html#a18">sjoy_get_axis</a>(<font class="keywordtype">int</font> joy, <font class="keywordtype">int</font> axis)<font class="keyword"></font>
00108 {
00109         <font class="keywordflow">return</font> g_axis[joy][axis];
00110 }
00111 
00112 <font class="comment">//----------------------------------------------------------------------</font>
<a name="l00113"></a><a class="code" href="sjoy_8c.html#a19">00113</a> <font class="keywordtype">int</font> <a class="code" href="sjoy_8h.html#a19">sjoy_get_ps2_button</a>(<font class="keywordtype">int</font> joy)<font class="keyword"></font>
00114 {
00115         <font class="keywordtype">int</font> w = g_button[joy];
00116         <font class="keywordtype">int</font> a0 = g_axis[joy][0];
00117         <font class="keywordtype">int</font> a1 = g_axis[joy][1];
00118         <font class="keywordtype">int</font> th = 0x4000;
00119         
00120         w |= (a0 &lt; -th) ? <a class="code" href="sjoy_8h.html#a10">SJOY_PS2_L_LEFT</a> : 0;
00121         w |= (a1 &gt; th) ? <a class="code" href="sjoy_8h.html#a11">SJOY_PS2_L_DOWN</a> : 0;
00122         w |= (a0 &gt; th) ? <a class="code" href="sjoy_8h.html#a13">SJOY_PS2_L_RIGHT</a> : 0;
00123         w |= (a1 &lt; -th) ? <a class="code" href="sjoy_8h.html#a12">SJOY_PS2_L_UP</a> : 0;
00124         
00125         <font class="keywordflow">return</font> w;
00126 }
</pre></div><hr><address><small>ps2gl version cvs</small></address>
