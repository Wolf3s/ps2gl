<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>immgmanager.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.11 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>immgmanager.cpp</h1><a href="immgmanager_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*        Copyright (C) 2000,2001,2002  Sony Computer Entertainment America</font>
00002           
00003           This file is subject to the terms and conditions of the GNU Lesser
00004           General Public License Version 2.1. See the file "COPYING" in the
00005           main directory of this archive for more details.                             */
00006 
00007 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00008 
00009 <font class="preprocessor">#include "ps2s/packet.h"</font>
00010 <font class="preprocessor">#include "ps2s/cpu_matrix.h"</font>
00011 <font class="preprocessor">#include "ps2s/math.h"</font>
00012 <font class="preprocessor">#include "ps2s/displayenv.h"</font>
00013 
00014 <font class="preprocessor">#include "<a class="code" href="ps2gl_8h.html">GL/ps2gl.h</a>"</font>
00015 <font class="preprocessor">#include "<a class="code" href="gmanager_8h.html">ps2gl/gmanager.h</a>"</font>
00016 <font class="preprocessor">#include "<a class="code" href="glcontext_8h.html">ps2gl/glcontext.h</a>"</font>
00017 <font class="preprocessor">#include "<a class="code" href="dlist_8h.html">ps2gl/dlist.h</a>"</font>
00018 <font class="preprocessor">#include "<a class="code" href="clear_8h.html">ps2gl/clear.h</a>"</font>
00019 <font class="preprocessor">#include "<a class="code" href="matrix_8h.html">ps2gl/matrix.h</a>"</font>
00020 <font class="preprocessor">#include "<a class="code" href="texture_8h.html">ps2gl/texture.h</a>"</font>
00021 <font class="preprocessor">#include "<a class="code" href="material_8h.html">ps2gl/material.h</a>"</font>
00022 <font class="preprocessor">#include "<a class="code" href="drawcontext_8h.html">ps2gl/drawcontext.h</a>"</font>
00023 <font class="preprocessor">#include "<a class="code" href="renderer_8h.html">ps2gl/renderer.h</a>"</font>
00024 
00025 <font class="keyword">using</font> <font class="keyword">namespace </font>ArrayType;
00026 
00027 <font class="comment">/********************************************</font>
00028  * CImmGeomManager
00029  */
00030 
<a name="l00031"></a><a class="code" href="classCImmGeomManager.html#a0">00031</a> <a class="code" href="classCImmGeomManager.html#a0">CImmGeomManager::CImmGeomManager</a>( <a class="code" href="classCGLContext.html">CGLContext</a> &amp;context, <font class="keywordtype">int</font> immBufferQwordSize )
00032    : <a class="code" href="classCGeomManager.html">CGeomManager</a>(context),
00033      RendererManager(context),
00034      VertexBuf0( immBufferQwordSize + immBufferQwordSize % 4,
00035                  DMAC::Channels::vif1, Core::MemMappings::UncachedAccl ),
00036      NormalBuf0( immBufferQwordSize * 4 / 3 + 1 + (immBufferQwordSize * 4 / 3 + 1) % 4,
00037                  DMAC::Channels::vif1, Core::MemMappings::UncachedAccl ),
00038      TexCoordBuf0( immBufferQwordSize / 2 + (immBufferQwordSize / 2) % 4,
00039                    DMAC::Channels::vif1, Core::MemMappings::UncachedAccl ),
00040      ColorBuf0( immBufferQwordSize + immBufferQwordSize % 4,
00041                 DMAC::Channels::vif1, Core::MemMappings::UncachedAccl ),
00042      VertexBuf1( immBufferQwordSize + immBufferQwordSize % 4,
00043                  DMAC::Channels::vif1, Core::MemMappings::UncachedAccl ),
00044      NormalBuf1( immBufferQwordSize * 4 / 3 + 1 + (immBufferQwordSize * 4 / 3 + 1) % 4,
00045                  DMAC::Channels::vif1, Core::MemMappings::UncachedAccl ),
00046      TexCoordBuf1( immBufferQwordSize / 2 + (immBufferQwordSize / 2) % 4,
00047                    DMAC::Channels::vif1, Core::MemMappings::UncachedAccl ),
00048      ColorBuf1( immBufferQwordSize + immBufferQwordSize % 4,
00049                 DMAC::Channels::vif1, Core::MemMappings::UncachedAccl )
00050 {
00051    CurVertexBuf = &amp;VertexBuf0;
00052    CurNormalBuf = &amp;NormalBuf0;
00053    CurTexCoordBuf = &amp;TexCoordBuf0;
00054    CurColorBuf = &amp;ColorBuf0;
00055 
00056    VertArray = <font class="keyword">new</font> <a class="code" href="classCVertArray.html">CVertArray</a>;
00057 
00058    RendererManager.<a class="code" href="classCRendererManager.html#a18">ArrayAccessChanged</a>( RendererProps::kLinear );
00059 }
00060 
<a name="l00061"></a><a class="code" href="classCImmGeomManager.html#a1">00061</a> <a class="code" href="classCImmGeomManager.html#a1">CImmGeomManager::~CImmGeomManager</a>()<font class="keyword"></font>
00062 {
00063    <font class="keyword">delete</font> VertArray;
00064 }
00065 
00066 <font class="keywordtype">void</font>
<a name="l00067"></a><a class="code" href="classCImmGeomManager.html#a3">00067</a> <a class="code" href="classCImmGeomManager.html#a3">CImmGeomManager::SwapBuffers</a>()<font class="keyword"></font>
00068 {
00069    <font class="comment">// flip the geometry buffers</font>
00070    <font class="keywordflow">if</font> ( CurVertexBuf == &amp;VertexBuf0 ) CurVertexBuf = &amp;VertexBuf1;
00071    <font class="keywordflow">else</font> CurVertexBuf = &amp;VertexBuf0;
00072    CurVertexBuf-&gt;Reset();
00073    <font class="keywordflow">if</font> ( CurNormalBuf == &amp;NormalBuf0 ) CurNormalBuf = &amp;NormalBuf1;
00074    <font class="keywordflow">else</font> CurNormalBuf = &amp;NormalBuf0;
00075    CurNormalBuf-&gt;Reset();
00076    <font class="keywordflow">if</font> ( CurTexCoordBuf == &amp;TexCoordBuf0 ) CurTexCoordBuf = &amp;TexCoordBuf1;
00077    <font class="keywordflow">else</font> CurTexCoordBuf = &amp;TexCoordBuf0;
00078    CurTexCoordBuf-&gt;Reset();
00079    <font class="keywordflow">if</font> ( CurColorBuf == &amp;ColorBuf0 ) CurColorBuf = &amp;ColorBuf1;
00080    <font class="keywordflow">else</font> CurColorBuf = &amp;ColorBuf0;
00081    CurColorBuf-&gt;Reset();
00082 }
00083 
00084 <font class="comment">/********************************************</font>
00085  * glBegin/glEnd and related
00086  */
00087 
00088 <font class="keywordtype">void</font>
<a name="l00089"></a><a class="code" href="classCImmGeomManager.html#a16">00089</a> <a class="code" href="classCImmGeomManager.html#a16">CImmGeomManager::BeginGeom</a>( <a class="code" href="gl_8h.html#a687">GLenum</a> mode )<font class="keyword"></font>
00090 {
00091    <font class="keywordflow">if</font> ( Prim != mode )
00092       <a class="code" href="classCImmGeomManager.html#a4">PrimChanged</a>(mode);
00093 
00094    Geometry.<a class="code" href="classCGeometryBlock.html#a34">SetPrimType</a>( mode );
00095    Geometry.<a class="code" href="classCGeometryBlock.html#a17">SetArrayType</a>(kLinear);
00096 
00097    Geometry.<a class="code" href="classCGeometryBlock.html#a30">SetNormals</a>( CurNormalBuf-&gt;GetNextPtr() );
00098    Geometry.<a class="code" href="classCGeometryBlock.html#a29">SetVertices</a>( CurVertexBuf-&gt;GetNextPtr() );
00099    Geometry.<a class="code" href="classCGeometryBlock.html#a31">SetTexCoords</a>( CurTexCoordBuf-&gt;GetNextPtr() );
00100    Geometry.<a class="code" href="classCGeometryBlock.html#a32">SetColors</a>( CurColorBuf-&gt;GetNextPtr() );
00101 
00102    InsideBeginEnd = <font class="keyword">true</font>;
00103 }
00104 
00105 <font class="keywordtype">void</font>
<a name="l00106"></a><a class="code" href="classCImmGeomManager.html#a17">00106</a> <a class="code" href="classCImmGeomManager.html#a17">CImmGeomManager::Vertex</a>( cpu_vec_xyzw newVert )<font class="keyword"></font>
00107 {
00108    cpu_vec_xyz normal = <a class="code" href="classCGeomManager.html#a2">GetCurNormal</a>();
00109    *CurNormalBuf += normal;
00110 
00111    <font class="keyword">const</font> <font class="keywordtype">float</font> *texCoord = <a class="code" href="classCGeomManager.html#a4">GetCurTexCoord</a>();
00112    *CurTexCoordBuf += texCoord[0];
00113    *CurTexCoordBuf += texCoord[1];
00114 
00115    *CurVertexBuf += newVert;
00116 
00117    Geometry.<a class="code" href="classCGeometryBlock.html#a40">AddVertices</a>();
00118    Geometry.<a class="code" href="classCGeometryBlock.html#a41">AddNormals</a>();
00119    Geometry.<a class="code" href="classCGeometryBlock.html#a42">AddTexCoords</a>();
00120 }
00121 
00122 <font class="keywordtype">void</font>
<a name="l00123"></a><a class="code" href="classCImmGeomManager.html#a18">00123</a> <a class="code" href="classCImmGeomManager.html#a18">CImmGeomManager::Normal</a>( cpu_vec_xyz normal )<font class="keyword"></font>
00124 {
00125    <font class="keywordflow">if</font> ( DoNormalize ) normal.normalize();
00126    CurNormal = normal;
00127 }
00128 
00129 <font class="keywordtype">void</font>
<a name="l00130"></a><a class="code" href="classCImmGeomManager.html#a20">00130</a> <a class="code" href="classCImmGeomManager.html#a20">CImmGeomManager::Color</a>( cpu_vec_xyzw color )<font class="keyword"></font>
00131 {
00132    <font class="keywordflow">if</font> ( InsideBeginEnd ) {
00133       *CurColorBuf += color;
00134       Geometry.<a class="code" href="classCGeometryBlock.html#a43">AddColors</a>();
00135    }
00136    <font class="keywordflow">else</font> {
00137       GLContext.GetMaterialManager().Color( color );
00138    }
00139 }
00140 
00141 <font class="keywordtype">void</font>
<a name="l00142"></a><a class="code" href="classCImmGeomManager.html#a19">00142</a> <a class="code" href="classCImmGeomManager.html#a19">CImmGeomManager::TexCoord</a>( <font class="keywordtype">float</font> u, <font class="keywordtype">float</font> v )<font class="keyword"></font>
00143 {
00144    CurTexCoord[0] = u; CurTexCoord[1] = v;
00145 }
00146 
00147 <font class="keywordtype">void</font>
<a name="l00148"></a><a class="code" href="classCImmGeomManager.html#a21">00148</a> <a class="code" href="classCImmGeomManager.html#a21">CImmGeomManager::EndGeom</a>()<font class="keyword"></font>
00149 {
00150    InsideBeginEnd = <font class="keyword">false</font>;
00151 
00152    Geometry.<a class="code" href="classCGeometryBlock.html#a1">SetVerticesAreValid</a>(<font class="keyword">true</font>);
00153    Geometry.<a class="code" href="classCGeometryBlock.html#a2">SetNormalsAreValid</a>(<font class="keyword">true</font>);
00154    Geometry.<a class="code" href="classCGeometryBlock.html#a3">SetTexCoordsAreValid</a>(<font class="keyword">true</font>);
00155 
00156    <font class="comment">// check colors</font>
00157    Geometry.<a class="code" href="classCGeometryBlock.html#a4">SetColorsAreValid</a>(<font class="keyword">false</font>);
00158    <font class="keywordflow">if</font> ( Geometry.<a class="code" href="classCGeometryBlock.html#a38">GetNumNewColors</a>() &gt; 0 ) {
00159       mErrorIf( Geometry.<a class="code" href="classCGeometryBlock.html#a35">GetNumNewVertices</a>() != Geometry.<a class="code" href="classCGeometryBlock.html#a38">GetNumNewColors</a>(),
00160                 <font class="stringliteral">"Sorry, but inside glBegin/glEnd you need "</font>
00161                 <font class="stringliteral">"to specify either one color for each vertex given, or none."</font> );
00162       Geometry.<a class="code" href="classCGeometryBlock.html#a4">SetColorsAreValid</a>(<font class="keyword">true</font>);
00163 
00164       <a class="code" href="classCImmGeomManager.html#a8">SyncColorMaterial</a>(<font class="keyword">true</font>);
00165    }
00166    <font class="keywordflow">else</font> {
00167       <a class="code" href="classCImmGeomManager.html#a8">SyncColorMaterial</a>(<font class="keyword">false</font>);
00168    }
00169 
00170    Geometry.<a class="code" href="classCGeometryBlock.html#a13">SetWordsPerVertex</a>(4);
00171    Geometry.<a class="code" href="classCGeometryBlock.html#a14">SetWordsPerNormal</a>(3);
00172    Geometry.<a class="code" href="classCGeometryBlock.html#a15">SetWordsPerTexCoord</a>(2);
00173    Geometry.<a class="code" href="classCGeometryBlock.html#a16">SetWordsPerColor</a>(4);
00174 
00175    CommitNewGeom();
00176 }
00177 
00178 <font class="comment">/********************************************</font>
00179  * DrawArrays
00180  */
00181 
00182 <font class="keywordtype">void</font>
<a name="l00183"></a><a class="code" href="classCImmGeomManager.html#a22">00183</a> <a class="code" href="classCImmGeomManager.html#a22">CImmGeomManager::DrawArrays</a>( <a class="code" href="gl_8h.html#a687">GLenum</a> mode, <font class="keywordtype">int</font> first, <font class="keywordtype">int</font> count )<font class="keyword"></font>
00184 {
00185    <font class="keywordflow">if</font> ( Prim != mode )
00186       <a class="code" href="classCImmGeomManager.html#a4">PrimChanged</a>(mode);
00187 
00188    Geometry.<a class="code" href="classCGeometryBlock.html#a34">SetPrimType</a>(mode);
00189    Geometry.<a class="code" href="classCGeometryBlock.html#a17">SetArrayType</a>(kLinear);
00190 
00191    Geometry.<a class="code" href="classCGeometryBlock.html#a29">SetVertices</a>( VertArray-&gt;GetVertices() );
00192    Geometry.<a class="code" href="classCGeometryBlock.html#a30">SetNormals</a>( VertArray-&gt;GetNormals() );
00193    Geometry.<a class="code" href="classCGeometryBlock.html#a31">SetTexCoords</a>( VertArray-&gt;GetTexCoords() );
00194    Geometry.<a class="code" href="classCGeometryBlock.html#a32">SetColors</a>( VertArray-&gt;GetColors() );
00195 
00196    Geometry.<a class="code" href="classCGeometryBlock.html#a1">SetVerticesAreValid</a>( VertArray-&gt;GetVerticesAreValid() );
00197    Geometry.<a class="code" href="classCGeometryBlock.html#a2">SetNormalsAreValid</a>( VertArray-&gt;GetNormalsAreValid() );
00198    Geometry.<a class="code" href="classCGeometryBlock.html#a3">SetTexCoordsAreValid</a>( VertArray-&gt;GetTexCoordsAreValid() );
00199    Geometry.<a class="code" href="classCGeometryBlock.html#a4">SetColorsAreValid</a>( VertArray-&gt;GetColorsAreValid() );
00200 
00201    Geometry.<a class="code" href="classCGeometryBlock.html#a13">SetWordsPerVertex</a>( VertArray-&gt;GetWordsPerVertex() );
00202    Geometry.<a class="code" href="classCGeometryBlock.html#a14">SetWordsPerNormal</a>( VertArray-&gt;GetWordsPerNormal() );
00203    Geometry.<a class="code" href="classCGeometryBlock.html#a15">SetWordsPerTexCoord</a>( VertArray-&gt;GetWordsPerTexCoord() );
00204    Geometry.<a class="code" href="classCGeometryBlock.html#a16">SetWordsPerColor</a>( VertArray-&gt;GetWordsPerColor() );
00205 
00206    Geometry.<a class="code" href="classCGeometryBlock.html#a40">AddVertices</a>(count);
00207    Geometry.<a class="code" href="classCGeometryBlock.html#a41">AddNormals</a>(count);
00208    Geometry.<a class="code" href="classCGeometryBlock.html#a42">AddTexCoords</a>(count);
00209    Geometry.<a class="code" href="classCGeometryBlock.html#a43">AddColors</a>(count);
00210 
00211    Geometry.<a class="code" href="classCGeometryBlock.html#a62">AdjustNewGeomPtrs</a>( first );
00212 
00213    <font class="comment">// do this before sync'ing the vu1 renderer in CommitNewGeom</font>
00214    <a class="code" href="classCImmGeomManager.html#a8">SyncColorMaterial</a>(VertArray-&gt;GetColors() != NULL);
00215 
00216    CommitNewGeom();
00217 }
00218 
00219 <font class="keywordtype">void</font>
<a name="l00220"></a><a class="code" href="classCImmGeomManager.html#a10">00220</a> <a class="code" href="classCImmGeomManager.html#a10">CImmGeomManager::DrawingIndexedArray</a>()<font class="keyword"></font>
00221 {
00222    <font class="keywordflow">if</font> ( ! LastArrayAccessIsValid || ! LastArrayAccessWasIndexed ) {
00223       GLContext.ArrayAccessChanged();
00224       RendererManager.<a class="code" href="classCRendererManager.html#a18">ArrayAccessChanged</a>( RendererProps::kIndexed );
00225       LastArrayAccessIsValid = <font class="keyword">true</font>;
00226    }
00227    LastArrayAccessWasIndexed = <font class="keyword">true</font>;
00228 }
00229 
00230 <font class="keywordtype">void</font>
<a name="l00231"></a><a class="code" href="classCImmGeomManager.html#a23">00231</a> <a class="code" href="classCImmGeomManager.html#a23">CImmGeomManager::DrawIndexedArrays</a>( <a class="code" href="gl_8h.html#a687">GLenum</a> primType,
00232                                     <font class="keywordtype">int</font> numIndices, <font class="keyword">const</font> <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font>* indices,
00233                                     <font class="keywordtype">int</font> numVertices )<font class="keyword"></font>
00234 {
00235    <font class="comment">/*</font>
00236    // make sure there's no pending geometry
00237    Flush();
00238 
00239    // do these before sync'ing the vu1 renderer
00240    SyncColorMaterial(VertArray-&gt;GetColors() != NULL);
00241    DrawingIndexedArray();
00242 
00243    // now update the renderer and render
00244 
00245    bool rendererChanged = RendererManager.UpdateRenderer();
00246 
00247    if ( rendererChanged ) {
00248       RendererManager.LoadRenderer(GLContext.GetVif1Packet());
00249    }
00250    SyncRendererContext(primType);
00251    SyncGsContext();
00252 
00253    RendererManager.GetCurRenderer().DrawIndexedArrays( primType, numIndices, indices,
00254                                                   numVertices, *VertArray );
00255    */
00256    <font class="keywordflow">if</font> ( Prim != primType )
00257       <a class="code" href="classCImmGeomManager.html#a4">PrimChanged</a>(primType);
00258 
00259    Geometry.<a class="code" href="classCGeometryBlock.html#a34">SetPrimType</a>(primType);
00260    Geometry.<a class="code" href="classCGeometryBlock.html#a17">SetArrayType</a>(kIndexed);
00261 
00262    Geometry.<a class="code" href="classCGeometryBlock.html#a29">SetVertices</a>( VertArray-&gt;GetVertices() );
00263    Geometry.<a class="code" href="classCGeometryBlock.html#a30">SetNormals</a>( VertArray-&gt;GetNormals() );
00264    Geometry.<a class="code" href="classCGeometryBlock.html#a31">SetTexCoords</a>( VertArray-&gt;GetTexCoords() );
00265    Geometry.<a class="code" href="classCGeometryBlock.html#a32">SetColors</a>( VertArray-&gt;GetColors() );
00266 
00267    Geometry.<a class="code" href="classCGeometryBlock.html#a1">SetVerticesAreValid</a>( VertArray-&gt;GetVerticesAreValid() );
00268    Geometry.<a class="code" href="classCGeometryBlock.html#a2">SetNormalsAreValid</a>( VertArray-&gt;GetNormalsAreValid() );
00269    Geometry.<a class="code" href="classCGeometryBlock.html#a3">SetTexCoordsAreValid</a>( VertArray-&gt;GetTexCoordsAreValid() );
00270    Geometry.<a class="code" href="classCGeometryBlock.html#a4">SetColorsAreValid</a>( VertArray-&gt;GetColorsAreValid() );
00271 
00272    Geometry.<a class="code" href="classCGeometryBlock.html#a13">SetWordsPerVertex</a>( VertArray-&gt;GetWordsPerVertex() );
00273    Geometry.<a class="code" href="classCGeometryBlock.html#a14">SetWordsPerNormal</a>( VertArray-&gt;GetWordsPerNormal() );
00274    Geometry.<a class="code" href="classCGeometryBlock.html#a15">SetWordsPerTexCoord</a>( VertArray-&gt;GetWordsPerTexCoord() );
00275    Geometry.<a class="code" href="classCGeometryBlock.html#a16">SetWordsPerColor</a>( VertArray-&gt;GetWordsPerColor() );
00276 
00277    Geometry.<a class="code" href="classCGeometryBlock.html#a40">AddVertices</a>(numVertices);
00278    Geometry.<a class="code" href="classCGeometryBlock.html#a41">AddNormals</a>(numVertices);
00279    Geometry.<a class="code" href="classCGeometryBlock.html#a42">AddTexCoords</a>(numVertices);
00280    Geometry.<a class="code" href="classCGeometryBlock.html#a43">AddColors</a>(numVertices);
00281 
00282    Geometry.<a class="code" href="classCGeometryBlock.html#a20">SetNumIndices</a>(numIndices);
00283    Geometry.<a class="code" href="classCGeometryBlock.html#a21">SetIndices</a>(indices);
00284    Geometry.<a class="code" href="classCGeometryBlock.html#a22">SetIStripLengths</a>(NULL);
00285 
00286    <font class="comment">// do this before sync'ing the vu1 renderer in CommitNewGeom</font>
00287    <a class="code" href="classCImmGeomManager.html#a8">SyncColorMaterial</a>(VertArray-&gt;GetColors() != NULL);
00288 
00289    CommitNewGeom();
00290 }
00291 
00292 <font class="comment">/********************************************</font>
00293  * common and synchronization code
00294  */
00295 
00296 <font class="keywordtype">void</font>
<a name="l00297"></a><a class="code" href="classCImmGeomManager.html#a9">00297</a> <a class="code" href="classCImmGeomManager.html#a9">CImmGeomManager::DrawingLinearArray</a>()<font class="keyword"></font>
00298 {
00299    <font class="keywordflow">if</font> ( ! LastArrayAccessIsValid || LastArrayAccessWasIndexed ) {
00300       GLContext.ArrayAccessChanged();
00301       RendererManager.<a class="code" href="classCRendererManager.html#a18">ArrayAccessChanged</a>( RendererProps::kLinear );
00302       LastArrayAccessIsValid = <font class="keyword">true</font>;
00303    }
00304    LastArrayAccessWasIndexed = <font class="keyword">false</font>;
00305 }
00306 
00307 <font class="keywordtype">void</font>
00308 CImmGeomManager::CommitNewGeom()<font class="keyword"></font>
00309 {
00310    <font class="comment">// do this before updating the renderer</font>
00311    <font class="keywordflow">if</font> ( Geometry.<a class="code" href="classCGeometryBlock.html#a18">GetNewArrayType</a>() == kLinear )
00312       <a class="code" href="classCImmGeomManager.html#a9">DrawingLinearArray</a>();
00313    <font class="keywordflow">else</font>
00314       <a class="code" href="classCImmGeomManager.html#a10">DrawingIndexedArray</a>();
00315 
00316    <font class="keywordtype">bool</font> doReset = <font class="keyword">true</font>;
00317    <font class="keywordtype">bool</font> rendererChanged = RendererManager.<a class="code" href="classCRendererManager.html#a2">UpdateNewRenderer</a>();
00318 
00319    <font class="keywordflow">if</font> ( Geometry.<a class="code" href="classCGeometryBlock.html#a59">IsPending</a>() ) {
00320 
00321 <font class="comment">// FIXME: need to ask the renderer what context changes it cares about/updates</font>
00322 
00323       <font class="comment">// if the context hasn't changed, try to merge the new geometry</font>
00324       <font class="comment">// into the current block</font>
00325       <font class="keywordflow">if</font> ( GLContext.GetRendererContextChanged() == 0
00326            &amp;&amp; GLContext.GetGsContextChanged() == 0
00327            &amp;&amp; ! UserRenderContextChanged
00328            &amp;&amp; ! rendererChanged
00329            &amp;&amp; Geometry.<a class="code" href="classCGeometryBlock.html#a60">MergeNew</a>() ) {
00330          doReset = <font class="keyword">false</font>;
00331       }
00332       <font class="keywordflow">else</font> {
00333          <font class="comment">// couldn't merge; draw the old geometry so we can reset and start a new block</font>
00334          <font class="keywordflow">if</font> ( Geometry.<a class="code" href="classCGeometryBlock.html#a19">GetArrayType</a>() == kLinear )
00335             RendererManager.<a class="code" href="classCRendererManager.html#a5">GetCurRenderer</a>().<a class="code" href="classCRenderer.html#a4">DrawLinearArrays</a>( Geometry );
00336          <font class="keywordflow">else</font>
00337             RendererManager.<a class="code" href="classCRendererManager.html#a5">GetCurRenderer</a>().<a class="code" href="classCRenderer.html#a5">DrawIndexedArrays</a>( Geometry );
00338       }
00339    }
00340 
00341    <font class="keywordflow">if</font> ( doReset ) {
00342       Geometry.<a class="code" href="classCGeometryBlock.html#a61">MakeNewValuesCurrent</a>();
00343       Geometry.<a class="code" href="classCGeometryBlock.html#a57">ResetNew</a>();
00344 
00345       <font class="keywordflow">if</font> ( rendererChanged ) {
00346          RendererManager.<a class="code" href="classCRendererManager.html#a3">MakeNewRendererCurrent</a>();
00347          RendererManager.<a class="code" href="classCRendererManager.html#a4">LoadRenderer</a>(GLContext.GetVif1Packet());
00348       }
00349       <a class="code" href="classCImmGeomManager.html#a5">SyncRendererContext</a>(Geometry.<a class="code" href="classCGeometryBlock.html#a33">GetPrimType</a>());
00350       <a class="code" href="classCImmGeomManager.html#a7">SyncGsContext</a>();
00351    }
00352 }
00353 
00354 <font class="keywordtype">void</font>
<a name="l00355"></a><a class="code" href="classCImmGeomManager.html#a4">00355</a> <a class="code" href="classCImmGeomManager.html#a4">CImmGeomManager::PrimChanged</a>( <a class="code" href="gl_8h.html#a687">GLenum</a> primType )<font class="keyword"></font>
00356 {
00357    GLContext.PrimChanged();
00358    RendererManager.<a class="code" href="classCRendererManager.html#a11">PrimChanged</a>(primType);
00359 }
00360 
00361 <font class="keywordtype">void</font>
<a name="l00362"></a><a class="code" href="classCImmGeomManager.html#a6">00362</a> <a class="code" href="classCImmGeomManager.html#a6">CImmGeomManager::SyncRenderer</a>()<font class="keyword"></font>
00363 {
00364    <font class="keywordflow">if</font> ( RendererManager.<a class="code" href="classCRendererManager.html#a2">UpdateNewRenderer</a>() ) {
00365       RendererManager.<a class="code" href="classCRendererManager.html#a3">MakeNewRendererCurrent</a>();
00366       RendererManager.<a class="code" href="classCRendererManager.html#a4">LoadRenderer</a>( GLContext.GetVif1Packet() );
00367    }
00368 }
00369 
00370 <font class="keywordtype">void</font>
<a name="l00371"></a><a class="code" href="classCImmGeomManager.html#a5">00371</a> <a class="code" href="classCImmGeomManager.html#a5">CImmGeomManager::SyncRendererContext</a>( <a class="code" href="gl_8h.html#a687">GLenum</a> primType )<font class="keyword"></font>
00372 {
00373    <font class="comment">// resend the rendering context if necessary</font>
00374    <font class="keywordflow">if</font> ( GLContext.GetRendererContextChanged()
00375         || (RendererManager.<a class="code" href="classCRendererManager.html#a7">IsCurRendererCustom</a>() &amp;&amp; UserRenderContextChanged) ) {
00376       RendererManager.<a class="code" href="classCRendererManager.html#a5">GetCurRenderer</a>().<a class="code" href="classCRenderer.html#a2">InitContext</a>( primType,
00377                                                     GLContext.GetRendererContextChanged(),
00378                                                     UserRenderContextChanged );
00379 
00380       GLContext.SetRendererContextChanged(<font class="keyword">false</font>);
00381       UserRenderContextChanged = <font class="keyword">false</font>;
00382       Prim = primType;
00383    }
00384 }
00385 
00386 <font class="keywordtype">void</font>
<a name="l00387"></a><a class="code" href="classCImmGeomManager.html#a7">00387</a> <a class="code" href="classCImmGeomManager.html#a7">CImmGeomManager::SyncGsContext</a>()<font class="keyword"></font>
00388 {
00389    <font class="keywordflow">if</font> ( tU32 changed = GLContext.GetGsContextChanged() ) {
00390       <font class="comment">// has the texture changed?</font>
00391       <font class="keywordtype">bool</font> texEnabled = GLContext.GetTexManager().GetTexEnabled();
00392       CVifSCDmaPacket &amp;packet = GLContext.GetVif1Packet();
00393       <font class="keywordflow">if</font> ( texEnabled
00394            &amp;&amp; changed &amp; GsCtxtFlags::Texture ) {
00395          <font class="comment">// we have to wait for all previous buffers to finish, or</font>
00396          <font class="comment">// the new texture settings might beat the geometry to the gs..</font>
00397          packet.Cnt();
00398          packet.Flush().Nop();
00399          packet.CloseTag();
00400          GLContext.GetTexManager().UseCurTexture( GLContext.GetVif1Packet() );
00401       }
00402 
00403       <font class="comment">// has the draw environment changed?</font>
00404       <font class="keywordflow">if</font> ( changed &amp; GsCtxtFlags::DrawEnv ) {
00405          <font class="comment">// as with textures..</font>
00406          packet.Cnt();
00407          packet.Flush().Nop();
00408          packet.CloseTag();
00409          <font class="comment">// FIXME</font>
00410          GLContext.AddingDrawEnvToPacket( (tU128*)GLContext.GetVif1Packet().GetNextPtr() + 1 );
00411          GLContext.GetImmDrawContext().GetDrawEnv().SendSettings( GLContext.GetVif1Packet() );
00412       }
00413 
00414       GLContext.SetGsContextChanged(<font class="keyword">false</font>);
00415    }
00416 }
00417 
00418 <font class="keywordtype">void</font>
<a name="l00419"></a><a class="code" href="classCImmGeomManager.html#a8">00419</a> <a class="code" href="classCImmGeomManager.html#a8">CImmGeomManager::SyncColorMaterial</a>( <font class="keywordtype">bool</font> pvColorsArePresent )<font class="keyword"></font>
00420 {
00421    <a class="code" href="classCMaterialManager.html">CMaterialManager</a> &amp;mm = GLContext.GetMaterialManager();
00422    <font class="keywordflow">if</font> ( pvColorsArePresent &amp;&amp; mm.<a class="code" href="classCMaterialManager.html#a6">GetColorMaterialEnabled</a>() ) {
00423       <font class="keywordflow">switch</font> ( mm.<a class="code" href="classCMaterialManager.html#a5">GetColorMaterialMode</a>() ) {
00424          <font class="keywordflow">case</font> <a class="code" href="gl_8h.html#a136">GL_EMISSION</a>:
00425             <a class="code" href="debug_8h.html#a1">mNotImplemented</a>( <font class="stringliteral">"Only GL_DIFFUSE can change per-vertex"</font> );
00426             <font class="keywordflow">break</font>;
00427          <font class="keywordflow">case</font> <a class="code" href="gl_8h.html#a132">GL_AMBIENT</a>:
00428             <a class="code" href="debug_8h.html#a1">mNotImplemented</a>( <font class="stringliteral">"Only GL_DIFFUSE can change per-vertex"</font> );
00429             <font class="keywordflow">break</font>;
00430          <font class="keywordflow">case</font> <a class="code" href="gl_8h.html#a133">GL_DIFFUSE</a>:
00431             <font class="comment">// fix later..</font>
00432             GLContext.PerVtxMaterialChanged();
00433             RendererManager.<a class="code" href="classCRendererManager.html#a15">PerVtxMaterialChanged</a>( RendererProps::kDiffuse );
00434             <font class="keywordflow">break</font>;
00435          <font class="keywordflow">case</font> <a class="code" href="gl_8h.html#a139">GL_AMBIENT_AND_DIFFUSE</a>:
00436             <a class="code" href="debug_8h.html#a1">mNotImplemented</a>( <font class="stringliteral">"Only GL_DIFFUSE can change per-vertex"</font> );
00437             <font class="keywordflow">break</font>;
00438          <font class="keywordflow">case</font> <a class="code" href="gl_8h.html#a134">GL_SPECULAR</a>:
00439             <a class="code" href="debug_8h.html#a1">mNotImplemented</a>( <font class="stringliteral">"Only GL_DIFFUSE can change per-vertex"</font> );
00440             <font class="comment">// PerVtxMaterialChanged( PerVtxMaterial::kSpecular );</font>
00441             <font class="keywordflow">break</font>;
00442       }
00443    }
00444    <font class="keywordflow">else</font> {
00445       RendererManager.<a class="code" href="classCRendererManager.html#a15">PerVtxMaterialChanged</a>( RendererProps::kNoMaterial );
00446    }
00447 }
00448 
00449 <font class="keywordtype">void</font>
<a name="l00450"></a><a class="code" href="classCImmGeomManager.html#a24">00450</a> <a class="code" href="classCImmGeomManager.html#a24">CImmGeomManager::Flush</a>()<font class="keyword"></font>
00451 {
00452    <font class="keywordflow">if</font> ( Geometry.<a class="code" href="classCGeometryBlock.html#a59">IsPending</a>() ) {
00453          <font class="keywordflow">if</font> ( Geometry.<a class="code" href="classCGeometryBlock.html#a19">GetArrayType</a>() == kLinear )
00454             RendererManager.<a class="code" href="classCRendererManager.html#a5">GetCurRenderer</a>().<a class="code" href="classCRenderer.html#a4">DrawLinearArrays</a>( Geometry );
00455          <font class="keywordflow">else</font>
00456             RendererManager.<a class="code" href="classCRendererManager.html#a5">GetCurRenderer</a>().<a class="code" href="classCRenderer.html#a5">DrawIndexedArrays</a>( Geometry );
00457       Geometry.<a class="code" href="classCGeometryBlock.html#a58">Reset</a>();
00458    }
00459 }
</pre></div><hr><address><small>ps2gl version cvs</small></address>
