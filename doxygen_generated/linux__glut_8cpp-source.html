<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>linux_glut.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.11 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>linux_glut.cpp</h1><a href="linux__glut_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*        Copyright (C) 2000,2001,2002  Sony Computer Entertainment America</font>
00002           
00003           This file is subject to the terms and conditions of the GNU Lesser
00004           General Public License Version 2.1. See the file "COPYING" in the
00005           main directory of this archive for more details.                             */
00006 
00007 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00008 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00009 <font class="preprocessor">#include &lt;math.h&gt;</font>
00010 <font class="preprocessor">#include &lt;linux/ps2/gs.h&gt;</font>
00011 <font class="preprocessor">#include &lt;sys/ioctl.h&gt;</font>
00012 <font class="comment">// for allocating memory with the ps2stuff kernel module</font>
00013 <font class="preprocessor">#include &lt;sys/mman.h&gt;</font>
00014 
00015 <font class="preprocessor">#include "ps2gs.h"</font>
00016 <font class="preprocessor">#include "ps2dma.h"</font>
00017 <font class="preprocessor">#include "ps2vpu.h"</font>
00018 <font class="preprocessor">#include "ps2vpufile.h"</font>
00019 
00020 
00021 <font class="preprocessor">#include "<a class="code" href="sjoy_8h.html">sjoy.h</a>"</font>
00022 
00023 <font class="preprocessor">#include "<a class="code" href="glut_8h.html">GL/glut.h</a>"</font>
00024 <font class="preprocessor">#include "<a class="code" href="ps2gl_8h.html">GL/ps2gl.h</a>"</font>
00025 
00026 <font class="preprocessor">#include "ps2s/timer.h"</font>
00027 <font class="preprocessor">#include "ps2s/gs.h"</font>
00028 <font class="preprocessor">#include "ps2s/packet.h"</font>
00029 <font class="preprocessor">#include "ps2s/displayenv.h"</font>
00030 
00031 <font class="preprocessor">#include "<a class="code" href="debug_8h.html">ps2gl/debug.h</a>"</font>
00032 
00033 <font class="comment">// #include "pads.h"</font>
00034 
<a name="l00035"></a><a class="code" href="structps2__vpu__struct.html">00035</a> <font class="keyword">struct </font><a class="code" href="structps2__vpu__struct.html">ps2_vpu_struct</a> {
<a name="l00036"></a><a class="code" href="structps2__vpu__struct.html#m0">00036</a>         <font class="keywordtype">int</font> fd;
<a name="l00037"></a><a class="code" href="structps2__vpu__struct.html#m1">00037</a>         <font class="keywordtype">int</font> vpu;
<a name="l00038"></a><a class="code" href="structps2__vpu__struct.html#m2">00038</a>         <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> mapsize;
<a name="l00039"></a><a class="code" href="structps2__vpu__struct.html#m3">00039</a>         <font class="keywordtype">void</font> *text;
<a name="l00040"></a><a class="code" href="structps2__vpu__struct.html#m4">00040</a>         <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> text_size;
<a name="l00041"></a><a class="code" href="structps2__vpu__struct.html#m5">00041</a>         <font class="keywordtype">void</font> *data;
<a name="l00042"></a><a class="code" href="structps2__vpu__struct.html#m6">00042</a>         <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> data_size;
00043 };
00044 
00045 <font class="comment">/********************************************</font>
00046  * some function pointer types
00047  */
00048 
<a name="l00049"></a><a class="code" href="linux__glut_8cpp.html#a0">00049</a> <font class="keyword">typedef</font> void (* tFunctionPtr_ii)        (<font class="keywordtype">int</font>, <font class="keywordtype">int</font>);
<a name="l00050"></a><a class="code" href="linux__glut_8cpp.html#a1">00050</a> <font class="keyword">typedef</font> void (* tFunctionPtr_ucii)      (<font class="keywordtype">unsigned</font> <font class="keywordtype">char</font>, <font class="keywordtype">int</font>, <font class="keywordtype">int</font>);
<a name="l00051"></a><a class="code" href="linux__glut_8cpp.html#a2">00051</a> <font class="keyword">typedef</font> void (* tFunctionPtr_iii)       (<font class="keywordtype">int</font>, <font class="keywordtype">int</font>, <font class="keywordtype">int</font>);
<a name="l00052"></a><a class="code" href="linux__glut_8cpp.html#a3">00052</a> <font class="keyword">typedef</font> void (* tFunctionPtr)           (<font class="keywordtype">void</font>);
<a name="l00053"></a><a class="code" href="linux__glut_8cpp.html#a4">00053</a> <font class="keyword">typedef</font> void (* tFunctionPtr_i)         (<font class="keywordtype">int</font>);
00054 
00055 <font class="comment">/********************************************</font>
00056  * local functions
00057  */
00058 
00059 <font class="keyword">static</font> <font class="keywordtype">void</font> initGsMemory();
00060 <font class="keyword">static</font> <font class="keywordtype">bool</font> doPads( <font class="keywordtype">int</font> frameCount );
00061 <font class="keyword">static</font> <font class="keywordtype">void</font> parse_cl( <font class="keywordtype">int</font> *argcp, <font class="keywordtype">char</font> **argv );
00062 
00063 <font class="comment">/********************************************</font>
00064  * local data
00065  */
00066 
<a name="l00067"></a><a class="code" href="linux__glut_8cpp.html#a5">00067</a> tFunctionPtr DisplayFunc = NULL;
<a name="l00068"></a><a class="code" href="linux__glut_8cpp.html#a6">00068</a> tFunctionPtr_ii ReshapeFunc = NULL;
<a name="l00069"></a><a class="code" href="linux__glut_8cpp.html#a7">00069</a> tFunctionPtr_ucii KeyboardFunc = NULL;
<a name="l00070"></a><a class="code" href="linux__glut_8cpp.html#a8">00070</a> tFunctionPtr_i VisibilityFunc = NULL;
<a name="l00071"></a><a class="code" href="linux__glut_8cpp.html#a9">00071</a> tFunctionPtr IdleFunc = NULL;
<a name="l00072"></a><a class="code" href="linux__glut_8cpp.html#a10">00072</a> tFunctionPtr_iii SpecialFunc = NULL;
00073 
00074 <font class="keyword">static</font> CEETimer *Timer2, *Timer3;
00075 <font class="comment">//  static char default_module_path[] = "host0:/usr/local/sce/iop/modules";</font>
00076 <font class="comment">//  static char *module_path = '\0';</font>
00077 
<a name="l00078"></a><a class="code" href="linux__glut_8cpp.html#a13">00078</a> <font class="keywordtype">int</font> <a class="code" href="linux__glut_8cpp.html#a13">g_inter</a>;
<a name="l00079"></a><a class="code" href="linux__glut_8cpp.html#a14">00079</a> <font class="keywordtype">int</font> <a class="code" href="linux__glut_8cpp.html#a14">g_out_mode</a>;
<a name="l00080"></a><a class="code" href="linux__glut_8cpp.html#a15">00080</a> <font class="keywordtype">int</font> <a class="code" href="linux__glut_8cpp.html#a15">g_ff_mode</a>;
<a name="l00081"></a><a class="code" href="linux__glut_8cpp.html#a16">00081</a> <font class="keywordtype">int</font> <a class="code" href="linux__glut_8cpp.html#a16">g_resolution</a>;
<a name="l00082"></a><a class="code" href="linux__glut_8cpp.html#a17">00082</a> <font class="keywordtype">int</font> <a class="code" href="linux__glut_8cpp.html#a17">g_refresh_rate</a>;
<a name="l00083"></a><a class="code" href="linux__glut_8cpp.html#a18">00083</a> <font class="keywordtype">int</font> <a class="code" href="linux__glut_8cpp.html#a18">g_psm</a>;
<a name="l00084"></a><a class="code" href="linux__glut_8cpp.html#a19">00084</a> <font class="keywordtype">int</font> <a class="code" href="linux__glut_8cpp.html#a19">g_zpsm</a>;
<a name="l00085"></a><a class="code" href="linux__glut_8cpp.html#a20">00085</a> <font class="keywordtype">int</font> <a class="code" href="linux__glut_8cpp.html#a20">g_zbits</a>;
00086 
<a name="l00087"></a><a class="code" href="linux__glut_8cpp.html#a21">00087</a> <font class="keywordtype">int</font> <a class="code" href="linux__glut_8cpp.html#a21">g_fd_gs</a>;
<a name="l00088"></a><a class="code" href="linux__glut_8cpp.html#a23">00088</a> ps2_vpu *<a class="code" href="linux__glut_8cpp.html#a22">g_vpu0</a>, *<a class="code" href="linux__glut_8cpp.html#a23">g_vpu1</a>;
00089 
<a name="l00090"></a><a class="code" href="linux__glut_8cpp.html#a52">00090</a> <font class="keyword">typedef</font> <font class="keyword">enum</font> { <a class="code" href="linux__glut_8cpp.html#a52a27">eNtsc</a>, <a class="code" href="linux__glut_8cpp.html#a52a28">eVesa0</a> } <a class="code" href="linux__glut_8cpp.html#a52">screen_mode_t</a>;
<a name="l00091"></a><a class="code" href="linux__glut_8cpp.html#a24">00091</a> <a class="code" href="linux__glut_8cpp.html#a52">screen_mode_t</a> <a class="code" href="linux__glut_8cpp.html#a24">screen_mode</a> = <a class="code" href="linux__glut_8cpp.html#a52a28">eVesa0</a>;
00092 
<a name="l00093"></a><a class="code" href="linux__glut_8cpp.html#a32">00093</a> <font class="keywordtype">int</font> <a class="code" href="linux__glut_8cpp.html#a32">release</a>(<font class="keywordtype">void</font>)<font class="keyword"></font>
00094 {
00095    <font class="keywordflow">if</font> (g_vpu1) {
00096       ps2_vpu_close(<a class="code" href="linux__glut_8cpp.html#a23">g_vpu1</a>);
00097       <a class="code" href="linux__glut_8cpp.html#a23">g_vpu1</a> = NULL;
00098    }
00099         
00100    <font class="keywordflow">if</font> (g_vpu0) {
00101       ps2_vpu_close(<a class="code" href="linux__glut_8cpp.html#a22">g_vpu0</a>);
00102       <a class="code" href="linux__glut_8cpp.html#a22">g_vpu0</a> = NULL;
00103    }
00104         
00105    <font class="keywordflow">if</font> (<a class="code" href="linux__glut_8cpp.html#a21">g_fd_gs</a> &gt;= 0) {
00106       ps2_gs_close();
00107       <a class="code" href="linux__glut_8cpp.html#a21">g_fd_gs</a> = -1;
00108    }
00109         
00110    <font class="keywordflow">return</font> PS2_GS_VC_REL_SUCCESS;
00111 }
00112 
<a name="l00113"></a><a class="code" href="linux__glut_8cpp.html#a33">00113</a> <font class="keywordtype">int</font> <a class="code" href="linux__glut_8cpp.html#a33">acquire</a>(<font class="keywordtype">void</font>)<font class="keyword"></font>
00114 {
00115    <a class="code" href="linux__glut_8cpp.html#a21">g_fd_gs</a> = ps2_gs_open(-1);
00116    <a class="code" href="linux__glut_8cpp.html#a22">g_vpu0</a> = ps2_vpu_open(0);
00117    <a class="code" href="linux__glut_8cpp.html#a23">g_vpu1</a> = ps2_vpu_open(1);
00118         
00119    <font class="keywordflow">if</font> (<a class="code" href="linux__glut_8cpp.html#a21">g_fd_gs</a> &lt; 0 || <a class="code" href="linux__glut_8cpp.html#a22">g_vpu0</a> == NULL || <a class="code" href="linux__glut_8cpp.html#a23">g_vpu1</a> == NULL) {
00120       <a class="code" href="linux__glut_8cpp.html#a32">release</a>();
00121       <font class="keywordflow">return</font> PS2_GS_VC_ACQ_FAILURE;
00122    }
00123         
00124    ps2_vpu_reset(<a class="code" href="linux__glut_8cpp.html#a23">g_vpu1</a>);
00125    ps2_vpu_reset(<a class="code" href="linux__glut_8cpp.html#a22">g_vpu0</a>);
00126         
00127    ps2_gs_reset(0, <a class="code" href="linux__glut_8cpp.html#a13">g_inter</a>, <a class="code" href="linux__glut_8cpp.html#a14">g_out_mode</a>, <a class="code" href="linux__glut_8cpp.html#a15">g_ff_mode</a>, <a class="code" href="linux__glut_8cpp.html#a16">g_resolution</a>,
00128                 <a class="code" href="linux__glut_8cpp.html#a17">g_refresh_rate</a>);
00129         
00130    <font class="keywordflow">return</font> PS2_GS_VC_ACQ_SUCCESS;
00131 }
00132 
00133 <font class="comment">/********************************************</font>
00134  * glut implementation (loosely speaking..)
00135  */
00136 
00155 <font class="comment">// it doesn't get much lamer than this...</font>
00156 <font class="keyword">extern</font> <font class="stringliteral">"C"</font> <font class="keywordtype">int</font> <a class="code" href="group__glut__api.html#a2">setcrtmode</a>(<font class="keywordtype">int</font> argc, <font class="keywordtype">char</font> **argv, <font class="keywordtype">int</font> gs_fd);
00157 
00158 <font class="preprocessor">#   include &lt;unistd.h&gt;</font>
00159 <font class="preprocessor">#   include &lt;sys/stat.h&gt;</font>
00160 <font class="preprocessor">#   include &lt;fcntl.h&gt;</font>
00161 <font class="preprocessor">#   include &lt;errno.h&gt;</font>
00162 <font class="preprocessor">#include &lt;string.h&gt;</font>
00163 
<a name="l00164"></a><a class="code" href="group__glut__api.html#a0">00164</a> <font class="keywordtype">int</font> <a class="code" href="linux__glut_8cpp.html#a0">Ps2stuffDeviceFd</a> = -1;
<a name="l00165"></a><a class="code" href="group__glut__api.html#a1">00165</a> <font class="keywordtype">bool</font> <a class="code" href="linux__glut_8cpp.html#a1">WaitForVsync</a> = <font class="keyword">true</font>;
00166 
<a name="l00174"></a><a class="code" href="group__glut__api.html#a3">00174</a> <font class="keywordtype">void</font> <a class="code" href="group__glut__api.html#a19">glutInit</a>(<font class="keywordtype">int</font> *argcp, <font class="keywordtype">char</font> **argv)<font class="keyword"></font>
00175 {
00176    parse_cl( argcp, argv );
00177 
00178    <font class="keywordflow">if</font> ( <a class="code" href="linux__glut_8cpp.html#a24">screen_mode</a> == <a class="code" href="linux__glut_8cpp.html#a52a28">eVesa0</a> ) {
00179       printf(<font class="stringliteral">"vesa0 mode\n"</font>);
00180       <a class="code" href="linux__glut_8cpp.html#a13">g_inter</a> = PS2_GS_NOINTERLACE;
00181       <a class="code" href="linux__glut_8cpp.html#a14">g_out_mode</a> = PS2_GS_VESA;
00182       <a class="code" href="linux__glut_8cpp.html#a15">g_ff_mode</a> = PS2_GS_FRAME;
00183       <a class="code" href="linux__glut_8cpp.html#a16">g_resolution</a> = PS2_GS_640x480;
00184    }
00185    <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( <a class="code" href="linux__glut_8cpp.html#a24">screen_mode</a> == <a class="code" href="linux__glut_8cpp.html#a52a27">eNtsc</a> ) {
00186       printf(<font class="stringliteral">"ntsc1 mode\n"</font>);
00187       <a class="code" href="linux__glut_8cpp.html#a13">g_inter</a> = PS2_GS_NOINTERLACE;
00188       <a class="code" href="linux__glut_8cpp.html#a14">g_out_mode</a> = PS2_GS_NTSC;
00189       <a class="code" href="linux__glut_8cpp.html#a15">g_ff_mode</a> = PS2_GS_FRAME;
00190       <a class="code" href="linux__glut_8cpp.html#a16">g_resolution</a> = PS2_GS_640x480;
00191    }
00192 
00193    <a class="code" href="linux__glut_8cpp.html#a17">g_refresh_rate</a> = PS2_GS_60Hz;
00194    <a class="code" href="linux__glut_8cpp.html#a18">g_psm</a> = PS2_GS_PSMCT32;
00195    <a class="code" href="linux__glut_8cpp.html#a19">g_zpsm</a> = PS2_GS_PSMZ32;
00196    <a class="code" href="linux__glut_8cpp.html#a20">g_zbits</a> = 32;
00197         
00198    ps2_gs_vc_graphicsmode();
00199         
00200    <a class="code" href="linux__glut_8cpp.html#a21">g_fd_gs</a> = ps2_gs_open(-1);
00201    <a class="code" href="linux__glut_8cpp.html#a22">g_vpu0</a> = ps2_vpu_open(0); <font class="comment">// must be opened for vpu1...</font>
00202    <a class="code" href="linux__glut_8cpp.html#a23">g_vpu1</a> = ps2_vpu_open(1);
00203 
00204    <a class="code" href="linux__glut_8cpp.html#a0">Ps2stuffDeviceFd</a> = open( <font class="stringliteral">"/dev/ps2stuff"</font>, O_RDWR );
00205    <font class="keywordflow">if</font> ( <a class="code" href="linux__glut_8cpp.html#a0">Ps2stuffDeviceFd</a> &lt; 0 ) {
00206      fprintf( stderr, <font class="stringliteral">"Couldn't open /dev/ps2stuff: %s\n"</font>, strerror(errno) );
00207      exit(-1);
00208    }
00209 
00210    ioctl( <a class="code" href="linux__glut_8cpp.html#a0">Ps2stuffDeviceFd</a>, PS2STUFF_IOCTMEMRESET );
00211 
00212    <font class="comment">// these are static, so they should be ok to call before</font>
00213    <font class="comment">// pglInit..</font>
00214    CDmaPacket::InitFileDescriptors( <a class="code" href="linux__glut_8cpp.html#a21">g_fd_gs</a>, g_vpu0-&gt;fd, g_vpu1-&gt;fd, <a class="code" href="linux__glut_8cpp.html#a0">Ps2stuffDeviceFd</a> );
00215    GS::CDisplayEnv::InitGsFd( <a class="code" href="linux__glut_8cpp.html#a21">g_fd_gs</a> );
00216 
00217    ps2_gs_reset(0, <a class="code" href="linux__glut_8cpp.html#a13">g_inter</a>, <a class="code" href="linux__glut_8cpp.html#a14">g_out_mode</a>, <a class="code" href="linux__glut_8cpp.html#a15">g_ff_mode</a>, <a class="code" href="linux__glut_8cpp.html#a16">g_resolution</a>,
00218                 <a class="code" href="linux__glut_8cpp.html#a17">g_refresh_rate</a>);
00219         
00220    ps2_gs_start_display(1);
00221         
00222    ps2_gs_vc_enablevcswitch(<a class="code" href="linux__glut_8cpp.html#a33">acquire</a>, <a class="code" href="linux__glut_8cpp.html#a32">release</a>);
00223         
00224    ps2_gs_sync_v(0);
00225         
00226    <font class="comment">// does the ps2gl library need to be initialized?</font>
00227 
00228    <font class="keywordflow">if</font> ( ! <a class="code" href="group__pgl__api.html#a4">pglHasLibraryBeenInitted</a>() )<font class="keyword"> </font>{
00229       mWarn( <font class="stringliteral">"ps2gl library has not been initialized by the user; using default values."</font> );
00230       <font class="keywordtype">int</font> immBufferVertexSize = 8 * 1024;
00231       <a class="code" href="ps2gl_8h.html#a13">pglInit</a>( immBufferVertexSize, 1000 );
00232    }
00233 
00234    <font class="comment">// does gs memory need to be initialized?</font>
00235 
00236    <font class="keywordflow">if</font> ( ! <a class="code" href="group__gs__mem.html#a1">pglHasGsMemBeenInitted</a>() )<font class="keyword"> </font>{
00237       mWarn(<font class="stringliteral">"GS memory has not been allocated by the user; using default values."</font>);
00238       initGsMemory();
00239    }
00240 
00241    <font class="comment">// init the timing system</font>
00242 
00243    Timer2 = <font class="keyword">new</font> CEETimer( CEETimer::Timer2 );
00244 <font class="comment">//     Timer2-&gt;SetResolution( CEETimer::BusClock_256th );</font>
00245 <font class="comment">//     Timer3 = new CEETimer( CEETimer::Timer3 );</font>
00246 <font class="comment">//     Timer3-&gt;SetResolution( CEETimer::BusClock_16th );</font>
00247    mInitTimers( Timer2, CEETimer::BusClock_256th );
00248 
00249    <font class="comment">// open the pads</font>
00250    <a class="code" href="sjoy_8c.html#a5">sjoy_open</a>();
00251 }
00252 
<a name="l00256"></a><a class="code" href="group__glut__api.html#a4">00256</a> <font class="keywordtype">void</font> <a class="code" href="group__glut__api.html#a20">glutDisplayFunc</a>(<font class="keywordtype">void</font> (*func)(<font class="keywordtype">void</font>))<font class="keyword"></font>
00257 {
00258    DisplayFunc = func;
00259 }
00260 
<a name="l00266"></a><a class="code" href="group__glut__api.html#a5">00266</a> <font class="keywordtype">void</font> <a class="code" href="group__glut__api.html#a21">glutReshapeFunc</a>(<font class="keywordtype">void</font> (*func)(<font class="keywordtype">int</font> width, <font class="keywordtype">int</font> height))<font class="keyword"></font>
00267 {
00268    ReshapeFunc = func;
00269 }
00270 
<a name="l00276"></a><a class="code" href="group__glut__api.html#a6">00276</a> <font class="keywordtype">void</font> <a class="code" href="group__glut__api.html#a22">glutKeyboardFunc</a>(<font class="keywordtype">void</font> (*func)(<font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> key, <font class="keywordtype">int</font> x, <font class="keywordtype">int</font> y))<font class="keyword"></font>
00277 {
00278    KeyboardFunc = func;
00279 }
00280 
<a name="l00286"></a><a class="code" href="group__glut__api.html#a7">00286</a> <font class="keywordtype">void</font> <a class="code" href="group__glut__api.html#a23">glutVisibilityFunc</a>(<font class="keywordtype">void</font> (*func)(<font class="keywordtype">int</font> state))<font class="keyword"></font>
00287 {
00288    VisibilityFunc = func;
00289 }
00290 
<a name="l00295"></a><a class="code" href="group__glut__api.html#a8">00295</a> <font class="keywordtype">void</font> <a class="code" href="group__glut__api.html#a24">glutIdleFunc</a>(<font class="keywordtype">void</font> (*func)(<font class="keywordtype">void</font>))<font class="keyword"></font>
00296 {
00297    IdleFunc = func;
00298 }
00299 
<a name="l00305"></a><a class="code" href="group__glut__api.html#a9">00305</a> <font class="keywordtype">void</font> <a class="code" href="group__glut__api.html#a25">glutSpecialFunc</a>(<font class="keywordtype">void</font> (*func)(<font class="keywordtype">int</font> key, <font class="keywordtype">int</font> x, <font class="keywordtype">int</font> y))<font class="keyword"></font>
00306 {
00307    SpecialFunc = func;
00308 }
00309 
<a name="l00314"></a><a class="code" href="group__glut__api.html#a10">00314</a> <font class="keywordtype">void</font> <a class="code" href="group__glut__api.html#a47">glutMainLoop</a>( <font class="keywordtype">void</font> )<font class="keyword"></font>
00315 {
00316    mErrorIf( DisplayFunc == NULL, <font class="stringliteral">"ps2glut:  No display function!"</font> );
00317 
00318    <font class="keywordflow">if</font> ( ReshapeFunc )
00319       <a class="code" href="ps2glut_8cpp.html#a6">ReshapeFunc</a>( 640, 480 );
00320 
00321    <font class="keywordflow">if</font> ( VisibilityFunc )
00322       <a class="code" href="ps2glut_8cpp.html#a8">VisibilityFunc</a>( GLUT_VISIBLE );
00323 
00324    <font class="keywordtype">int</font> frameCount = 0;
00325 
00326    <font class="keywordflow">while</font>(1) {
00327       mUpdateTimers();
00328 
00329       mStartTimer(<font class="stringliteral">"frame time"</font>);
00330 
00331       <font class="comment">// ps2_gs_vc_lock();</font>
00332 
00333       <font class="keywordtype">bool</font> printTimes = doPads( frameCount );
00334 
00335       <font class="keywordflow">if</font> ( DisplayFunc ) {
00336          mStartTimer(<font class="stringliteral">"DisplayFunc()"</font>);
00337          <a class="code" href="group__pgl__api.html#a14">pglBeginGeometry</a>();
00338          <a class="code" href="ps2glut_8cpp.html#a5">DisplayFunc</a>();
00339          <a class="code" href="group__pgl__api.html#a15">pglEndGeometry</a>();
00340          mStopTimer(<font class="stringliteral">"DisplayFunc()"</font>);
00341       }
00342 
00343       <font class="keywordflow">if</font> ( IdleFunc ) {
00344          mStartTimer(<font class="stringliteral">"IdleFunc()"</font>);
00345          <a class="code" href="ps2glut_8cpp.html#a9">IdleFunc</a>();
00346          mStopTimer(<font class="stringliteral">"IdleFunc()"</font>);
00347       }
00348 
00349       mStartTimer(<font class="stringliteral">"wait for vu1"</font>);
00350       <a class="code" href="ps2gl_8h.html#a50">pglFinishRenderingGeometry</a>( <a class="code" href="ps2gl_8h.html#a2">PGL_DONT_FORCE_IMMEDIATE_STOP</a> );
00351       mStopTimer(<font class="stringliteral">"wait for vu1"</font>);
00352 
00353       mStopTimer(<font class="stringliteral">"frame time"</font>);
00354 
00355       <font class="keywordflow">if</font> ( printTimes ) {
00356          mDisplayTimers();
00357          printTimes = <font class="keyword">false</font>;
00358       }
00359 
00360       <font class="keywordflow">if</font> ( WaitForVsync )
00361          <a class="code" href="group__pgl__api.html#a7">pglWaitForVSync</a>();
00362 
00363       <a class="code" href="group__pgl__api.html#a8">pglSwapBuffers</a>();
00364 
00365       <a class="code" href="group__pgl__api.html#a16">pglRenderGeometry</a>();
00366 
00367       frameCount++;
00368 
00369       <font class="comment">// ps2_gs_vc_unlock();</font>
00370    }
00371 }
00372  <font class="comment">// glut_api</font>
00374 
00375 <font class="keyword">static</font> <font class="keywordtype">void</font>
00376 parse_cl( <font class="keywordtype">int</font> *argcp, <font class="keywordtype">char</font> **argv )<font class="keyword"></font>
00377 {
00378    <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; *argcp; i++ ) {
00379       <font class="keywordtype">bool</font> found = <font class="keyword">false</font>;
00380 
00381       <font class="keywordflow">if</font> ( strstr(argv[i], <font class="stringliteral">"-ntsc1"</font>) == argv[i] )<font class="keyword"> </font>{
00382          <a class="code" href="linux__glut_8cpp.html#a24">screen_mode</a> = <a class="code" href="linux__glut_8cpp.html#a52a27">eNtsc</a>;
00383          found = <font class="keyword">true</font>;
00384       }
00385       <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( strstr(argv[i], <font class="stringliteral">"-vesa0"</font>) == argv[i] )<font class="keyword"> </font>{
00386          <a class="code" href="linux__glut_8cpp.html#a24">screen_mode</a> = <a class="code" href="linux__glut_8cpp.html#a52a28">eVesa0</a>;
00387          found = <font class="keyword">true</font>;
00388       }
00389 
00390       <font class="keywordflow">if</font> ( found ) argv[i] = NULL;
00391    }
00392 
00393    <font class="comment">// fix up argv</font>
00394 
00395    <font class="keywordtype">int</font> numArgs = *argcp;
00396    <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; numArgs; i++ ) {
00397       <font class="keywordflow">if</font> ( argv[i] == NULL ) {
00398          <font class="comment">// move everything after left one</font>
00399          <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> j = i; j &lt; numArgs - 1; j++ )
00400             argv[j] = argv[j+1];
00401          *argcp -= 1;
00402       }
00403    }
00404 }
00405 
00406 <font class="keyword">static</font> <font class="keywordtype">bool</font>
00407 doPads( <font class="keywordtype">int</font> frameCount )<font class="keyword"></font>
00408 {
00409    <font class="keyword">static</font> <font class="keywordtype">int</font> paddata = 0;
00410 
00411    <a class="code" href="sjoy_8c.html#a7">sjoy_poll</a>();
00412    paddata = <a class="code" href="sjoy_8h.html#a19">sjoy_get_ps2_button</a>(0);
00413 
00414    <font class="keywordtype">bool</font> printTimes = ( paddata &amp; <a class="code" href="sjoy_8h.html#a9">SJOY_PS2_START</a> );
00415 
00416    <font class="keywordflow">if</font> ( SpecialFunc ) {
00417       <font class="keywordflow">if</font> ( (frameCount % 15) == 0 ) {
00418          <font class="keywordflow">if</font> ( paddata &amp; <a class="code" href="sjoy_8h.html#a12">SJOY_PS2_L_UP</a> ) {
00419             <a class="code" href="ps2glut_8cpp.html#a10">SpecialFunc</a>( GLUT_KEY_UP, 0, 0 );
00420          }
00421          <font class="keywordflow">if</font> ( paddata &amp; <a class="code" href="sjoy_8h.html#a11">SJOY_PS2_L_DOWN</a> ) {
00422             <a class="code" href="ps2glut_8cpp.html#a10">SpecialFunc</a>( GLUT_KEY_DOWN, 0, 0 );
00423          }
00424          <font class="keywordflow">if</font> ( paddata &amp; <a class="code" href="sjoy_8h.html#a13">SJOY_PS2_L_RIGHT</a> ) {
00425             <a class="code" href="ps2glut_8cpp.html#a10">SpecialFunc</a>( GLUT_KEY_RIGHT, 0, 0 );
00426          }
00427          <font class="keywordflow">if</font> ( paddata &amp; <a class="code" href="sjoy_8h.html#a10">SJOY_PS2_L_LEFT</a> ) {
00428             <a class="code" href="ps2glut_8cpp.html#a10">SpecialFunc</a>( GLUT_KEY_LEFT, 0, 0 );
00429          }
00430 
00431          <font class="keywordflow">if</font> ( paddata &amp; <a class="code" href="sjoy_8h.html#a4">SJOY_PS2_L1</a> ) {
00432             <a class="code" href="ps2glut_8cpp.html#a10">SpecialFunc</a>( GLUT_KEY_HOME, 0, 0 );
00433          }
00434          <font class="keywordflow">if</font> ( paddata &amp; <a class="code" href="sjoy_8h.html#a6">SJOY_PS2_L2</a> ) {
00435             <a class="code" href="ps2glut_8cpp.html#a10">SpecialFunc</a>( GLUT_KEY_END, 0, 0 );
00436          }
00437 
00438          <font class="keywordflow">if</font> ( paddata &amp; <a class="code" href="sjoy_8h.html#a5">SJOY_PS2_R1</a> ) {
00439             <a class="code" href="linux__glut_8cpp.html#a1">WaitForVsync</a> = ! <a class="code" href="linux__glut_8cpp.html#a1">WaitForVsync</a>;
00440             <a class="code" href="ps2glut_8cpp.html#a10">SpecialFunc</a>( GLUT_KEY_PAGE_UP, 0, 0 );
00441          }
00442          <font class="keywordflow">if</font> ( paddata &amp; <a class="code" href="sjoy_8h.html#a7">SJOY_PS2_R2</a> ) {
00443             <a class="code" href="ps2glut_8cpp.html#a10">SpecialFunc</a>( GLUT_KEY_PAGE_DOWN, 0, 0 );
00444          }
00445       }
00446    }
00447 
00448    <font class="keywordflow">if</font> ( KeyboardFunc ) {
00449       <font class="keywordflow">if</font> ( paddata &amp; <a class="code" href="sjoy_8h.html#a2">SJOY_PS2_R_UP</a> ) {
00450          <a class="code" href="ps2glut_8cpp.html#a7">KeyboardFunc</a>( <font class="charliteral">'8'</font>, 0, 0 );
00451       }
00452       <font class="keywordflow">if</font> ( paddata &amp; <a class="code" href="sjoy_8h.html#a1">SJOY_PS2_R_DOWN</a> ) {
00453          <a class="code" href="ps2glut_8cpp.html#a7">KeyboardFunc</a>( <font class="charliteral">'2'</font>, 0, 0 );
00454       }
00455       <font class="keywordflow">if</font> ( paddata &amp; <a class="code" href="sjoy_8h.html#a0">SJOY_PS2_R_LEFT</a> ) {
00456          <a class="code" href="ps2glut_8cpp.html#a7">KeyboardFunc</a>( <font class="charliteral">'4'</font>, 0, 0 );
00457       }
00458       <font class="keywordflow">if</font> ( paddata &amp; <a class="code" href="sjoy_8h.html#a3">SJOY_PS2_R_RIGHT</a> ) {
00459          <a class="code" href="ps2glut_8cpp.html#a7">KeyboardFunc</a>( <font class="charliteral">'6'</font>, 0, 0 );
00460       }
00461    }
00462 
00463    <font class="keywordflow">return</font> printTimes;
00464 }
00465 
00466 
<a name="l00467"></a><a class="code" href="linux__glut_8cpp.html#a43">00467</a> <font class="keywordtype">void</font> <a class="code" href="ps2glut_8cpp.html#a27">glutInitDisplayMode</a>(<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> mode)<font class="keyword"></font>
00468 {
00469    <a class="code" href="debug_8h.html#a1">mNotImplemented</a>( );
00470 }
00471 
<a name="l00472"></a><a class="code" href="linux__glut_8cpp.html#a44">00472</a> <font class="keywordtype">void</font> <a class="code" href="ps2glut_8cpp.html#a28">glutInitWindowPosition</a>( <font class="keywordtype">int</font> x, <font class="keywordtype">int</font> y )<font class="keyword"></font>
00473 {
00474    <a class="code" href="debug_8h.html#a1">mNotImplemented</a>( );
00475 }
00476 
<a name="l00477"></a><a class="code" href="linux__glut_8cpp.html#a45">00477</a> <font class="keywordtype">void</font> <a class="code" href="ps2glut_8cpp.html#a29">glutInitWindowSize</a>( <font class="keywordtype">int</font> x, <font class="keywordtype">int</font> y )<font class="keyword"></font>
00478 {
00479    <a class="code" href="debug_8h.html#a1">mNotImplemented</a>( );
00480 }
00481 
<a name="l00482"></a><a class="code" href="linux__glut_8cpp.html#a46">00482</a> <font class="keywordtype">int</font> <a class="code" href="ps2glut_8cpp.html#a30">glutCreateWindow</a>(<font class="keyword">const</font> <font class="keywordtype">char</font> *title)<font class="keyword"></font>
00483 {
00484    <a class="code" href="debug_8h.html#a1">mNotImplemented</a>( );
00485 
00486    <font class="keywordflow">return</font> 1;
00487 }
00488 
<a name="l00489"></a><a class="code" href="linux__glut_8cpp.html#a47">00489</a> <font class="keywordtype">void</font> <a class="code" href="glut_8h.html#a48">glutPostRedisplay</a>(<font class="keywordtype">void</font>)<font class="keyword"></font>
00490 {
00491    <font class="comment">// mNotImplemented( );</font>
00492 }
00493 
<a name="l00494"></a><a class="code" href="linux__glut_8cpp.html#a48">00494</a> <font class="keywordtype">void</font> <a class="code" href="glut_8h.html#a49">glutSwapBuffers</a>( <font class="keywordtype">void</font> )<font class="keyword"></font>
00495 {
00496 }
00497 
<a name="l00498"></a><a class="code" href="linux__glut_8cpp.html#a49">00498</a> <font class="keywordtype">int</font> <a class="code" href="ps2glut_8cpp.html#a33">glutGet</a>(<a class="code" href="gl_8h.html#a687">GLenum</a> type)<font class="keyword"></font>
00499 {
00500    <a class="code" href="debug_8h.html#a1">mNotImplemented</a>( );
00501    <font class="keywordflow">return</font> 0;
00502 }
00503 
00504 <font class="keywordtype">void</font>*
<a name="l00505"></a><a class="code" href="linux__glut_8cpp.html#a50">00505</a> <a class="code" href="ps2glut_8cpp.html#a34">pglutAllocDmaMem</a>( <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> num_bytes )<font class="keyword"></font>
00506 {
00507    <font class="comment">// use the ps2stuff kernel module to allocate</font>
00508    <font class="keywordflow">return</font> mmap(0, num_bytes,
00509                PROT_READ | PROT_WRITE,
00510                MAP_SHARED, <a class="code" href="linux__glut_8cpp.html#a0">Ps2stuffDeviceFd</a>,
00511                0 );
00512 }
00513 
00514 <font class="keywordtype">void</font>
<a name="l00515"></a><a class="code" href="linux__glut_8cpp.html#a51">00515</a> <a class="code" href="ps2glut_8cpp.html#a35">pglutFreeDmaMem</a>( <font class="keywordtype">void</font> *mem )<font class="keyword"></font>
00516 {
00517    <font class="comment">// use the ps2stuff kernel module to allocate</font>
00518    munmap( mem, 0 );
00519 }
00520 
00521 <font class="comment">/********************************************</font>
00522  * local function definitions
00523  */
00524 
00525 <font class="keyword">static</font> <font class="keywordtype">void</font>
00526 initGsMemory()<font class="keyword"></font>
00527 {
00528    <font class="comment">// frame and depth buffer</font>
00529    <a class="code" href="ps2gl_8h.html#a11">pgl_slot_handle_t</a> frame_slot_0, frame_slot_1, depth_slot;
00530    frame_slot_0 = <a class="code" href="group__gs__mem__slots.html#a21">pglAddGsMemSlot</a>( 0, 150, GS::kPsm32 );
00531    frame_slot_1 = <a class="code" href="group__gs__mem__slots.html#a21">pglAddGsMemSlot</a>( 150, 150, GS::kPsm32 );
00532    depth_slot = <a class="code" href="group__gs__mem__slots.html#a21">pglAddGsMemSlot</a>( 300, 150, GS::kPsmz24 );
00533    <font class="comment">// lock these slots so that they aren't allocated by the memory manager</font>
00534    <a class="code" href="group__gs__mem__slots.html#a22">pglLockGsMemSlot</a>( frame_slot_0 );
00535    <a class="code" href="group__gs__mem__slots.html#a22">pglLockGsMemSlot</a>( frame_slot_1 );
00536    <a class="code" href="group__gs__mem__slots.html#a22">pglLockGsMemSlot</a>( depth_slot );
00537 
00538    <font class="comment">// ntsc or vesa?</font>
00539 
00540    <font class="comment">// default to vesa</font>
00541    <font class="keywordtype">int</font> fb_height = 480, interlace = <a class="code" href="ps2gl_8h.html#a3">PGL_NONINTERLACED</a>;
00542 
00543    <font class="keywordflow">if</font> ( <a class="code" href="linux__glut_8cpp.html#a24">screen_mode</a> == <a class="code" href="linux__glut_8cpp.html#a52a27">eNtsc</a> ) {
00544       fb_height = 224;
00545       interlace = <a class="code" href="ps2gl_8h.html#a4">PGL_INTERLACED</a>;
00546    }
00547 
00548    <font class="comment">// create gs memory area objects to use for frame and depth buffers</font>
00549    <a class="code" href="ps2gl_8h.html#a12">pgl_area_handle_t</a> frame_area_0, frame_area_1, depth_area;
00550    frame_area_0 = <a class="code" href="group__gs__mem__areas.html#a25">pglCreateGsMemArea</a>( 640, fb_height, GS::kPsm24 );
00551    frame_area_1 = <a class="code" href="group__gs__mem__areas.html#a25">pglCreateGsMemArea</a>( 640, fb_height, GS::kPsm24 );
00552    depth_area = <a class="code" href="group__gs__mem__areas.html#a25">pglCreateGsMemArea</a>( 640, fb_height, GS::kPsmz24 );
00553    <font class="comment">// bind the areas to the slots we created above</font>
00554    <a class="code" href="group__gs__mem__areas.html#a30">pglBindGsMemAreaToSlot</a>( frame_area_0, frame_slot_0 );
00555    <a class="code" href="group__gs__mem__areas.html#a30">pglBindGsMemAreaToSlot</a>( frame_area_1, frame_slot_1 );
00556    <a class="code" href="group__gs__mem__areas.html#a30">pglBindGsMemAreaToSlot</a>( depth_area, depth_slot );
00557 
00558    <font class="comment">// draw to the new areas...</font>
00559    <a class="code" href="ps2gl_8h.html#a37">pglSetDrawBuffers</a>( interlace, frame_area_0, frame_area_1, depth_area );
00560    <font class="comment">// ...and display from them</font>
00561    <a class="code" href="ps2gl_8h.html#a36">pglSetDisplayBuffers</a>( interlace, frame_area_0, frame_area_1 );
00562 
00563    <font class="comment">// 32 bit</font>
00564 
00565    <font class="comment">// 64x32</font>
00566    <a class="code" href="group__gs__mem__slots.html#a21">pglAddGsMemSlot</a>( 450, 1, GS::kPsm32 );
00567    <a class="code" href="group__gs__mem__slots.html#a21">pglAddGsMemSlot</a>( 451, 1, GS::kPsm32 );
00568    <font class="comment">// 64x64</font>
00569    <a class="code" href="group__gs__mem__slots.html#a21">pglAddGsMemSlot</a>( 452, 2, GS::kPsm32 );
00570    <a class="code" href="group__gs__mem__slots.html#a21">pglAddGsMemSlot</a>( 454, 2, GS::kPsm32 );
00571    <font class="comment">// 128x128</font>
00572    <a class="code" href="group__gs__mem__slots.html#a21">pglAddGsMemSlot</a>( 456, 8, GS::kPsm32 );
00573    <a class="code" href="group__gs__mem__slots.html#a21">pglAddGsMemSlot</a>( 464, 8, GS::kPsm32 );
00574    <a class="code" href="group__gs__mem__slots.html#a21">pglAddGsMemSlot</a>( 472, 8, GS::kPsm32 );
00575    <font class="comment">// 256x256</font>
00576    <a class="code" href="group__gs__mem__slots.html#a21">pglAddGsMemSlot</a>( 480, 32, GS::kPsm32 );
00577 
00578    <a class="code" href="group__gs__mem.html#a0">pglPrintGsMemAllocation</a>();
00579 }
</pre></div><hr><address><small>ps2gl version cvs</small></address>
