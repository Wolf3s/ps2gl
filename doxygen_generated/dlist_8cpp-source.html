<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>dlist.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.11 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>dlist.cpp</h1><a href="dlist_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*        Copyright (C) 2000,2001,2002  Sony Computer Entertainment America</font>
00002           
00003           This file is subject to the terms and conditions of the GNU Lesser
00004           General Public License Version 2.1. See the file "COPYING" in the
00005           main directory of this archive for more details.                             */
00006 
00007 <font class="preprocessor">#include "<a class="code" href="dlist_8h.html">ps2gl/dlist.h</a>"</font>
00008 <font class="preprocessor">#include "<a class="code" href="glcontext_8h.html">ps2gl/glcontext.h</a>"</font>
00009 <font class="preprocessor">#include "<a class="code" href="immgmanager_8h.html">ps2gl/immgmanager.h</a>"</font>
00010 
00011 <font class="comment">/********************************************</font>
00012  * CDList
00013  */
00014 
<a name="l00015"></a><a class="code" href="classCDList.html#a0">00015</a> <a class="code" href="classCDList.html#a0">CDList::CDList</a>()
00016    : VertexBuf(NULL), NormalBuf(NULL), TexCoordBuf(NULL), ColorBuf(NULL),
00017      NumRenderPackets(0)
00018 {
00019 <font class="preprocessor">#ifndef PS2_LINUX</font>
00020    FlushCache(0); <font class="comment">// hopefully we're not allocating these buffers too often..</font>
00021 <font class="preprocessor">#endif</font>
00022    FirstCmdBlock = CurCmdBlock = <font class="keyword">new</font> <a class="code" href="classCDListCmdBlock.html">CDListCmdBlock</a>;
00023 }
00024 
<a name="l00025"></a><a class="code" href="classCDList.html#a1">00025</a> <a class="code" href="classCDList.html#a1">CDList::~CDList</a>()<font class="keyword"></font>
00026 {
00027    <font class="keywordflow">if</font> ( VertexBuf ) <font class="keyword">delete</font> VertexBuf;
00028    <font class="keywordflow">if</font> ( NormalBuf ) <font class="keyword">delete</font> NormalBuf;
00029    <font class="keywordflow">if</font> ( TexCoordBuf ) <font class="keyword">delete</font> TexCoordBuf;
00030    <font class="keywordflow">if</font> ( ColorBuf ) <font class="keyword">delete</font> ColorBuf;
00031 
00032    <font class="comment">// this will get them all</font>
00033    <font class="keyword">delete</font> FirstCmdBlock;
00034    <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; NumRenderPackets; i++ )
00035       <font class="keyword">delete</font> RenderPackets[i];
00036 }
00037 
00038 <font class="keywordtype">void</font>
<a name="l00039"></a><a class="code" href="classCDList.html#a5">00039</a> <a class="code" href="classCDList.html#a5">CDList::Begin</a>()<font class="keyword"></font>
00040 {
00041 }
00042 
00043 CDmaPacket&amp;
<a name="l00044"></a><a class="code" href="classCDList.html#a7">00044</a> <a class="code" href="classCDList.html#a7">CDList::GetVertexBuf</a>()<font class="keyword"></font>
00045 {
00046    <font class="keywordflow">if</font> ( VertexBuf == NULL )
00047       VertexBuf = <font class="keyword">new</font> CDmaPacket( kBufferMaxQwordLength, DMAC::Channels::vif1,
00048                                   Core::MemMappings::UncachedAccl );
00049    <font class="keywordflow">return</font> *VertexBuf;
00050 }
00051 
00052 CDmaPacket&amp;
<a name="l00053"></a><a class="code" href="classCDList.html#a8">00053</a> <a class="code" href="classCDList.html#a8">CDList::GetNormalBuf</a>()<font class="keyword"></font>
00054 {
00055    <font class="keywordflow">if</font> ( NormalBuf == NULL )
00056       NormalBuf = <font class="keyword">new</font> CDmaPacket( kBufferMaxQwordLength, DMAC::Channels::vif1,
00057                                   Core::MemMappings::UncachedAccl );
00058    <font class="keywordflow">return</font> *NormalBuf;
00059 }
00060 
00061 CDmaPacket&amp;
<a name="l00062"></a><a class="code" href="classCDList.html#a9">00062</a> <a class="code" href="classCDList.html#a9">CDList::GetTexCoordBuf</a>()<font class="keyword"></font>
00063 {
00064    <font class="keywordflow">if</font> ( TexCoordBuf == NULL )
00065       TexCoordBuf = <font class="keyword">new</font> CDmaPacket( kBufferMaxQwordLength, DMAC::Channels::vif1,
00066                                     Core::MemMappings::UncachedAccl );
00067    <font class="keywordflow">return</font> *TexCoordBuf;
00068 }
00069 
00070 CDmaPacket&amp;
<a name="l00071"></a><a class="code" href="classCDList.html#a10">00071</a> <a class="code" href="classCDList.html#a10">CDList::GetColorBuf</a>()<font class="keyword"></font>
00072 {
00073    <font class="keywordflow">if</font> ( ColorBuf == NULL )
00074       ColorBuf = <font class="keyword">new</font> CDmaPacket( kBufferMaxQwordLength, DMAC::Channels::vif1,
00075                                  Core::MemMappings::UncachedAccl );
00076    <font class="keywordflow">return</font> *ColorBuf;
00077 }
00078 
00079 <font class="comment">/********************************************</font>
00080  * CDListManager
00081  */
00082 
00083 <font class="keywordtype">void</font>
<a name="l00084"></a><a class="code" href="classCDListManager.html#a2">00084</a> <a class="code" href="classCDListManager.html#a2">CDListManager::SwapBuffers</a>()<font class="keyword"></font>
00085 {
00086    CurBuffer = 1 - CurBuffer;
00087    <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; NumListsToBeFreed[CurBuffer]; i++ )
00088       <font class="keyword">delete</font> ListsToBeFreed[CurBuffer][i];
00089    NumListsToBeFreed[CurBuffer] = 0;
00090 }
00091 
00092 <font class="keywordtype">bool</font>
00093 CDListManager::ListsAreFree( <font class="keywordtype">int</font> firstListID, <font class="keywordtype">int</font> numLists )<font class="keyword"></font>
00094 {
00095    <font class="keywordtype">bool</font> listsAreFree = <font class="keyword">true</font>;
00096    <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; numLists; i++ )
00097       <font class="keywordflow">if</font> ( Lists[firstListID + i] != NULL )
00098          listsAreFree = <font class="keyword">false</font>;
00099    <font class="keywordflow">return</font> listsAreFree;
00100 }
00101 
00102 <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>
<a name="l00103"></a><a class="code" href="classCDListManager.html#a3">00103</a> <a class="code" href="classCDListManager.html#a3">CDListManager::GenLists</a>( <font class="keywordtype">int</font> numLists )<font class="keyword"></font>
00104 {
00105    <font class="comment">// very temporary..</font>
00106    <font class="keywordtype">int</font> firstID = NextFreeListID;
00107 
00108    mErrorIf( ! ListsAreFree(NextFreeListID, numLists),
00109              <font class="stringliteral">"Uh-oh.. time to write some real display list management code."</font> );
00110 
00111    NextFreeListID += numLists;
00112 
00113    <font class="comment">// wrap around and hope for the best.. (relying on ListsAreFree to do error checking)</font>
00114    <font class="keywordflow">if</font> ( NextFreeListID == kMaxListID - 1 )
00115       NextFreeListID = 1;
00116 
00117    mErrorIf( NextFreeListID &gt;= kMaxListID, <font class="stringliteral">"Ran out of lists.. time to rewrite this code."</font> );
00118 
00119    <font class="keywordflow">return</font> firstID;
00120 }
00121 
00122 <font class="keywordtype">void</font>
<a name="l00123"></a><a class="code" href="classCDListManager.html#a4">00123</a> <a class="code" href="classCDListManager.html#a4">CDListManager::DeleteLists</a>( <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> firstListID, <font class="keywordtype">int</font> numLists )<font class="keyword"></font>
00124 {
00125    <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; numLists; i++ ) {
00126       <font class="keywordflow">if</font> ( Lists[firstListID + i] ) {
00127          <font class="comment">// don't delete the dlist immediately -- it might not have been dma'ed yet..</font>
00128          AddListToBeFreed( Lists[firstListID + i] );
00129          Lists[firstListID + i] = NULL;
00130       }
00131    }
00132 }
00133 
00134 <font class="keywordtype">void</font>
<a name="l00135"></a><a class="code" href="classCDListManager.html#a5">00135</a> <a class="code" href="classCDListManager.html#a5">CDListManager::NewList</a>( <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> listID, <a class="code" href="gl_8h.html#a687">GLenum</a> mode )<font class="keyword"></font>
00136 {
00137    mWarnIf( mode == <a class="code" href="gl_8h.html#a99">GL_COMPILE_AND_EXECUTE</a>,
00138             <font class="stringliteral">"GL_COMPILE_AND_EXECUTE is not yet supported"</font> );
00139 
00140    OpenListID = listID;
00141    OpenList = <font class="keyword">new</font> <a class="code" href="classCDList.html">CDList</a>;
00142    OpenList-&gt;<a class="code" href="classCDList.html#a5">Begin</a>();
00143 }
00144 
00145 <font class="keywordtype">void</font>
<a name="l00146"></a><a class="code" href="classCDListManager.html#a6">00146</a> <a class="code" href="classCDListManager.html#a6">CDListManager::EndList</a>()<font class="keyword"></font>
00147 {
00148    mErrorIf( OpenListID == 0, <font class="stringliteral">"There is no list to end!"</font> );
00149 
00150    <font class="keywordflow">if</font> ( Lists[OpenListID] ) AddListToBeFreed( Lists[OpenListID] );
00151    Lists[OpenListID] = OpenList;
00152    Lists[OpenListID]-&gt;<a class="code" href="classCDList.html#a6">End</a>();
00153    OpenListID = 0;
00154    OpenList = NULL;
00155 }
00156 
<a name="l00157"></a><a class="code" href="classCCallListCmd.html">00157</a> <font class="keyword">class </font><a class="code" href="classCCallListCmd.html">CCallListCmd</a> : <font class="keyword">public</font> <a class="code" href="classCDListCmd.html">CDListCmd</a> {
00158       <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>      ListID;
00159    <font class="keyword">public</font>:
<a name="l00160"></a><a class="code" href="classCCallListCmd.html#a0">00160</a>       <a class="code" href="classCCallListCmd.html#a0">CCallListCmd</a>( <font class="keywordtype">unsigned</font> listID ) : ListID(listID) {}
<a name="l00161"></a><a class="code" href="classCCallListCmd.html#a1">00161</a>       <a class="code" href="classCDListCmd.html">CDListCmd</a>* <a class="code" href="classCDListCmd.html#a1">Play</a>()<font class="keyword"> </font>{
00162          pGLContext-&gt;GetDListManager().CallList( ListID );
00163          <font class="keywordflow">return</font> <a class="code" href="classCDListCmd.html#d1">CDListCmd::GetNextCmd</a>( <font class="keyword">this</font> );
00164       }
00165 };
00166 
00167 <font class="keywordtype">void</font>
<a name="l00168"></a><a class="code" href="classCDListManager.html#a7">00168</a> <a class="code" href="classCDListManager.html#a7">CDListManager::CallList</a>( <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> listID )<font class="keyword"></font>
00169 {
00170    <font class="keywordflow">if</font> ( OpenListID != 0 ) {
00171       <font class="comment">// we're inside a list definition, so add the call to listID to the open list</font>
00172       *OpenList += CCallListCmd( listID );
00173    }
00174    <font class="keywordflow">else</font> {
00175       mErrorIf( Lists[listID] == NULL, <font class="stringliteral">"List does not exist."</font> );
00176       pGLContext-&gt;GetImmGeomManager().Flush();
00177       Lists[listID]-&gt;<a class="code" href="classCDList.html#a4">Play</a>();
00178    }
00179 }
00180 
00181 
00182 <font class="comment">/********************************************</font>
00183  * gl api
00184  */
00185 
<a name="l00186"></a><a class="code" href="dlist_8cpp.html#a770">00186</a> <a class="code" href="gl_8h.html#a696">GLuint</a> <a class="code" href="gl_8h.html#a770">glGenLists</a>( <a class="code" href="gl_8h.html#a697">GLsizei</a> range )<font class="keyword"></font>
00187 {
00188    <font class="keywordflow">return</font> pGLContext-&gt;GetDListManager().GenLists( range );
00189 }
00190 
<a name="l00191"></a><a class="code" href="dlist_8cpp.html#a769">00191</a> <font class="keywordtype">void</font> <a class="code" href="gl_8h.html#a769">glDeleteLists</a>( <a class="code" href="gl_8h.html#a696">GLuint</a> list, <a class="code" href="gl_8h.html#a697">GLsizei</a> range )<font class="keyword"></font>
00192 {
00193    pGLContext-&gt;GetDListManager().DeleteLists( list, range );
00194 }
00195 
<a name="l00196"></a><a class="code" href="dlist_8cpp.html#a771">00196</a> <font class="keywordtype">void</font> <a class="code" href="gl_8h.html#a771">glNewList</a>( <a class="code" href="gl_8h.html#a696">GLuint</a> listID, <a class="code" href="gl_8h.html#a687">GLenum</a> mode )<font class="keyword"></font>
00197 {
00198    pGLContext-&gt;BeginDListDef( listID, mode );
00199 }
00200 
<a name="l00201"></a><a class="code" href="dlist_8cpp.html#a772">00201</a> <font class="keywordtype">void</font> <a class="code" href="dlist_8cpp.html#a3">glEndList</a>( <font class="keywordtype">void</font> )<font class="keyword"></font>
00202 {
00203    pGLContext-&gt;EndDListDef();
00204 }
00205 
<a name="l00206"></a><a class="code" href="dlist_8cpp.html#a773">00206</a> <font class="keywordtype">void</font> <a class="code" href="gl_8h.html#a773">glCallList</a>( <a class="code" href="gl_8h.html#a696">GLuint</a> listID )<font class="keyword"></font>
00207 {
00208    pGLContext-&gt;GetDListManager().CallList( listID );
00209 }
</pre></div><hr><address><small>ps2gl version cvs</small></address>
