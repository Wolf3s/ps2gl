<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pads.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.11 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>pads.cpp</h1><a href="pads_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*        Copyright (C) 2000,2001,2002  Sony Computer Entertainment America</font>
00002           
00003           This file is subject to the terms and conditions of the GNU Lesser
00004           General Public License Version 2.1. See the file "COPYING" in the
00005           main directory of this archive for more details.                             */
00006 
00007 <font class="comment">/********************************************</font>
00008  * includes
00009  */
00010 
00011 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00012 <font class="preprocessor">#include &lt;string.h&gt;</font>
00013 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00014 
00015 <font class="preprocessor">#include "eetypes.h"</font>
00016 <font class="preprocessor">#include "sifdev.h"</font>
00017 <font class="preprocessor">#include "sifrpc.h"</font>
00018 
00019 <font class="preprocessor">#include "<a class="code" href="pads_8h.html">pads.h</a>"</font>
00020 <font class="preprocessor">#include "ps2s/math.h"</font>
00021 
00022 <font class="comment">/********************************************</font>
00023  * constants
00024  */
00025 
<a name="l00026"></a><a class="code" href="pads_8cpp.html#a0">00026</a> <font class="preprocessor">#define kPad0   0</font>
<a name="l00027"></a><a class="code" href="pads_8cpp.html#a1">00027</a> <font class="preprocessor">#define kPad1   1</font>
00028 
<a name="l00029"></a><a class="code" href="pads_8cpp.html#a2">00029</a> <font class="preprocessor">#define kPort0  0</font>
<a name="l00030"></a><a class="code" href="pads_8cpp.html#a3">00030</a> <font class="preprocessor">#define kSlot0  0</font>
00031 
<a name="l00032"></a><a class="code" href="pads_8cpp.html#a4">00032</a> <font class="preprocessor">#define kPadModeStandard 0x4</font>
<a name="l00033"></a><a class="code" href="pads_8cpp.html#a5">00033</a> <font class="preprocessor">#define kPadModeAnalog   0x7</font>
00034 
<a name="l00035"></a><a class="code" href="pads_8cpp.html#a6">00035</a> <font class="preprocessor">#define kPadSetLockModeUnchanged 0</font>
<a name="l00036"></a><a class="code" href="pads_8cpp.html#a7">00036</a> <font class="preprocessor">#define kPadSetLockModeLock 3</font>
<a name="l00037"></a><a class="code" href="pads_8cpp.html#a8">00037</a> <font class="preprocessor">#define kPadSetLockModeUnlock 1</font>
00038 
<a name="l00039"></a><a class="code" href="pads_8cpp.html#a9">00039</a> <font class="preprocessor">#define kStickMaxRadius 120</font>
<a name="l00040"></a><a class="code" href="pads_8cpp.html#a10">00040</a> <font class="preprocessor">#define kStickDeadRadius 25</font>
00041 
00042 <font class="comment">/********************************************</font>
00043  * globals
00044  */
00045 
00046 <a class="code" href="classCPad.html">CPad</a> <a class="code" href="pads_8cpp.html#a11">Pad0</a>( <a class="code" href="pads_8cpp.html#a0">kPad0</a> );
00047 <a class="code" href="classCPad.html">CPad</a> <a class="code" href="pads_8cpp.html#a12">Pad1</a>( <a class="code" href="pads_8cpp.html#a1">kPad1</a> );
00048 
00049 <font class="comment">/********************************************</font>
00050  * Pads
00051  */
00052 
00053 <font class="keywordtype">void</font>
<a name="l00054"></a><a class="code" href="namespacePads.html#a16">00054</a> <a class="code" href="namespacePads.html#a16">Pads::Init</a>( <font class="keyword">const</font> <font class="keywordtype">char</font>* module_path )<font class="keyword"></font>
00055 {
00056    <font class="keywordtype">char</font> temp_buffer[256];
00057    <font class="keywordtype">int</font> module_path_len = strlen(module_path);
00058 
00059    <font class="comment">// open the pads.. this should be elsewhere..</font>
00060    sceSifInitRpc(0);
00061 
00062    <font class="comment">/* load sio2man.irx */</font>
00063    strncpy( temp_buffer, module_path, 256 );
00064    <font class="keywordflow">if</font> (temp_buffer[module_path_len-1] == <font class="charliteral">'/'</font>)
00065       temp_buffer[module_path_len-1] = <font class="charliteral">'\0'</font>;
00066    strncat( temp_buffer, <font class="stringliteral">"/sio2man.irx"</font>, 256-strlen(temp_buffer) );
00067    <font class="keywordflow">if</font> (sceSifLoadModule(temp_buffer, 0, NULL) &lt; 0)<font class="keyword"></font>
00068    {
00069       printf(<font class="stringliteral">"Can't load module sio2man\n"</font>);
00070       exit(0);
00071    }
00072    <font class="comment">/* load padman.irx */</font>
00073    strncpy( temp_buffer, module_path, 256 );
00074    <font class="keywordflow">if</font> (temp_buffer[module_path_len-1] == <font class="charliteral">'/'</font>)
00075       temp_buffer[module_path_len-1] = <font class="charliteral">'\0'</font>;
00076    strncat( temp_buffer, <font class="stringliteral">"/padman.irx"</font>, 256-strlen(temp_buffer) );
00077    <font class="keywordflow">if</font> (sceSifLoadModule(temp_buffer,0, NULL) &lt; 0)<font class="keyword"></font>
00078    {
00079       printf(<font class="stringliteral">"Can't load module padman\n"</font>);
00080       exit(0);
00081    }
00082 
00083    scePadInit(0); <font class="comment">// "must be zero"</font>
00084 
00085    <font class="keywordflow">if</font> ( ! Pad0.<a class="code" href="classCPad.html#a1">Open</a>() ) {
00086       printf(<font class="stringliteral">"Couldn't open Pad0.\n"</font>);
00087       exit(-1);
00088    }
00089 }
00090 
00091 <font class="keywordtype">void</font>
<a name="l00092"></a><a class="code" href="namespacePads.html#a17">00092</a> <a class="code" href="namespacePads.html#a17">Pads::Read</a>( <font class="keywordtype">void</font> )<font class="keyword"></font>
00093 {
00094    Pad0.<a class="code" href="classCPad.html#a2">Read</a>();
00095 }
00096 
00097 <font class="comment">/********************************************</font>
00098  * CPad
00099  */
00100 
<a name="l00101"></a><a class="code" href="classCPad.html#a0">00101</a> <a class="code" href="classCPad.html#a0">CPad::CPad</a>( <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> port )
00102    : uiPort(port), bPadModeSet(false)
00103 {
00104    memset( &amp;CurStatus, 0, <font class="keyword">sizeof</font>(tPadStatus) );
00105    memset( &amp;LastStatus, 0, <font class="keyword">sizeof</font>(tPadStatus) );
00106 }
00107 
00108 <font class="keywordtype">bool</font>
<a name="l00109"></a><a class="code" href="classCPad.html#a1">00109</a> <a class="code" href="classCPad.html#a1">CPad::Open</a>( <font class="keywordtype">void</font> )<font class="keyword"></font>
00110 {
00111    <font class="comment">// slot is only for use with multitap</font>
00112    <font class="keywordflow">return</font> scePadPortOpen(uiPort, <a class="code" href="pads_8cpp.html#a3">kSlot0</a>, DmaBuffer);
00113 }
00114 
00115 <font class="keywordtype">void</font>
<a name="l00116"></a><a class="code" href="classCPad.html#a2">00116</a> <a class="code" href="classCPad.html#a2">CPad::Read</a>( <font class="keywordtype">void</font> )<font class="keyword"></font>
00117 {
00118    t32 padState = scePadGetState( <a class="code" href="pads_8cpp.html#a2">kPort0</a>, <a class="code" href="pads_8cpp.html#a3">kSlot0</a> );
00119    <font class="keywordflow">if</font> ( padState != scePadStateStable ) <font class="keywordflow">return</font>;
00120         
00121    <font class="keywordflow">if</font> ( !bPadModeSet ) {
00122       <font class="comment">// who knows what the 1 parameter is..  a return val of 1 indicates that the request is</font>
00123       <font class="comment">// being processed</font>
00124       <font class="keywordflow">if</font> ( scePadSetMainMode(uiPort, <a class="code" href="pads_8cpp.html#a3">kSlot0</a>, 1, <a class="code" href="pads_8cpp.html#a8">kPadSetLockModeUnlock</a>) == 1 )
00125          bPadModeSet = <font class="keyword">true</font>;
00126    }
00127    <font class="keywordflow">else</font> {
00128       tPadStatus padStatus;
00129       scePadRead( uiPort, <a class="code" href="pads_8cpp.html#a3">kSlot0</a>, (tU8*)&amp;padStatus );
00130 
00131       <font class="keywordflow">if</font> ( padStatus.success == 0 ) { <font class="comment">// 0 indicates success</font>
00132          LastStatus = CurStatus;
00133          padStatus.rightStick = CurStatus.rightStick;
00134          padStatus.leftStick = CurStatus.leftStick;
00135          CurStatus = padStatus;
00136 
00137          t32 id = scePadInfoMode( uiPort, <a class="code" href="pads_8cpp.html#a3">kSlot0</a>, InfoModeCurID, 0 );
00138          <font class="keywordflow">if</font> ( id == <a class="code" href="pads_8cpp.html#a4">kPadModeStandard</a> || id == <a class="code" href="pads_8cpp.html#a5">kPadModeAnalog</a> ) {
00139                                 <font class="comment">// flip the sense of the bit field (1 = pressed)</font>
00140             CurStatus.buttons ^= 0xffff;
00141          }
00142 
00143          <font class="comment">// sticks</font>
00144          <font class="keywordflow">if</font> ( <a class="code" href="classCPad.html#a5">WasPushed</a>( Pads::kRightStickButton ) )<font class="keyword"> </font>{
00145             CurStatus.leftStick.isCentered = <font class="keyword">false</font>;
00146             CurStatus.rightStick.isCentered = <font class="keyword">false</font>;
00147          }
00148          CurStatus.leftStick.xVal = CurStatus.l3h;
00149          CurStatus.leftStick.yVal = CurStatus.l3v;
00150          CurStatus.rightStick.xVal = CurStatus.r3h;
00151          CurStatus.rightStick.yVal = CurStatus.r3v;
00152          UpdateStick( &amp;CurStatus.leftStick, &amp;LastStatus.leftStick );
00153          UpdateStick( &amp;CurStatus.rightStick, &amp;LastStatus.rightStick );
00154       }
00155    }
00156 }
00157 
00158 <font class="keywordtype">bool</font>
00159 CPad::UpdateStick( tStickData* stickCur, tStickData* stickLast )<font class="keyword"></font>
00160 {
00161    t8 temp;
00162    <font class="keywordtype">bool</font> isChanged = <font class="keyword">false</font>;
00163 
00164    <font class="keyword">using</font> <font class="keyword">namespace </font>Math;
00165 
00166    <font class="keywordflow">if</font> ( ! stickCur-&gt;isCentered ) {
00167       stickCur-&gt;xCenter = stickCur-&gt;xVal;
00168       stickCur-&gt;yCenter = stickCur-&gt;yVal;
00169       stickCur-&gt;xPos = 0.0f;
00170       stickCur-&gt;yPos = 0.0f;
00171       stickCur-&gt;isCentered = <font class="keyword">true</font>;
00172 
00173       isChanged = <font class="keyword">true</font>;
00174    }
00175    <font class="keywordflow">else</font> {
00176       <font class="keywordflow">if</font> ( !FuzzyEqualsi(stickCur-&gt;xVal, stickCur-&gt;xCenter, <a class="code" href="pads_8cpp.html#a10">kStickDeadRadius</a>) )<font class="keyword"> </font>{
00177          <font class="comment">// stick is not inside the dead zone</font>
00178          temp = ((stickCur-&gt;xVal &gt; stickCur-&gt;xCenter) ? -<a class="code" href="pads_8cpp.html#a10">kStickDeadRadius</a> : <a class="code" href="pads_8cpp.html#a10">kStickDeadRadius</a>);
00179          stickCur-&gt;xPos = (float)(stickCur-&gt;xVal - stickCur-&gt;xCenter + temp) /
00180             (float)<a class="code" href="pads_8cpp.html#a9">kStickMaxRadius</a>;
00181          isChanged = TRUE;
00182       }
00183       <font class="keywordflow">else</font> {
00184          <font class="comment">// stick is inside the dead zone</font>
00185          stickCur-&gt;xPos = 0.0f;
00186          <font class="comment">// if it just entered the dead zone, send out one last event</font>
00187          <font class="keywordflow">if</font> ( !FuzzyEqualsi(stickLast-&gt;xVal, stickCur-&gt;xCenter, <a class="code" href="pads_8cpp.html#a10">kStickDeadRadius</a>) )
00188             isChanged = <font class="keyword">true</font>;
00189       }
00190       <font class="keywordflow">if</font> ( !FuzzyEqualsi(stickCur-&gt;yVal, stickCur-&gt;yCenter, <a class="code" href="pads_8cpp.html#a10">kStickDeadRadius</a>) )<font class="keyword"> </font>{
00191          <font class="comment">// stick is not inside the dead zone</font>
00192          temp = (stickCur-&gt;yVal &gt; stickCur-&gt;yCenter) ? <a class="code" href="pads_8cpp.html#a10">kStickDeadRadius</a> : -<a class="code" href="pads_8cpp.html#a10">kStickDeadRadius</a>;
00193          stickCur-&gt;yPos = (float)(stickCur-&gt;yCenter - stickCur-&gt;yVal + temp) /
00194             (float)<a class="code" href="pads_8cpp.html#a9">kStickMaxRadius</a>;
00195          isChanged = <font class="keyword">true</font>;
00196       }
00197       <font class="keywordflow">else</font> {
00198          <font class="comment">// stick is inside the dead zone</font>
00199          stickCur-&gt;yPos = 0.0f;
00200          <font class="comment">// if it just entered the dead zone, send out one last event</font>
00201          <font class="keywordflow">if</font> ( !FuzzyEqualsi(stickLast-&gt;yVal, stickCur-&gt;yCenter, <a class="code" href="pads_8cpp.html#a10">kStickDeadRadius</a>) )
00202             isChanged = <font class="keyword">true</font>;
00203       }
00204 
00205       stickCur-&gt;xPos = Clamp( stickCur-&gt;xPos, -1.0f, 1.0f );
00206       stickCur-&gt;yPos = Clamp( stickCur-&gt;yPos, -1.0f, 1.0f );
00207    }
00208 
00209    <font class="keywordflow">return</font> isChanged;
00210 }
00211 
00212 <font class="keywordtype">bool</font>
<a name="l00213"></a><a class="code" href="classCPad.html#a3">00213</a> <a class="code" href="classCPad.html#a3">CPad::IsDown</a>( <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> button )<font class="keyword"></font>
00214 {
00215    <font class="keywordflow">return</font> CurStatus.buttons &amp; (1 &lt;&lt; button);
00216 }
00217 
00218 <font class="keywordtype">bool</font>
<a name="l00219"></a><a class="code" href="classCPad.html#a4">00219</a> <a class="code" href="classCPad.html#a4">CPad::IsUp</a>( <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> button )<font class="keyword"></font>
00220 {
00221    <font class="keywordflow">return</font> ! (CurStatus.buttons &amp; (1 &lt;&lt; button));
00222 }
00223 
00224 <font class="keywordtype">bool</font>
<a name="l00225"></a><a class="code" href="classCPad.html#a5">00225</a> <a class="code" href="classCPad.html#a5">CPad::WasPushed</a>( <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> button )<font class="keyword"></font>
00226 {
00227    <font class="keywordflow">return</font> (CurStatus.buttons &amp; (1 &lt;&lt; button)) &amp;&amp; ! (LastStatus.buttons &amp; (1 &lt;&lt; button));
00228 }
00229 
00230 <font class="keywordtype">bool</font>
<a name="l00231"></a><a class="code" href="classCPad.html#a6">00231</a> <a class="code" href="classCPad.html#a6">CPad::WasReleased</a>( <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> button )<font class="keyword"></font>
00232 {
00233    <font class="keywordflow">return</font> ! ((CurStatus.buttons &amp; (1 &lt;&lt; button)) &amp;&amp; ! (LastStatus.buttons &amp; (1 &lt;&lt; button)));
00234 }
00235 
</pre></div><hr><address><small>ps2gl version cvs</small></address>
