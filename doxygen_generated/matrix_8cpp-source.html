<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>matrix.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.11 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>matrix.cpp</h1><a href="matrix_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*        Copyright (C) 2000,2001,2002  Sony Computer Entertainment America</font>
00002           
00003           This file is subject to the terms and conditions of the GNU Lesser
00004           General Public License Version 2.1. See the file "COPYING" in the
00005           main directory of this archive for more details.                             */
00006 
00007 <font class="preprocessor">#include "ps2s/math.h"</font>
00008 
00009 <font class="preprocessor">#include "<a class="code" href="matrix_8h.html">ps2gl/matrix.h</a>"</font>
00010 <font class="preprocessor">#include "<a class="code" href="glcontext_8h.html">ps2gl/glcontext.h</a>"</font>
00011 <font class="preprocessor">#include "<a class="code" href="dlist_8h.html">ps2gl/dlist.h</a>"</font>
00012 <font class="preprocessor">#include "<a class="code" href="immgmanager_8h.html">ps2gl/immgmanager.h</a>"</font>
00013 <font class="preprocessor">#include "<a class="code" href="dlgmanager_8h.html">ps2gl/dlgmanager.h</a>"</font>
00014 
00015 <font class="comment">/********************************************</font>
00016  * CDListMatrixStack
00017  */
00018 
00019 
<a name="l00020"></a><a class="code" href="classCMatrixPopCmd.html">00020</a> <font class="keyword">class </font><a class="code" href="classCMatrixPopCmd.html">CMatrixPopCmd</a> : <font class="keyword">public</font> <a class="code" href="classCDListCmd.html">CDListCmd</a> {
00021    <font class="keyword">public</font>:
<a name="l00022"></a><a class="code" href="classCMatrixPopCmd.html#a0">00022</a>       <a class="code" href="classCMatrixPopCmd.html#a0">CMatrixPopCmd</a>()<font class="keyword"> </font>{}
<a name="l00023"></a><a class="code" href="classCMatrixPopCmd.html#a1">00023</a>       <a class="code" href="classCDListCmd.html">CDListCmd</a>* <a class="code" href="classCDListCmd.html#a1">Play</a>()<font class="keyword"> </font>{ <a class="code" href="matrix_8cpp.html#a3">glPopMatrix</a>(); <font class="keywordflow">return</font> <a class="code" href="classCDListCmd.html#d1">CDListCmd::GetNextCmd</a>(<font class="keyword">this</font>); }
00024 };
00025 
00026 <font class="keywordtype">void</font>
<a name="l00027"></a><a class="code" href="classCDListMatrixStack.html#a1">00027</a> <a class="code" href="classCDListMatrixStack.html#a1">CDListMatrixStack::Pop</a>()<font class="keyword"></font>
00028 {
00029    GLContext.GetDListGeomManager().Flush();
00030    GLContext.GetDListManager().GetOpenDList() += CMatrixPopCmd();
00031    GLContext.XformChanged();
00032 }
00033 
<a name="l00034"></a><a class="code" href="classCMatrixPushCmd.html">00034</a> <font class="keyword">class </font><a class="code" href="classCMatrixPushCmd.html">CMatrixPushCmd</a> : <font class="keyword">public</font> <a class="code" href="classCDListCmd.html">CDListCmd</a> {
00035    <font class="keyword">public</font>:
<a name="l00036"></a><a class="code" href="classCMatrixPushCmd.html#a0">00036</a>       <a class="code" href="classCMatrixPushCmd.html#a0">CMatrixPushCmd</a>()<font class="keyword"> </font>{}
<a name="l00037"></a><a class="code" href="classCMatrixPushCmd.html#a1">00037</a>       <a class="code" href="classCDListCmd.html">CDListCmd</a>* <a class="code" href="classCDListCmd.html#a1">Play</a>()<font class="keyword"> </font>{ <a class="code" href="matrix_8cpp.html#a2">glPushMatrix</a>(); <font class="keywordflow">return</font> <a class="code" href="classCDListCmd.html#d1">CDListCmd::GetNextCmd</a>(<font class="keyword">this</font>); }
00038 };
00039 
00040 <font class="keywordtype">void</font>
<a name="l00041"></a><a class="code" href="classCDListMatrixStack.html#a2">00041</a> <a class="code" href="classCDListMatrixStack.html#a2">CDListMatrixStack::Push</a>()<font class="keyword"></font>
00042 {
00043    GLContext.GetDListManager().GetOpenDList() += CMatrixPushCmd();
00044 }
00045 
<a name="l00046"></a><a class="code" href="classCMatrixConcatCmd.html">00046</a> <font class="keyword">class </font><a class="code" href="classCMatrixConcatCmd.html">CMatrixConcatCmd</a> : <font class="keyword">public</font> <a class="code" href="classCDListCmd.html">CDListCmd</a> {
00047       cpu_mat_44        Matrix, Inverse;
00048    <font class="keyword">public</font>:
<a name="l00049"></a><a class="code" href="classCMatrixConcatCmd.html#a0">00049</a>       <a class="code" href="classCMatrixConcatCmd.html#a0">CMatrixConcatCmd</a>( <font class="keyword">const</font> cpu_mat_44 &amp;mat, <font class="keyword">const</font> cpu_mat_44 &amp;inv )
00050          : Matrix(mat), Inverse(inv) {}
<a name="l00051"></a><a class="code" href="classCMatrixConcatCmd.html#a1">00051</a>       <a class="code" href="classCDListCmd.html">CDListCmd</a>* <a class="code" href="classCDListCmd.html#a1">Play</a>()<font class="keyword"> </font>{
00052          pGLContext-&gt;GetCurMatrixStack().Concat( Matrix, Inverse );
00053          <font class="keywordflow">return</font> <a class="code" href="classCDListCmd.html#d1">CDListCmd::GetNextCmd</a>(<font class="keyword">this</font>);
00054       }
00055 };
00056 
00057 <font class="keywordtype">void</font>
<a name="l00058"></a><a class="code" href="classCDListMatrixStack.html#a3">00058</a> <a class="code" href="classCDListMatrixStack.html#a3">CDListMatrixStack::Concat</a>( <font class="keyword">const</font> cpu_mat_44&amp; xform, <font class="keyword">const</font> cpu_mat_44&amp; inverse )<font class="keyword"></font>
00059 {
00060    GLContext.GetDListGeomManager().Flush();
00061    GLContext.GetDListManager().GetOpenDList() += CMatrixConcatCmd( xform, inverse );
00062    GLContext.XformChanged();
00063 }
00064 
<a name="l00065"></a><a class="code" href="classCMatrixSetTopCmd.html">00065</a> <font class="keyword">class </font><a class="code" href="classCMatrixSetTopCmd.html">CMatrixSetTopCmd</a> : <font class="keyword">public</font> <a class="code" href="classCDListCmd.html">CDListCmd</a> {
00066       cpu_mat_44        Matrix, Inverse;
00067    <font class="keyword">public</font>:
<a name="l00068"></a><a class="code" href="classCMatrixSetTopCmd.html#a0">00068</a>       <a class="code" href="classCMatrixSetTopCmd.html#a0">CMatrixSetTopCmd</a>( <font class="keyword">const</font> cpu_mat_44 &amp;mat, <font class="keyword">const</font> cpu_mat_44 &amp;inv )
00069          : Matrix(mat), Inverse(inv) {}
<a name="l00070"></a><a class="code" href="classCMatrixSetTopCmd.html#a1">00070</a>       <a class="code" href="classCDListCmd.html">CDListCmd</a>* <a class="code" href="classCDListCmd.html#a1">Play</a>()<font class="keyword"> </font>{
00071          pGLContext-&gt;GetCurMatrixStack().SetTop( Matrix, Inverse );
00072          <font class="keywordflow">return</font> <a class="code" href="classCDListCmd.html#d1">CDListCmd::GetNextCmd</a>(<font class="keyword">this</font>);
00073       }
00074 };
00075 
00076 <font class="keywordtype">void</font>
<a name="l00077"></a><a class="code" href="classCDListMatrixStack.html#a4">00077</a> <a class="code" href="classCDListMatrixStack.html#a4">CDListMatrixStack::SetTop</a>( <font class="keyword">const</font> cpu_mat_44 &amp;newMat, <font class="keyword">const</font> cpu_mat_44 &amp;newInv )<font class="keyword"></font>
00078 {
00079    GLContext.GetDListGeomManager().Flush();
00080    GLContext.GetDListManager().GetOpenDList() += CMatrixSetTopCmd( newMat, newInv );
00081    GLContext.XformChanged();
00082 }
00083 
00084 
00085 <font class="comment">/********************************************</font>
00086  * gl api
00087  */
00088 
<a name="l00089"></a><a class="code" href="matrix_8cpp.html#a751">00089</a> <font class="keywordtype">void</font> <a class="code" href="gl_8h.html#a751">glMatrixMode</a>( <a class="code" href="gl_8h.html#a687">GLenum</a> mode )<font class="keyword"></font>
00090 {
00091    pGLContext-&gt;SetMatrixMode( mode );
00092 }
00093 
<a name="l00094"></a><a class="code" href="matrix_8cpp.html#a757">00094</a> <font class="keywordtype">void</font> <a class="code" href="matrix_8cpp.html#a1">glLoadIdentity</a>( <font class="keywordtype">void</font> )<font class="keyword"></font>
00095 {
00096    <a class="code" href="classCMatrixStack.html">CMatrixStack</a>&amp; matStack = pGLContext-&gt;GetCurMatrixStack();
00097 
00098    cpu_mat_44 ident;
00099    ident.set_identity();
00100    matStack.<a class="code" href="classCMatrixStack.html#a4">SetTop</a>( ident, ident );
00101 }
00102 
<a name="l00103"></a><a class="code" href="matrix_8cpp.html#a755">00103</a> <font class="keywordtype">void</font> <a class="code" href="matrix_8cpp.html#a2">glPushMatrix</a>( <font class="keywordtype">void</font> )<font class="keyword"></font>
00104 {
00105    <a class="code" href="classCMatrixStack.html">CMatrixStack</a>&amp; matStack = pGLContext-&gt;GetCurMatrixStack();
00106    matStack.<a class="code" href="classCMatrixStack.html#a2">Push</a>();
00107 }
00108 
<a name="l00109"></a><a class="code" href="matrix_8cpp.html#a756">00109</a> <font class="keywordtype">void</font> <a class="code" href="matrix_8cpp.html#a3">glPopMatrix</a>( <font class="keywordtype">void</font> )<font class="keyword"></font>
00110 {
00111    <a class="code" href="classCMatrixStack.html">CMatrixStack</a>&amp; matStack = pGLContext-&gt;GetCurMatrixStack();
00112    matStack.<a class="code" href="classCMatrixStack.html#a1">Pop</a>();
00113 }
00114 
00115 <font class="comment">// courtesy the lovely folks at Intel</font>
00116 <font class="keyword">extern</font> <font class="keywordtype">void</font> <a class="code" href="matrix_8cpp.html#a4">Invert2</a>( <font class="keywordtype">float</font> *mat, <font class="keywordtype">float</font> *dst );
00117 
<a name="l00118"></a><a class="code" href="matrix_8cpp.html#a759">00118</a> <font class="keywordtype">void</font> <a class="code" href="gl_8h.html#a759">glLoadMatrixf</a>( <font class="keyword">const</font> <a class="code" href="gl_8h.html#a698">GLfloat</a> *m )<font class="keyword"></font>
00119 {
00120    <a class="code" href="classCMatrixStack.html">CMatrixStack</a>&amp; matStack = pGLContext-&gt;GetCurMatrixStack();
00121    cpu_mat_44 newMat;
00122 
00123    <font class="comment">// unfortunately we can't assume the matrix is qword-aligned</font>
00124    <font class="keywordtype">float</font> *dest = reinterpret_cast&lt;float*&gt;(&amp;newMat);
00125    <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; 16; i++ )
00126       *dest++ = *m++;
00127 
00128    cpu_mat_44 invMatrix;
00129    <a class="code" href="matrix_8cpp.html#a4">Invert2</a>( (<font class="keywordtype">float</font>*)&amp;newMat, (<font class="keywordtype">float</font>*)&amp;invMatrix );
00130 
00131    matStack.<a class="code" href="classCMatrixStack.html#a4">SetTop</a>( newMat, invMatrix );
00132 }
00133 
<a name="l00134"></a><a class="code" href="matrix_8cpp.html#a753">00134</a> <font class="keywordtype">void</font> <a class="code" href="gl_8h.html#a753">glFrustum</a>( <a class="code" href="gl_8h.html#a700">GLdouble</a> left, <a class="code" href="gl_8h.html#a700">GLdouble</a> right,
00135                 <a class="code" href="gl_8h.html#a700">GLdouble</a> bottom, <a class="code" href="gl_8h.html#a700">GLdouble</a> top,
00136                 <a class="code" href="gl_8h.html#a700">GLdouble</a> zNear, <a class="code" href="gl_8h.html#a700">GLdouble</a> zFar )<font class="keyword"></font>
00137 {
00138    cpu_mat_44 xform( cpu_vec_xyzw( (2.0f * zNear)
00139                                    / (right - left),
00140                                    0.0f,
00141                                    0.0f,
00142                                    0.0f ),
00143                      cpu_vec_xyzw( 0.0f,
00144                                    (2.0f * zNear)
00145                                    / (top - bottom),
00146                                    0.0f,
00147                                    0.0f ),
00148                      cpu_vec_xyzw( (right + left)
00149                                    / (right - left),
00150                                    (top + bottom)
00151                                    / (top - bottom),
00152                                    -(zFar + zNear)
00153                                    / (zFar - zNear),
00154                                    -1.0f ),
00155                      cpu_vec_xyzw( 0.0f,
00156                                    0.0f,
00157                                    (-2.0f * zFar * zNear)
00158                                    / (zFar - zNear),
00159                                    0.0f )
00160       );
00161 
00162    cpu_mat_44 inv( cpu_vec_xyzw( (right - left)
00163                                  / (2 * zNear),
00164                                  0,
00165                                  0,
00166                                  0 ),
00167                    cpu_vec_xyzw( 0,
00168                                  (top - bottom)
00169                                  / (2 * zNear),
00170                                  0,
00171                                  0 ),
00172                    cpu_vec_xyzw( 0,
00173                                  0,
00174                                  0,
00175                                  -(zFar - zNear)
00176                                  / (2 * zFar * zNear) ),
00177                    cpu_vec_xyzw( (right + left)
00178                                  / (2 * zNear),
00179                                  (top + bottom)
00180                                  / (2 * zNear),
00181                                  -1,
00182                                  (zFar + zNear)
00183                                  / (2 * zFar * zNear) )
00184       );
00185 
00186    <a class="code" href="classCMatrixStack.html">CMatrixStack</a>&amp; matStack = pGLContext-&gt;GetCurMatrixStack();
00187    matStack.<a class="code" href="classCMatrixStack.html#a3">Concat</a>( xform, inv );
00188 }
00189 
<a name="l00190"></a><a class="code" href="matrix_8cpp.html#a752">00190</a> <font class="keywordtype">void</font> <a class="code" href="gl_8h.html#a752">glOrtho</a>( <a class="code" href="gl_8h.html#a700">GLdouble</a> left, <a class="code" href="gl_8h.html#a700">GLdouble</a> right,
00191               <a class="code" href="gl_8h.html#a700">GLdouble</a> bottom, <a class="code" href="gl_8h.html#a700">GLdouble</a> top,
00192               <a class="code" href="gl_8h.html#a700">GLdouble</a> zNear, <a class="code" href="gl_8h.html#a700">GLdouble</a> zFar )<font class="keyword"></font>
00193 {
00194    cpu_mat_44 xform( cpu_vec_xyzw( (2.0f)
00195                                    / (right - left),
00196                                    0.0f,
00197                                    0.0f,
00198                                    0.0f ),
00199                      cpu_vec_xyzw( 0.0f,
00200                                    (2.0f)
00201                                    / (top - bottom),
00202                                    0.0f,
00203                                    0.0f ),
00204                      cpu_vec_xyzw( 0.0f,
00205                                    0.0f,
00206                                    -2
00207                                    / (zFar - zNear),
00208                                    0.0f ),
00209                      cpu_vec_xyzw( - (right + left)
00210                                    / (right - left),
00211                                    - (top + bottom)
00212                                    / (top - bottom),
00213                                    - (zFar + zNear)
00214                                    / (zFar - zNear),
00215                                    1.0f )
00216       );
00217 
00218    cpu_mat_44 inv( cpu_vec_xyzw( (right - left)
00219                                  / 2,
00220                                  0,
00221                                  0,
00222                                  0 ),
00223                    cpu_vec_xyzw( 0,
00224                                  (top - bottom)
00225                                  / 2,
00226                                  0,
00227                                  0 ),
00228                    cpu_vec_xyzw( 0,
00229                                  0,
00230                                  (zFar - zNear)
00231                                  / -2,
00232                                  0 ),
00233                    cpu_vec_xyzw( (right + left)
00234                                  / 2,
00235                                  (top + bottom)
00236                                  / 2,
00237                                  (zFar + zNear)
00238                                  / 2,
00239                                  1 )
00240       );
00241 
00242    <a class="code" href="classCMatrixStack.html">CMatrixStack</a>&amp; matStack = pGLContext-&gt;GetCurMatrixStack();
00243    matStack.<a class="code" href="classCMatrixStack.html#a3">Concat</a>( xform, inv );
00244 }
00245 
<a name="l00246"></a><a class="code" href="matrix_8cpp.html#a761">00246</a> <font class="keywordtype">void</font> <a class="code" href="gl_8h.html#a761">glMultMatrixf</a>( <font class="keyword">const</font> <a class="code" href="gl_8h.html#a698">GLfloat</a> *m )<font class="keyword"></font>
00247 {
00248    <font class="comment">// unfortunately we can't assume the matrix is qword-aligned</font>
00249    <font class="comment">// the casts to float below fix an apparent parse error... something's up here..</font>
00250    cpu_mat_44 newMatrix( cpu_vec_xyzw( (<font class="keywordtype">float</font>)m[0], (<font class="keywordtype">float</font>)m[1], (<font class="keywordtype">float</font>)m[2], (<font class="keywordtype">float</font>)m[3] ),
00251                          cpu_vec_xyzw( (<font class="keywordtype">float</font>)m[4], (<font class="keywordtype">float</font>)m[5], (<font class="keywordtype">float</font>)m[6], (<font class="keywordtype">float</font>)m[7] ),
00252                          cpu_vec_xyzw( (<font class="keywordtype">float</font>)m[8], (<font class="keywordtype">float</font>)m[9], (<font class="keywordtype">float</font>)m[10], (<font class="keywordtype">float</font>)m[11] ),
00253                          cpu_vec_xyzw( (<font class="keywordtype">float</font>)m[12], (<font class="keywordtype">float</font>)m[13], (<font class="keywordtype">float</font>)m[14], (<font class="keywordtype">float</font>)m[15] ) );
00254 
00255    <font class="comment">// close your eyes.. this is a temporary hack</font>
00256 
00257    <font class="comment">/*</font>
00258    // assume that newMatrix consists of rotations, uniform scales, and translations
00259    cpu_vec_xyzw scaledVec( 1, 0, 0, 0 );
00260    scaledVec = newMatrix * scaledVec;
00261    float scale = scaledVec.length();
00262 
00263    cpu_mat_44 invMatrix = newMatrix;
00264    invMatrix.set_col3( cpu_vec_xyzw(0,0,0,0) );
00265    invMatrix.transpose_in_place();
00266    invMatrix.set_col3( -newMatrix.get_col3() );
00267    cpu_mat_44 scaleMat;
00268    scaleMat.set_scale( cpu_vec_xyz(scale, scale, scale) );
00269    invMatrix = scaleMat * invMatrix;
00270    */
00271 
00272    cpu_mat_44 invMatrix;
00273 <font class="comment">//     invMatrix.set_identity();</font>
00274    <a class="code" href="matrix_8cpp.html#a4">Invert2</a>( (<font class="keywordtype">float</font>*)&amp;newMatrix, (<font class="keywordtype">float</font>*)&amp;invMatrix );
00275    <a class="code" href="classCMatrixStack.html">CMatrixStack</a>&amp; matStack = pGLContext-&gt;GetCurMatrixStack();
00276    matStack.<a class="code" href="classCMatrixStack.html#a3">Concat</a>( newMatrix, invMatrix );
00277 
00278 <font class="comment">//     mWarn( "glMultMatrix is not correct" );</font>
00279 
00280 }
00281 
<a name="l00282"></a><a class="code" href="matrix_8cpp.html#a763">00282</a> <font class="keywordtype">void</font> <a class="code" href="gl_8h.html#a763">glRotatef</a>( <a class="code" href="gl_8h.html#a698">GLfloat</a> angle,
00283                 <a class="code" href="gl_8h.html#a698">GLfloat</a> x, <a class="code" href="gl_8h.html#a698">GLfloat</a> y, <a class="code" href="gl_8h.html#a698">GLfloat</a> z )<font class="keyword"></font>
00284 {
00285    cpu_mat_44 xform, inverse;
00286    cpu_vec_xyz axis(x,y,z);
00287    axis.normalize();
00288    xform.set_rotate( Math::DegToRad(angle), axis );
00289    inverse.set_rotate( Math::DegToRad(-angle), axis );
00290 
00291    <a class="code" href="classCMatrixStack.html">CMatrixStack</a>&amp; matStack = pGLContext-&gt;GetCurMatrixStack();
00292    matStack.<a class="code" href="classCMatrixStack.html#a3">Concat</a>( xform, inverse );
00293 }
00294 
<a name="l00295"></a><a class="code" href="matrix_8cpp.html#a765">00295</a> <font class="keywordtype">void</font> <a class="code" href="gl_8h.html#a765">glScalef</a>( <a class="code" href="gl_8h.html#a698">GLfloat</a> x, <a class="code" href="gl_8h.html#a698">GLfloat</a> y, <a class="code" href="gl_8h.html#a698">GLfloat</a> z )<font class="keyword"></font>
00296 {
00297    cpu_mat_44 xform, inverse;
00298    xform.set_scale( cpu_vec_xyz(x,y,z) );
00299    inverse.set_scale( cpu_vec_xyz(1.0f/x, 1.0f/y, 1.0f/z) );
00300 
00301    <a class="code" href="classCMatrixStack.html">CMatrixStack</a>&amp; matStack = pGLContext-&gt;GetCurMatrixStack();
00302    matStack.<a class="code" href="classCMatrixStack.html#a3">Concat</a>( xform, inverse );
00303 }
00304 
<a name="l00305"></a><a class="code" href="matrix_8cpp.html#a767">00305</a> <font class="keywordtype">void</font> <a class="code" href="gl_8h.html#a767">glTranslatef</a>( <a class="code" href="gl_8h.html#a698">GLfloat</a> x, <a class="code" href="gl_8h.html#a698">GLfloat</a> y, <a class="code" href="gl_8h.html#a698">GLfloat</a> z )<font class="keyword"></font>
00306 {
00307    cpu_mat_44 xform, inverse;
00308    cpu_vec_xyz direction(x, y, z);
00309    xform.set_translate( direction );
00310    inverse.set_translate( -direction );
00311 
00312    <a class="code" href="classCMatrixStack.html">CMatrixStack</a>&amp; matStack = pGLContext-&gt;GetCurMatrixStack();
00313    matStack.<a class="code" href="classCMatrixStack.html#a3">Concat</a>( xform, inverse );
00314 }
</pre></div><hr><address><small>ps2gl version cvs</small></address>
