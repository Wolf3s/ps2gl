<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>indexed_renderer.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.11 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>indexed_renderer.cpp</h1><a href="indexed__renderer_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*        Copyright (C) 2000,2001,2002  Sony Computer Entertainment America</font>
00002           
00003           This file is subject to the terms and conditions of the GNU Lesser
00004           General Public License Version 2.1. See the file "COPYING" in the
00005           main directory of this archive for more details.                             */
00006 
00007 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00008 
00009 <font class="preprocessor">#include "ps2s/cpu_matrix.h"</font>
00010 <font class="preprocessor">#include "ps2s/math.h"</font>
00011 
00012 <font class="preprocessor">#include "<a class="code" href="indexed__renderer_8h.html">ps2gl/indexed_renderer.h</a>"</font>
00013 <font class="preprocessor">#include "<a class="code" href="glcontext_8h.html">ps2gl/glcontext.h</a>"</font>
00014 <font class="preprocessor">#include "<a class="code" href="material_8h.html">ps2gl/material.h</a>"</font>
00015 <font class="preprocessor">#include "<a class="code" href="texture_8h.html">ps2gl/texture.h</a>"</font>
00016 <font class="preprocessor">#include "<a class="code" href="lighting_8h.html">ps2gl/lighting.h</a>"</font>
00017 
00018 <font class="preprocessor">#include "vu1_mem_indexed.h"</font>
00019 
<a name="l00020"></a><a class="code" href="classCIndexedRenderer.html#a0">00020</a> <a class="code" href="classCIndexedRenderer.html#a0">CIndexedRenderer::CIndexedRenderer</a>( <font class="keywordtype">void</font> *packet, <a class="code" href="classCRendererProps.html">CRendererProps</a> caps, <a class="code" href="classCRendererProps.html">CRendererProps</a> reqs,
00021                                     <font class="keywordtype">int</font> inQuadsPerVert, <font class="keywordtype">int</font> outQuadsPerVert,
00022                                     <font class="keyword">const</font> <font class="keywordtype">char</font> *name)
00023    : <a class="code" href="classCBaseRenderer.html">CBaseRenderer</a>(packet, caps, reqs,
00024                    inQuadsPerVert, outQuadsPerVert, kInputGeomStart, name)
00025 {
00026    printf(<font class="stringliteral">"Max number of vertices in indexed array is %d\n"</font>, (kInputBufSize-4)/3 - 3 );
00027    printf(<font class="stringliteral">"giftag = 0x%04x, context length = 0x%04x (%d)\n"</font>,
00028           kGifTag, kContextLength, kContextLength);
00029 }
00030 
00031 <font class="keywordtype">void</font>
<a name="l00032"></a><a class="code" href="classCIndexedRenderer.html#a1">00032</a> <a class="code" href="classCIndexedRenderer.html#a1">CIndexedRenderer::InitContext</a>( <a class="code" href="gl_8h.html#a687">GLenum</a> primType, tU32 rcChanges, <font class="keywordtype">bool</font> userRcChanged )<font class="keyword"></font>
00033 {
00034    <a class="code" href="classCGLContext.html">CGLContext</a> &amp;glContext = *pGLContext;
00035    CVifSCDmaPacket &amp;packet = glContext.<a class="code" href="classCGLContext.html#a70">GetVif1Packet</a>();
00036 
00037    packet.Cnt();
00038    {
00039       <a class="code" href="classCBaseRenderer.html#b7">AddVu1RendererContext</a>( packet, primType, <a class="code" href="base__renderer_8cpp.html#a0">kContextStart</a> );
00040 
00041       packet.Mscal(0);
00042       packet.Flushe();
00043 
00044       packet.Base( kDoubleBufBase );
00045       packet.Offset( kDoubleBufOffset );
00046    }
00047    packet.CloseTag();
00048 
00049    <a class="code" href="classCBaseRenderer.html#b9">CacheRendererState</a>();
00050 
00051    <font class="comment">// more caching:  calculate and save the current constant vertex color</font>
00052 
00053    <a class="code" href="classCImmLighting.html">CImmLighting</a> &amp;lighting = glContext.<a class="code" href="classCGLContext.html#a7">GetImmLighting</a>();
00054    <font class="keywordtype">bool</font> doLighting = lighting.<a class="code" href="classCImmLighting.html#a4">GetLightingEnabled</a>();
00055 
00056    <font class="keywordtype">float</font> maxColorValue = <a class="code" href="classCBaseRenderer.html#b10">GetMaxColorValue</a>( XferTexCoords );
00057    cpu_vec_4 globalAmb;
00058    <font class="keywordflow">if</font> (doLighting) globalAmb = lighting.<a class="code" href="classCImmLighting.html#a6">GetGlobalAmbient</a>() * maxColorValue;
00059    <font class="keywordflow">else</font> globalAmb.set( 0, 0, 0, 0 );
00060    
00061    <a class="code" href="classCImmMaterial.html">CImmMaterial</a>&amp; material = glContext.<a class="code" href="classCGLContext.html#a12">GetMaterialManager</a>().<a class="code" href="classCMaterialManager.html#a2">GetImmMaterial</a>();
00062    cpu_vec_4 materialAmb = material.<a class="code" href="classCImmMaterial.html#a6">GetAmbient</a>();
00063 
00064    cpu_vec_4 materialEmm;
00065    <font class="keywordflow">if</font> ( doLighting )
00066       materialEmm = material.<a class="code" href="classCImmMaterial.html#a9">GetEmission</a>() * maxColorValue;
00067    <font class="keywordflow">else</font>
00068       materialEmm = glContext.<a class="code" href="classCGLContext.html#a12">GetMaterialManager</a>().<a class="code" href="classCMaterialManager.html#a4">GetCurColor</a>() * maxColorValue;
00069 
00070    ConstantVertColor = materialAmb * globalAmb + materialEmm;
00071 }
00072 
00073 <font class="keywordtype">int</font>
<a name="l00074"></a><a class="code" href="classCIndexedRenderer.html#a3">00074</a> <a class="code" href="classCIndexedRenderer.html#a3">CIndexedRenderer::GetPacketQwordSize</a>( <font class="keyword">const</font> <a class="code" href="classCGeometryBlock.html">CGeometryBlock</a> &amp;geometry )<font class="keyword"></font>
00075 {
00076    <font class="comment">// FIXME:  this is a pitiful hack for allocating enough memory</font>
00077    <font class="keywordflow">return</font> Math::Max(geometry.<a class="code" href="classCGeometryBlock.html#a39">GetTotalVertices</a>() / 70, 1) * 1000;
00078 }
00079 
00080 <a class="code" href="classCRendererProps.html">CRendererProps</a>
<a name="l00081"></a><a class="code" href="classCIndexedRenderer.html#a4">00081</a> <a class="code" href="classCIndexedRenderer.html#a4">CIndexedRenderer::GetRenderContextDeps</a>()<font class="keyword"></font>
00082 {
00083    <a class="code" href="classCRendererProps.html">CRendererProps</a> deps;
00084    deps = (tU64)0;
00085    deps.<a class="code" href="classCRendererProps.html#m1">Lighting</a> = 1;
00086    deps.<a class="code" href="classCRendererProps.html#m4">Texture</a> = 1;
00087    deps.<a class="code" href="classCRendererProps.html#m6">PerVtxMaterial</a> = 1;
00088    
00089    <font class="keywordflow">return</font> deps;
00090 }
00091 
00092 <font class="keywordtype">bool</font>
<a name="l00093"></a><a class="code" href="classCIndexedRenderer.html#a5">00093</a> <a class="code" href="classCIndexedRenderer.html#a5">CIndexedRenderer::GetCachePackets</a>( <font class="keyword">const</font> <a class="code" href="classCGeometryBlock.html">CGeometryBlock</a> &amp;geometry )<font class="keyword"></font>
00094 {
00095    <font class="keywordflow">return</font> !( pGLContext-&gt;GetImmLighting().GetLightingEnabled()
00096              &amp;&amp; ! geometry.<a class="code" href="classCGeometryBlock.html#a6">GetNormalsAreValid</a>() );
00097 }
00098 
00099 <font class="keywordtype">void</font>
<a name="l00100"></a><a class="code" href="classCIndexedRenderer.html#a2">00100</a> <a class="code" href="classCIndexedRenderer.html#a2">CIndexedRenderer::DrawIndexedArrays</a>( <a class="code" href="classCGeometryBlock.html">CGeometryBlock</a> &amp;block )<font class="keyword"></font>
00101 {
00102    <font class="comment">// TODO:</font>
00103    <font class="comment">//  - transfer strip lengths into temp area w's and set strip adc's</font>
00104    <font class="comment">//  - test with real data..</font>
00105 
00106    <font class="comment">// transfer the arrays</font>
00107 
00108    CVifSCDmaPacket &amp;packet = pGLContext-&gt;GetVif1Packet();
00109 
00110    <font class="keywordtype">int</font> wordsPerVert = block.<a class="code" href="classCGeometryBlock.html#a9">GetWordsPerVertex</a>();
00111    <font class="keywordtype">int</font> wordsPerNormal = (block.<a class="code" href="classCGeometryBlock.html#a6">GetNormalsAreValid</a>()) ? block.<a class="code" href="classCGeometryBlock.html#a10">GetWordsPerNormal</a>() : 0;
00112    <font class="keywordtype">int</font> wordsPerTex = (block.<a class="code" href="classCGeometryBlock.html#a7">GetTexCoordsAreValid</a>()) ? block.<a class="code" href="classCGeometryBlock.html#a11">GetWordsPerTexCoord</a>() : 0;
00113    <font class="keywordtype">int</font> wordsPerColor = (block.<a class="code" href="classCGeometryBlock.html#a8">GetColorsAreValid</a>()) ? block.<a class="code" href="classCGeometryBlock.html#a12">GetWordsPerColor</a>() : 0;
00114 
00115    <a class="code" href="classCBaseRenderer.html#b4">InitXferBlock</a>( packet, wordsPerVert, wordsPerNormal, wordsPerTex, wordsPerColor );
00116 
00117    <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> curArray = 0; curArray &lt; block.<a class="code" href="classCGeometryBlock.html#a53">GetNumArrays</a>(); curArray++ ) {
00118 
00119       <font class="keyword">const</font> <font class="keywordtype">void</font> *normals, *vertices, *texCoords, *colors;
00120       vertices = block.<a class="code" href="classCGeometryBlock.html#a5">GetVerticesAreValid</a>()    ? block.<a class="code" href="classCGeometryBlock.html#a23">GetVertices</a>(curArray) : NULL;
00121       normals = block.<a class="code" href="classCGeometryBlock.html#a6">GetNormalsAreValid</a>()      ? block.<a class="code" href="classCGeometryBlock.html#a24">GetNormals</a>(curArray) : NULL;
00122       texCoords = block.<a class="code" href="classCGeometryBlock.html#a7">GetTexCoordsAreValid</a>()  ? block.<a class="code" href="classCGeometryBlock.html#a25">GetTexCoords</a>(curArray) : NULL;
00123       colors = block.<a class="code" href="classCGeometryBlock.html#a8">GetColorsAreValid</a>()        ? block.<a class="code" href="classCGeometryBlock.html#a26">GetColors</a>(curArray) : NULL;
00124 
00125       packet.Cnt();
00126       packet.Stcycl(1,3).Nop();
00127       packet.CloseTag();
00128 
00129       <font class="keywordtype">int</font> numIndices = block.<a class="code" href="classCGeometryBlock.html#a55">GetNumIndices</a>(curArray);
00130       <font class="keyword">const</font> <font class="keywordtype">void</font> *indices = block.<a class="code" href="classCGeometryBlock.html#a27">GetIndices</a>(curArray);
00131       <font class="keywordtype">int</font> numVertices = block.<a class="code" href="classCGeometryBlock.html#a54">GetArrayLength</a>(curArray);
00132 
00133       <a class="code" href="classCBaseRenderer.html#b5">XferBlock</a>( packet,
00134                  vertices, normals, texCoords, colors,
00135                  kInputGeomStart,
00136                  0, numVertices );
00137 
00138       <font class="comment">// transfer the indices</font>
00139 
00140       packet.Cnt();
00141       {
00142          packet.Stmod( Vifs::AddModes::kOffset );
00143          <font class="comment">// don't write over the xyz's</font>
00144          Vifs::tMask mask = { 3, 3, 3, 0,
00145                               3, 3, 3, 0,
00146                               3, 3, 3, 0,
00147                               3, 3, 3, 0 };
00148          packet.Stmask( mask );
00149          <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">float</font> row[4] = { 1.0f, 1.0f, 1.0f, 1.0f };
00150          packet.Strow( row );
00151          packet.Pad128();
00152       }
00153       packet.CloseTag();
00154 
00155       <font class="keywordtype">int</font> numIndexQwords = numIndices/16 + (numIndices%16 &gt; 0);
00156       packet.Ref( Core::MakePtrNormal((<font class="keyword">const</font> <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>*)indices), numIndexQwords );
00157       {
00158          packet.Stcycl(1,1);
00159          packet.OpenUnpack( Vifs::UnpackModes::s_16, kInputGeomStart,
00160                             Packet::kDoubleBuff, Packet::kMasked );
00161          <font class="comment">// packet.CloseUnpack( numIndices/2 );</font>
00162          packet.CloseUnpack( numIndexQwords*8 );
00163       }
00164 
00165       <font class="comment">// transfer a buffer header &amp; start renderer</font>
00166 
00167       packet.Cnt();
00168       {
00169          <font class="comment">// buffer header</font>
00170 
00171          packet.Stmod( Vifs::AddModes::kNone );
00172          packet.OpenUnpack( Vifs::UnpackModes::v4_32, 0, Packet::kDoubleBuff );
00173          {
00174             packet += numVertices;
00175             packet += numIndices/2 + (numIndices &amp; 1);
00176             packet += numIndices;
00177             packet += 0;
00178          }
00179          packet.CloseUnpack();
00180 
00181       <font class="comment">// constant color of each vertex</font>
00182 
00183          packet.Strow( &amp;ConstantVertColor );
00184          packet.Stcycl(numVertices,0);
00185          Vifs::tMask mask = { 1, 1, 1, 3,
00186                               1, 1, 1, 3,
00187                               1, 1, 1, 3,
00188                               1, 1, 1, 3 };
00189          packet.Stmask( mask );
00190          packet.OpenUnpack( Vifs::UnpackModes::v4_32, kTempAreaStart,
00191                             Packet::kDoubleBuff, Packet::kMasked );
00192          packet.CloseUnpack(numVertices);
00193 
00194       <font class="comment">// start renderer</font>
00195 
00196          packet.Mscnt();
00197          packet.Pad128();
00198       }
00199       packet.CloseTag();
00200    }
00201 }
</pre></div><hr><address><small>ps2gl version cvs</small></address>
