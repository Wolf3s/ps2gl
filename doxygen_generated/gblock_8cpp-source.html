<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>gblock.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.11 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>gblock.cpp</h1><a href="gblock_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*        Copyright (C) 2000,2001,2002  Sony Computer Entertainment America</font>
00002           
00003           This file is subject to the terms and conditions of the GNU Lesser
00004           General Public License Version 2.1. See the file "COPYING" in the
00005           main directory of this archive for more details.                             */
00006 
00007 <font class="preprocessor">#include "<a class="code" href="gblock_8h.html">ps2gl/gblock.h</a>"</font>
00008 <font class="preprocessor">#include "<a class="code" href="gmanager_8h.html">ps2gl/gmanager.h</a>"</font>
00009 
00010 <font class="keyword">using</font> <font class="keyword">namespace </font>ArrayType;
00011 
00012 <font class="comment">/********************************************</font>
00013  * CGeometryBlock
00014  */
00015 
00016 <font class="keywordtype">bool</font>
00017 CGeometryBlock::SameDataFormat()<font class="keyword"></font>
00018 {
00019    <font class="keywordtype">bool</font> same = <font class="keyword">true</font>;
00020 
00021    <font class="keywordflow">if</font> ( AreVerticesValid != AreNewVerticesValid
00022         || AreNormalsValid != AreNewNormalsValid
00023         || AreTexCoordsValid != AreNewTexCoordsValid
00024         || AreColorsValid != AreNewColorsValid )
00025       same = <font class="keyword">false</font>;
00026    <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( AreNewVerticesValid &amp;&amp; WordsPerVertex != WordsPerNewVertex )
00027       same = <font class="keyword">false</font>;
00028    <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( AreNewNormalsValid &amp;&amp; WordsPerNormal != WordsPerNewNormal )
00029       same = <font class="keyword">false</font>;
00030    <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( AreNewTexCoordsValid &amp;&amp; WordsPerTexCoord != WordsPerNewTexCoord )
00031       same = <font class="keyword">false</font>;
00032    <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( AreNewColorsValid &amp;&amp; WordsPerColor != WordsPerNewColor )
00033       same = <font class="keyword">false</font>;
00034 
00035    <font class="keywordflow">return</font> same;
00036 }
00037 
00038 <font class="keywordtype">bool</font>
<a name="l00039"></a><a class="code" href="classCGeometryBlock.html#a60">00039</a> <a class="code" href="classCGeometryBlock.html#a60">CGeometryBlock::MergeNew</a>()<font class="keyword"></font>
00040 {
00041    mAssert( <a class="code" href="classCGeometryBlock.html#a59">IsPending</a>() );
00042    mErrorIf( NumNewVertices == 0, <font class="stringliteral">"Trying to merge geometry with no vertices!"</font> );
00043 
00044    <font class="keywordtype">bool</font> success = <font class="keyword">false</font>;
00045 
00046    <font class="keywordflow">if</font> ( NewArrayType == kLinear )
00047       success = MergeNewLinear();
00048    <font class="keywordflow">else</font>
00049       success = MergeNewIndexed();
00050 
00051    <font class="keywordflow">return</font> success;
00052 }
00053 
00054 <font class="keywordtype">bool</font>
00055 CGeometryBlock::MergeNewIndexed()<font class="keyword"></font>
00056 {
00057    <font class="keywordtype">bool</font> success = <font class="keyword">true</font>;
00058 
00059    <font class="keywordflow">if</font> ( NewPrimType != PrimType
00060         || NewArrayType != ArrayType
00061         || NumStrips == kMaxNumStrips )
00062       success = <font class="keyword">false</font>;
00063 
00064    <font class="keywordflow">if</font> ( success ) {
00065       Vertices[NumStrips] = NewVertices;
00066       Normals[NumStrips] = NewNormals;
00067       TexCoords[NumStrips] = NewTexCoords;
00068       Colors[NumStrips] = NewColors;
00069 
00070       StripLengths[NumStrips] = (<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>)NumNewVertices;
00071       IStripLengths[NumStrips] = NewIStripLengths;
00072       Indices[NumStrips] = NewIndices;
00073       NumIndices[NumStrips] = NumNewIndices;
00074 
00075       NumStrips++;
00076 
00077       <a class="code" href="classCGeometryBlock.html#a57">ResetNew</a>();
00078    }
00079 
00080    <font class="keywordflow">return</font> success;
00081 }
00082 
00083 <font class="keywordtype">bool</font>
00084 CGeometryBlock::MergeNewLinear()<font class="keyword"></font>
00085 {
00086    <font class="keywordtype">bool</font> success = <font class="keyword">true</font>;
00087 
00088    <font class="keywordflow">if</font> ( NewPrimType != PrimType
00089         || NewArrayType != ArrayType
00090         || ! SameDataFormat()
00091         || NumStrips == kMaxNumStrips
00092       )
00093       success = <font class="keyword">false</font>;
00094    <font class="keywordflow">else</font> {
00095       <font class="keywordtype">bool</font> merged = <font class="keyword">false</font>;
00096 
00097       TotalVertices += NumNewVertices;
00098 
00099       <font class="comment">// if the new and old vertices, normals, tex, .. whatever</font>
00100       <font class="comment">// are all contiguous in memory they can be combined into the same list of</font>
00101       <font class="comment">// primitives</font>
00102 
00103       <font class="keywordtype">int</font> stripLength = <a class="code" href="classCGeometryBlock.html#a51">GetStripLength</a>(NumStrips-1);
00104       <font class="keywordflow">if</font> ( (<font class="keywordtype">float</font>*)Vertices[NumStrips-1] + WordsPerVertex*stripLength
00105            == (<font class="keywordtype">float</font>*)NewVertices
00106            &amp;&amp; ( ! AreNormalsValid
00107                 || (<font class="keywordtype">float</font>*)Normals[NumStrips-1] + WordsPerNormal*stripLength
00108                 == (<font class="keywordtype">float</font>*)NewNormals )
00109            &amp;&amp; ( ! AreTexCoordsValid
00110                 || (<font class="keywordtype">float</font>*)TexCoords[NumStrips-1] + WordsPerTexCoord*stripLength
00111                 == (<font class="keywordtype">float</font>*)NewTexCoords )
00112            &amp;&amp; ( ! AreColorsValid
00113                 || (<font class="keywordtype">float</font>*)Colors[NumStrips-1] + WordsPerColor*stripLength
00114                 == (<font class="keywordtype">float</font>*)NewColors )
00115          )
00116       {
00117          <font class="comment">// is this a user-defined prim type?</font>
00118          <font class="keywordtype">bool</font> mergeUser = <font class="keyword">true</font>;
00119          <font class="keywordflow">if</font> ( <a class="code" href="classCGeomManager.html#d0">CGeomManager::IsUserPrimType</a>(PrimType) )
00120             mergeUser = <a class="code" href="classCGeomManager.html#d3">CGeomManager::GetUserPrimMerge</a>(PrimType);
00121 
00122          <font class="comment">// strips can't really be merged because they have to be broken</font>
00123          <font class="comment">// at their boundaries in vu1 by setting adc bits</font>
00124          <font class="keywordflow">if</font> ( PrimType != <a class="code" href="gl_8h.html#a16">GL_LINE_STRIP</a>
00125               &amp;&amp; PrimType != <a class="code" href="gl_8h.html#a18">GL_TRIANGLE_STRIP</a>
00126               &amp;&amp; PrimType != <a class="code" href="gl_8h.html#a19">GL_TRIANGLE_FAN</a>
00127               &amp;&amp; PrimType != <a class="code" href="gl_8h.html#a21">GL_QUAD_STRIP</a>
00128               &amp;&amp; mergeUser ) {
00129             merged = <font class="keyword">true</font>;
00130             StripLengths[NumStrips-1] += (<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>)NumNewVertices;
00131          }
00132          <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( PrimType != <a class="code" href="gl_8h.html#a19">GL_TRIANGLE_FAN</a> ) {
00133             StripLengths[NumStrips-1] |= kContinueFlag;
00134          }
00135       }
00136 
00137       <font class="keywordflow">if</font> ( ! merged ) {
00138          <font class="comment">// can't be combined with previous list</font>
00139          Vertices[NumStrips] = NewVertices;
00140          Normals[NumStrips] = NewNormals;
00141          TexCoords[NumStrips] = NewTexCoords;
00142          Colors[NumStrips] = NewColors;
00143 
00144          StripLengths[NumStrips] = (<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>)NumNewVertices;
00145       }
00146 
00147       <font class="keywordflow">if</font> ( ! merged )
00148          NumStrips++;
00149 
00150       <a class="code" href="classCGeometryBlock.html#a57">ResetNew</a>();
00151    }
00152 
00153    <font class="keywordflow">return</font> success;
00154 }
00155 
00156 <font class="keywordtype">void</font>
<a name="l00157"></a><a class="code" href="classCGeometryBlock.html#a61">00157</a> <a class="code" href="classCGeometryBlock.html#a61">CGeometryBlock::MakeNewValuesCurrent</a>()<font class="keyword"></font>
00158 {
00159    CommitPrimType();
00160    ArrayType = NewArrayType;
00161 
00162    NumStrips = 0;
00163 
00164    Vertices[NumStrips] = NewVertices;
00165    Normals[NumStrips] = NewNormals;
00166    TexCoords[NumStrips] = NewTexCoords;
00167    Colors[NumStrips] = NewColors;
00168    IStripLengths[NumStrips] = NewIStripLengths;
00169    Indices[NumStrips] = NewIndices;
00170    NumIndices[NumStrips] = NumNewIndices;
00171 
00172    TotalVertices = NumNewVertices;
00173    StripLengths[NumStrips] = (<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>)NumNewVertices;
00174 
00175    WordsPerVertex = WordsPerNewVertex;
00176    WordsPerNormal = WordsPerNewNormal;
00177    WordsPerTexCoord = WordsPerNewTexCoord;
00178    WordsPerColor = WordsPerNewColor;
00179 
00180    AreVerticesValid = AreNewVerticesValid;
00181    AreNormalsValid = AreNewNormalsValid;
00182    AreTexCoordsValid = AreNewTexCoordsValid;
00183    AreColorsValid = AreNewColorsValid;
00184 
00185    NumStrips = 1;
00186 }
00187 
00188 <font class="keywordtype">void</font>
<a name="l00189"></a><a class="code" href="classCGeometryBlock.html#a57">00189</a> <a class="code" href="classCGeometryBlock.html#a57">CGeometryBlock::ResetNew</a>()<font class="keyword"></font>
00190 {
00191    NewPrimType = <a class="code" href="gl_8h.html#a513">GL_INVALID_VALUE</a>;
00192    NewArrayType = <a class="code" href="namespaceArrayType.html#a3a2">kInvalidArray</a>;
00193    NumNewVertices = NumNewNormals = NumNewTexCoords = NumNewColors = 0;
00194 
00195    NewVertices = NewNormals = NewTexCoords = NewColors = NULL;
00196    NewIndices = NewIStripLengths = NULL;
00197    NumNewIndices = 0;
00198    WordsPerNewVertex = WordsPerNewNormal = WordsPerNewTexCoord = WordsPerNewColor = 0;
00199    AreNewVerticesValid = AreNewNormalsValid = AreNewTexCoordsValid = AreNewColorsValid = <font class="keyword">false</font>;
00200 }
00201 
00202 <font class="keywordtype">void</font>
<a name="l00203"></a><a class="code" href="classCGeometryBlock.html#a56">00203</a> <a class="code" href="classCGeometryBlock.html#a56">CGeometryBlock::ResetCurStrip</a>()<font class="keyword"></font>
00204 {
00205    Vertices[NumStrips] = Normals[NumStrips] = NULL;
00206    TexCoords[NumStrips] = Colors[NumStrips] = NULL;
00207    StripLengths[NumStrips] = 0;
00208    Indices[NumStrips] = 0;
00209    IStripLengths[NumStrips] = 0;
00210    NumIndices[NumStrips] = 0;
00211 }
00212 
00213 <font class="keywordtype">void</font>
<a name="l00214"></a><a class="code" href="classCGeometryBlock.html#a58">00214</a> <a class="code" href="classCGeometryBlock.html#a58">CGeometryBlock::Reset</a>()<font class="keyword"></font>
00215 {
00216    TotalVertices = 0;
00217    WordsPerVertex = WordsPerNormal = WordsPerTexCoord = WordsPerColor = 0;
00218    AreVerticesValid = AreNormalsValid = AreTexCoordsValid = AreColorsValid = <font class="keyword">false</font>;
00219    PrimType = <a class="code" href="gl_8h.html#a513">GL_INVALID_VALUE</a>;
00220    NumVertsPerPrim = NumVertsToRestartStrip = -1;
00221    NumStrips = 0;
00222    <a class="code" href="classCGeometryBlock.html#a56">ResetCurStrip</a>();
00223    <a class="code" href="classCGeometryBlock.html#a57">ResetNew</a>();
00224 }
00225 
00226 <font class="keywordtype">void</font>
00227 CGeometryBlock::CommitPrimType()<font class="keyword"></font>
00228 {
00229    <font class="keywordflow">if</font> ( PrimType != NewPrimType ) {
00230       <font class="keywordflow">if</font> ( ! <a class="code" href="classCGeomManager.html#d0">CGeomManager::IsUserPrimType</a>(NewPrimType) )<font class="keyword"> </font>{
00231          <font class="keywordflow">switch</font> (NewPrimType) {
00232             <font class="keywordflow">case</font> <a class="code" href="gl_8h.html#a14">GL_POINTS</a>:
00233                NumVertsPerPrim = 1;
00234                NumVertsToRestartStrip = 0;
00235                <font class="keywordflow">break</font>;
00236             <font class="keywordflow">case</font> <a class="code" href="gl_8h.html#a16">GL_LINE_STRIP</a>:
00237                NumVertsPerPrim = 1;
00238                NumVertsToRestartStrip = 1;
00239                <font class="keywordflow">break</font>;
00240             <font class="keywordflow">case</font> <a class="code" href="gl_8h.html#a18">GL_TRIANGLE_STRIP</a>:
00241             <font class="keywordflow">case</font> <a class="code" href="gl_8h.html#a19">GL_TRIANGLE_FAN</a>:
00242             <font class="keywordflow">case</font> <a class="code" href="gl_8h.html#a21">GL_QUAD_STRIP</a>:
00243             <font class="keywordflow">case</font> <a class="code" href="gl_8h.html#a22">GL_POLYGON</a>:
00244                <font class="comment">// the number of verts per prim is used to determine where</font>
00245                <font class="comment">// (or where not) to break a list of primitives (in DrawArrays).</font>
00246                <font class="comment">// Let's pretend the triangle strips have 2 verts per primitive</font>
00247                <font class="comment">// so that they will only be broken on even vertex boundaries</font>
00248                <font class="comment">// because otherwise the face culling test gets out of sync...</font>
00249                NumVertsPerPrim = 2;
00250                NumVertsToRestartStrip = 2;
00251                <font class="keywordflow">break</font>;
00252             <font class="keywordflow">case</font> <a class="code" href="gl_8h.html#a15">GL_LINES</a>:
00253                NumVertsPerPrim = 2;
00254                NumVertsToRestartStrip = 0;
00255                <font class="keywordflow">break</font>;
00256             <font class="keywordflow">case</font> <a class="code" href="gl_8h.html#a17">GL_TRIANGLES</a>:
00257                NumVertsPerPrim = 3;
00258                NumVertsToRestartStrip = 0;
00259                <font class="keywordflow">break</font>;
00260             <font class="keywordflow">case</font> <a class="code" href="gl_8h.html#a20">GL_QUADS</a>:
00261                NumVertsPerPrim = 4;
00262                NumVertsToRestartStrip = 0;
00263                <font class="keywordflow">break</font>;
00264             <font class="keywordflow">default</font>:
00265                mError( <font class="stringliteral">"Unknown prim type: 0x%08x"</font>, NewPrimType );
00266          }
00267 
00268          <font class="keywordflow">if</font> (NewPrimType == <a class="code" href="gl_8h.html#a19">GL_TRIANGLE_FAN</a>)
00269             StripsCanBeMerged = <font class="keyword">false</font>;
00270          <font class="keywordflow">else</font>
00271             StripsCanBeMerged = <font class="keyword">true</font>;
00272       }
00273 
00274       PrimType = NewPrimType;
00275    }
00276 }
00277 
</pre></div><hr><address><small>ps2gl version cvs</small></address>
