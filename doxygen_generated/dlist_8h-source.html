<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>dlist.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.11 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>dlist.h</h1><a href="dlist_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*        Copyright (C) 2000,2001,2002  Sony Computer Entertainment America</font>
00002           
00003           This file is subject to the terms and conditions of the GNU Lesser
00004           General Public License Version 2.1. See the file "COPYING" in the
00005           main directory of this archive for more details.                             */
00006 
00007 <font class="preprocessor">#ifndef ps2gl_dlist_h</font>
00008 <font class="preprocessor">#define ps2gl_dlist_h</font>
00009 
00010 <font class="preprocessor">#include &lt;string.h&gt;</font>
00011 
00012 <font class="preprocessor">#include "<a class="code" href="gl_8h.html">GL/gl.h</a>"</font>
00013 <font class="preprocessor">#include "ps2s/packet.h"</font>
00014 <font class="preprocessor">#include "<a class="code" href="debug_8h.html">ps2gl/debug.h</a>"</font>
00015 
00016 <font class="comment">/********************************************</font>
00017  * display list commands
00018  */
00019 
<a name="l00020"></a><a class="code" href="classCDListCmd.html">00020</a> <font class="keyword">class </font><a class="code" href="classCDListCmd.html">CDListCmd</a> {
00021    <font class="keyword">public</font>:
<a name="l00022"></a><a class="code" href="classCDListCmd.html#a0">00022</a>       <a class="code" href="classCDListCmd.html#a0">CDListCmd</a>()<font class="keyword"> </font>{}
00023       <font class="keyword">virtual</font> <a class="code" href="classCDListCmd.html">CDListCmd</a>* <a class="code" href="classCDListCmd.html#a1">Play</a>() = 0;
00024 
00025       template &lt;class CmdType&gt;
<a name="l00026"></a><a class="code" href="classCDListCmd.html#d0">00026</a>       <font class="keyword">static</font> <font class="keyword">inline</font> <font class="keywordtype">int</font> <a class="code" href="classCDListCmd.html#d0">SizeOf</a>()<font class="keyword"> </font>{
00027          <font class="comment">// SEE FUNCTION below if you change anything here..</font>
00028          <font class="keywordtype">int</font> size = <font class="keyword">sizeof</font>(CmdType);
00029          <font class="comment">// round up to nearest quad.. this is temporary so that I</font>
00030          <font class="comment">// can use the vector classes for a while</font>
00031          <font class="keywordflow">if</font> ( size &amp; 0xf )
00032             size = (size &amp; ~0xf) + 16;
00033          <font class="keywordflow">return</font> size;
00034       }
00035 
00036       template &lt;class CmdType&gt;
<a name="l00037"></a><a class="code" href="classCDListCmd.html#d1">00037</a>       <font class="keyword">static</font> <a class="code" href="classCDListCmd.html">CDListCmd</a>* <a class="code" href="classCDListCmd.html#d1">GetNextCmd</a>( CmdType *cmd )<font class="keyword"> </font>{
00038          <font class="comment">// for some reason gcc doesn't find the above method when called</font>
00039          <font class="comment">// from here... go figure.</font>
00040          <font class="keywordtype">int</font> size = <font class="keyword">sizeof</font>(CmdType);
00041          <font class="comment">// round up to nearest quad.. this is temporary so that I</font>
00042          <font class="comment">// can use the vector classes for a while</font>
00043          <font class="keywordflow">if</font> ( size &amp; 0xf )
00044             size = (size &amp; ~0xf) + 16;
00045 
00046          <font class="keywordflow">return</font> reinterpret_cast&lt;CDListCmd*&gt;((<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>)cmd + size);
00047       }
00048 };
00049 
<a name="l00050"></a><a class="code" href="classCEmptyListCmd.html">00050</a> <font class="keyword">class </font><a class="code" href="classCEmptyListCmd.html">CEmptyListCmd</a> : <font class="keyword">public</font> <a class="code" href="classCDListCmd.html">CDListCmd</a> {
00051    <font class="keyword">public</font>:
<a name="l00052"></a><a class="code" href="classCEmptyListCmd.html#a0">00052</a>       <a class="code" href="classCDListCmd.html">CDListCmd</a>* <a class="code" href="classCDListCmd.html#a1">Play</a>()<font class="keyword"> </font>{ mError(<font class="stringliteral">"Trying to play an empty list!"</font>); <font class="keywordflow">return</font> NULL; }
00053 };
00054 
<a name="l00055"></a><a class="code" href="classCEndListCmd.html">00055</a> <font class="keyword">class </font><a class="code" href="classCEndListCmd.html">CEndListCmd</a> : <font class="keyword">public</font> <a class="code" href="classCDListCmd.html">CDListCmd</a> {
00056    <font class="keyword">public</font>:
<a name="l00057"></a><a class="code" href="classCEndListCmd.html#a0">00057</a>       <a class="code" href="classCDListCmd.html">CDListCmd</a>* <a class="code" href="classCDListCmd.html#a1">Play</a>()<font class="keyword"> </font>{ <font class="keywordflow">return</font> NULL; }
00058 };
00059 
00060 <font class="keyword">class </font><a class="code" href="classCDListCmdBlock.html">CDListCmdBlock</a>;
<a name="l00061"></a><a class="code" href="classCNextBlockCmd.html">00061</a> <font class="keyword">class </font><a class="code" href="classCNextBlockCmd.html">CNextBlockCmd</a> : <font class="keyword">public</font> <a class="code" href="classCDListCmd.html">CDListCmd</a> {
00062       <a class="code" href="classCDListCmdBlock.html">CDListCmdBlock</a>    *NextBlock;
00063    <font class="keyword">public</font>:
<a name="l00064"></a><a class="code" href="classCNextBlockCmd.html#a0">00064</a>       <a class="code" href="classCNextBlockCmd.html#a0">CNextBlockCmd</a>( <a class="code" href="classCDListCmdBlock.html">CDListCmdBlock</a>* nextBlock ) : NextBlock(nextBlock) {}
00065       <a class="code" href="classCDListCmd.html">CDListCmd</a>* <a class="code" href="classCDListCmd.html#a1">Play</a>(); <font class="comment">// defined after CDListCmdBlock</font>
00066 };
00067 
<a name="l00068"></a><a class="code" href="classCEnableCmd.html">00068</a> <font class="keyword">class </font><a class="code" href="classCEnableCmd.html">CEnableCmd</a> : <font class="keyword">public</font> <a class="code" href="classCDListCmd.html">CDListCmd</a> {
00069       <a class="code" href="gl_8h.html#a687">GLenum</a>            Property;
00070    <font class="keyword">public</font>:
<a name="l00071"></a><a class="code" href="classCEnableCmd.html#a0">00071</a>       <a class="code" href="classCEnableCmd.html#a0">CEnableCmd</a>( <a class="code" href="gl_8h.html#a687">GLenum</a> prop ) : Property(prop) {}
<a name="l00072"></a><a class="code" href="classCEnableCmd.html#a1">00072</a>       <a class="code" href="classCDListCmd.html">CDListCmd</a>* <a class="code" href="classCDListCmd.html#a1">Play</a>()<font class="keyword"> </font>{ <a class="code" href="gl_8h.html#a726">glEnable</a>( Property ); <font class="keywordflow">return</font> <a class="code" href="classCDListCmd.html#d1">CDListCmd::GetNextCmd</a>(<font class="keyword">this</font>); }
00073 };
00074 
00075 <font class="comment">/********************************************</font>
00076  * CDListCmdBlock
00077  */
00078 
<a name="l00079"></a><a class="code" href="classCDListCmdBlock.html">00079</a> <font class="keyword">class </font><a class="code" href="classCDListCmdBlock.html">CDListCmdBlock</a> {
00080       <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">int</font>  ByteSize = 2048;
00081       <font class="keywordtype">char</font>              Memory[ByteSize];
00082       <font class="keywordtype">char</font>              *MemCursor;
00083       <font class="keywordtype">int</font>               BytesLeft;
00084       <a class="code" href="classCDListCmdBlock.html">CDListCmdBlock</a>    *NextBlock;
00085 
00086    <font class="keyword">public</font>:
<a name="l00087"></a><a class="code" href="classCDListCmdBlock.html#a0">00087</a>       <a class="code" href="classCDListCmdBlock.html#a0">CDListCmdBlock</a>()
00088          : MemCursor(Memory), BytesLeft(ByteSize), NextBlock(NULL) {
00089          <a class="code" href="classCEmptyListCmd.html">CEmptyListCmd</a> empty;
00090          memcpy( MemCursor, &amp;empty, CDListCmd::SizeOf&lt;CEmptyListCmd&gt;() );
00091       }
<a name="l00092"></a><a class="code" href="classCDListCmdBlock.html#a1">00092</a>       <a class="code" href="classCDListCmdBlock.html#a1">~CDListCmdBlock</a>()<font class="keyword"> </font>{ <font class="keywordflow">if</font> (NextBlock) <font class="keyword">delete</font> NextBlock; }
00093 
00094       template &lt;class CmdType&gt;
<a name="l00095"></a><a class="code" href="classCDListCmdBlock.html#a2">00095</a>       <font class="keywordtype">bool</font> <a class="code" href="classCDListCmdBlock.html#a2">CanFit</a>( CmdType cmd )<font class="keyword"> </font>{
00096          <font class="keywordflow">return</font> ( CDListCmd::SizeOf&lt;CmdType&gt;()
00097                   &lt;= BytesLeft - CDListCmd::SizeOf&lt;CNextBlockCmd&gt;() );
00098       }
00099 
00100       template &lt;class CmdType&gt;
<a name="l00101"></a><a class="code" href="classCDListCmdBlock.html#a3">00101</a>       <font class="keywordtype">void</font> <a class="code" href="classCDListCmdBlock.html#a3">operator += </a>( CmdType cmd )<font class="keyword"> </font>{
00102          memcpy( MemCursor, &amp;cmd, <font class="keyword">sizeof</font>(CmdType) ); <font class="comment">// this should be the usual sizeof()</font>
00103          MemCursor += CDListCmd::SizeOf&lt;CmdType&gt;();
00104          BytesLeft -= CDListCmd::SizeOf&lt;CmdType&gt;();
00105       }
00106 
<a name="l00107"></a><a class="code" href="classCDListCmdBlock.html#a4">00107</a>       <a class="code" href="classCDListCmd.html">CDListCmd</a>* <a class="code" href="classCDListCmdBlock.html#a4">GetFirstCmd</a>()<font class="keyword"> </font>{ <font class="keywordflow">return</font> reinterpret_cast&lt;CDListCmd*&gt;(&amp;Memory[0]); }
00108 
<a name="l00109"></a><a class="code" href="classCDListCmdBlock.html#a5">00109</a>       <font class="keywordtype">void</font> <a class="code" href="classCDListCmdBlock.html#a5">SetNextBlock</a>( <a class="code" href="classCDListCmdBlock.html">CDListCmdBlock</a> *next )<font class="keyword"> </font>{ NextBlock = next; }
<a name="l00110"></a><a class="code" href="classCDListCmdBlock.html#a6">00110</a>       <a class="code" href="classCDListCmdBlock.html">CDListCmdBlock</a>* <a class="code" href="classCDListCmdBlock.html#a6">GetNextBlock</a>()<font class="keyword"> const </font>{ <font class="keywordflow">return</font> NextBlock; }
00111 };
00112 
00113 <font class="keyword">inline</font> <a class="code" href="classCDListCmd.html">CDListCmd</a>*
<a name="l00114"></a><a class="code" href="classCNextBlockCmd.html#a1">00114</a> <a class="code" href="classCDListCmd.html#a1">CNextBlockCmd::Play</a>()<font class="keyword"> </font>{
00115    <font class="keywordflow">return</font> NextBlock-&gt;<a class="code" href="classCDListCmdBlock.html#a4">GetFirstCmd</a>();
00116 }
00117 
00118 <font class="comment">/********************************************</font>
00119  * CDList
00120  */
00121 
<a name="l00122"></a><a class="code" href="classCDList.html">00122</a> <font class="keyword">class </font><a class="code" href="classCDList.html">CDList</a> {
00123       <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">int</font>  kBufferMaxQwordLength = 16*1024; <font class="comment">// 256kb</font>
00124       CDmaPacket        *VertexBuf, *NormalBuf, *TexCoordBuf, *ColorBuf;
00125       <a class="code" href="classCDListCmdBlock.html">CDListCmdBlock</a>    *FirstCmdBlock, *CurCmdBlock;
00126       <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">int</font>  kMaxNumRenderPackets = 512;
00127       <font class="keywordtype">int</font>               NumRenderPackets;
00128       CVifSCDmaPacket   *RenderPackets[kMaxNumRenderPackets];
00129 
00130    <font class="keyword">public</font>:
00131       <a class="code" href="classCDList.html#a0">CDList</a>();
00132       <a class="code" href="classCDList.html#a1">~CDList</a>();
00133 
00134       <font class="comment">// utility</font>
00135       template &lt;class CmdType&gt;
<a name="l00136"></a><a class="code" href="classCDList.html#a2">00136</a>       <a class="code" href="classCDListCmd.html">CDListCmd</a>* <a class="code" href="classCDList.html#a2">GetNext</a>( CmdType* cmd )<font class="keyword"> </font>{
00137          <font class="keywordflow">return</font> 0;
00138       }
00139 
00140       template &lt;class CmdType&gt;
<a name="l00141"></a><a class="code" href="classCDList.html#a3">00141</a>       <font class="keywordtype">void</font> <a class="code" href="classCDList.html#a3">operator += </a>( CmdType cmd )<font class="keyword"> </font>{
00142          <font class="keywordflow">if</font> ( ! CurCmdBlock-&gt;<a class="code" href="classCDListCmdBlock.html#a2">CanFit</a>(cmd) ) {
00143             <font class="comment">// not enough space left in current cmd block, so terminate it</font>
00144             <font class="comment">// and start a new one..</font>
00145             <a class="code" href="classCDListCmdBlock.html">CDListCmdBlock</a> *newBlock = <font class="keyword">new</font> <a class="code" href="classCDListCmdBlock.html">CDListCmdBlock</a>;
00146             CurCmdBlock-&gt;<a class="code" href="classCDListCmdBlock.html#a5">SetNextBlock</a>( newBlock );
00147             *CurCmdBlock += CNextBlockCmd(newBlock);
00148             CurCmdBlock = newBlock;
00149          }
00150          *CurCmdBlock += cmd;
00151       }
00152 
<a name="l00153"></a><a class="code" href="classCDList.html#a4">00153</a>       <font class="keywordtype">void</font> <a class="code" href="classCDListCmd.html#a1">Play</a>()<font class="keyword"> </font>{
00154          <a class="code" href="classCDListCmd.html">CDListCmd</a>* nextCmd = FirstCmdBlock-&gt;<a class="code" href="classCDListCmdBlock.html#a4">GetFirstCmd</a>();
00155          <font class="keywordflow">while</font> ( nextCmd ) nextCmd = nextCmd-&gt;<a class="code" href="classCDListCmd.html#a1">Play</a>();
00156       }
00157 
00158       <font class="keywordtype">void</font> <a class="code" href="classCDList.html#a5">Begin</a>();
<a name="l00159"></a><a class="code" href="classCDList.html#a6">00159</a>       <font class="keywordtype">void</font> <a class="code" href="classCDList.html#a6">End</a>()<font class="keyword"> </font>{ <a class="code" href="classCEndListCmd.html">CEndListCmd</a> endList; *<font class="keyword">this</font> += endList; }
00160 
00161       CDmaPacket&amp; <a class="code" href="classCDList.html#a7">GetVertexBuf</a>();
00162       CDmaPacket&amp; <a class="code" href="classCDList.html#a8">GetNormalBuf</a>();
00163       CDmaPacket&amp; <a class="code" href="classCDList.html#a9">GetTexCoordBuf</a>();
00164       CDmaPacket&amp; <a class="code" href="classCDList.html#a10">GetColorBuf</a>();
00165 
<a name="l00166"></a><a class="code" href="classCDList.html#a11">00166</a>       <font class="keywordtype">void</font> <a class="code" href="classCDList.html#a11">RegisterNewPacket</a>( CVifSCDmaPacket *packet )<font class="keyword"> </font>{
00167          RenderPackets[NumRenderPackets++] = packet;
00168       }
00169 };
00170 
00171 <font class="comment">/********************************************</font>
00172  * CDListManager
00173  */
00174 
<a name="l00175"></a><a class="code" href="classCDListManager.html">00175</a> <font class="keyword">class </font><a class="code" href="classCDListManager.html">CDListManager</a> {
00176       <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">int</font>  kMaxListID = 4096;
00177       <font class="keywordtype">int</font>               NextFreeListID;
00178       <a class="code" href="classCDList.html">CDList</a>            *Lists[kMaxListID];
00179       <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font>      OpenListID;
00180       <a class="code" href="classCDList.html">CDList</a>            *OpenList;
00181 
00182       <font class="keywordtype">bool</font> ListsAreFree( <font class="keywordtype">int</font> firstListID, <font class="keywordtype">int</font> numLists );
00183 
00184       <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">int</font>  kMaxBuffersToBeFreed = 1024;
00185       <a class="code" href="classCDList.html">CDList</a>*           ListsToBeFreed[2][kMaxBuffersToBeFreed];
00186       <font class="keywordtype">int</font>               NumListsToBeFreed[2];
00187       <font class="keywordtype">int</font>               CurBuffer;
00188 
00189       <font class="keyword">inline</font> <font class="keywordtype">void</font> AddListToBeFreed( <a class="code" href="classCDList.html">CDList</a> *dlist )<font class="keyword"> </font>{
00190          mAssert( NumListsToBeFreed[CurBuffer] &lt; kMaxBuffersToBeFreed );
00191          ListsToBeFreed[CurBuffer][NumListsToBeFreed[CurBuffer]++] = dlist;
00192       }
00193 
00194    <font class="keyword">public</font>:
<a name="l00195"></a><a class="code" href="classCDListManager.html#a0">00195</a>       <a class="code" href="classCDListManager.html#a0">CDListManager</a>()
00196          : NextFreeListID(1), OpenListID(0), OpenList(NULL), CurBuffer(0)
00197       {
00198          <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; kMaxListID; i++ )
00199             Lists[i] = NULL;
00200          NumListsToBeFreed[0] = NumListsToBeFreed[1] = 0;
00201       }
<a name="l00202"></a><a class="code" href="classCDListManager.html#a1">00202</a>       <a class="code" href="classCDListManager.html#a1">~CDListManager</a>()<font class="keyword"> </font>{
00203          <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> i = 0; i &lt; 10; i++ )
00204             <font class="keywordflow">if</font> ( Lists[i] ) <font class="keyword">delete</font> Lists[i];
00205       }
00206 
00207       <font class="keywordtype">void</font> <a class="code" href="classCDListManager.html#a2">SwapBuffers</a>();
00208 
00209       <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> <a class="code" href="classCDListManager.html#a3">GenLists</a>( <font class="keywordtype">int</font> numLists );
00210       <font class="keywordtype">void</font> <a class="code" href="classCDListManager.html#a4">DeleteLists</a>( <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> firstListID, <font class="keywordtype">int</font> numLists );
00211       <font class="keywordtype">void</font> <a class="code" href="classCDListManager.html#a5">NewList</a>( <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> listID, <a class="code" href="gl_8h.html#a687">GLenum</a> mode );
00212       <font class="keywordtype">void</font> <a class="code" href="classCDListManager.html#a6">EndList</a>();
00213       <font class="keywordtype">void</font> <a class="code" href="classCDListManager.html#a7">CallList</a>( <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> listID );
00214 
<a name="l00215"></a><a class="code" href="classCDListManager.html#a8">00215</a>       <a class="code" href="classCDList.html">CDList</a>&amp; <a class="code" href="classCDListManager.html#a8">GetOpenDList</a>()<font class="keyword"> const </font>{ <font class="keywordflow">return</font> *OpenList; }
00216 };
00217 
00218 <font class="preprocessor">#endif // ps2gl_dlist_h</font>
</pre></div><hr><address><small>ps2gl version cvs</small></address>
